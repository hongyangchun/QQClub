<!--pages/event/statistics.wxml-->
<view class="container page-container">
  <!-- æ´»åŠ¨å¤´éƒ¨ -->
  <view class="stats-header" wx:if="{{eventInfo}}">
    <view class="header-background"></view>
    <view class="header-content">
      <view class="event-title">{{eventInfo.title}}</view>
      <view class="event-subtitle">{{eventInfo.book_name}} Â· ç»Ÿè®¡æ•°æ®</view>
      <view class="status-badge status-{{eventInfo.status}}">
        <text class="status-icon">{{eventInfo.status_icon}}</text>
        <text class="status-text">{{eventInfo.status_text}}</text>
      </view>
    </view>
  </view>

  <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
  <view class="stats-overview" wx:if="{{overviewStats}}">
    <view class="overview-title">
      <text class="title-icon">ğŸ“Š</text>
      <text class="title-text">æ•°æ®æ¦‚è§ˆ</text>
    </view>
    <view class="overview-grid">
      <view class="stat-card primary">
        <text class="stat-number">{{overviewStats.total_checkins}}</text>
        <text class="stat-label">æ€»æ‰“å¡æ•°</text>
        <view class="stat-trend {{overviewStats.checkins_trend >= 0 ? 'up' : 'down'}}">
          <text class="trend-icon">{{overviewStats.checkins_trend >= 0 ? 'â†‘' : 'â†“'}}</text>
          <text class="trend-value">{{overviewStats.checkins_trend_abs}}%</text>
        </view>
      </view>
      <view class="stat-card success">
        <text class="stat-number">{{overviewStats.active_participants}}</text>
        <text class="stat-label">æ´»è·ƒå‚ä¸</text>
        <view class="stat-percentage">{{overviewStats.active_rate}}%</view>
      </view>
      <view class="stat-card warning">
        <text class="stat-number">{{overviewStats.avg_completion}}</text>
        <text class="stat-label">å¹³å‡å®Œæˆç‡</text>
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{overviewStats.avg_completion}}%"></view>
        </view>
      </view>
      <view class="stat-card info">
        <text class="stat-number">{{overviewStats.total_flowers}}</text>
        <text class="stat-label">å°çº¢èŠ±</text>
        <view class="stat-desc">äº’åŠ¨æ”¯æŒ</view>
      </view>
    </view>
  </view>

  <!-- ä¸ªäººè¿›åº¦ -->
  <view class="personal-progress" wx:if="{{myProgress && userRole !== 'guest'}}">
    <view class="section-title">
      <text class="title-icon">ğŸ¯</text>
      <text class="title-text">æˆ‘çš„è¿›åº¦</text>
    </view>
    <view class="progress-card">
      <view class="progress-header">
        <view class="progress-info">
          <text class="progress-label">æ‰“å¡è¿›åº¦</text>
          <text class="progress-value">{{myProgress.check_ins_count || 0}}/{{eventInfo.days_count}}å¤©</text>
        </view>
        <text class="progress-percentage">{{myProgress.completion_rate || 0}}%</text>
      </view>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{myProgress.completion_rate || 0}}%"></view>
      </view>
      <view class="progress-stats">
        <view class="progress-stat">
          <text class="stat-icon">ğŸŒ¸</text>
          <text class="stat-text">æ”¶åˆ° {{myProgress.flowers_received_count || 0}} æœµ</text>
        </view>
        <view class="progress-stat">
          <text class="stat-icon">ğŸ‘‘</text>
          <text class="stat-text">é¢†è¯» {{myProgress.leader_days_count || 0}} æ¬¡</text>
        </view>
        <view class="progress-stat">
          <text class="stat-icon">ğŸ”¥</text>
          <text class="stat-text">è¿ç»­ {{myProgress.streak_days || 0}} å¤©</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ´»è·ƒåº¦æ’è¡Œ -->
  <view class="ranking-section" wx:if="{{rankings && rankings.length > 0}}">
    <view class="section-title">
      <text class="title-icon">ğŸ†</text>
      <text class="title-text">æ´»è·ƒåº¦æ’è¡Œ</text>
      <text class="section-desc">æ ¹æ®æ‰“å¡æ•°é‡å’Œæ´»è·ƒåº¦è®¡ç®—</text>
    </view>
    <view class="ranking-list">
      <view class="ranking-item top-three" wx:for="{{rankings}}" wx:key="id" wx:if="{{index < 3}}">
        <view class="rank-medal {{index === 0 ? 'gold' : index === 1 ? 'silver' : 'bronze'}}">
          <text class="medal-icon">{{index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}}</text>
        </view>
        <image class="rank-avatar" src="{{item.avatar_url}}" mode="aspectFill"></image>
        <view class="rank-info">
          <text class="rank-name">{{item.nickname}}</text>
          <text class="rank-stats">æ‰“å¡{{item.checkins_count}}æ¬¡ Â· æ´»è·ƒåº¦{{item.activity_score}}%</text>
          <view class="rank-progress">
            <view class="rank-progress-fill" style="width: {{item.activity_score}}%"></view>
          </view>
        </view>
        <view class="rank-badge" wx:if="{{item.is_organizer}}">ç»„ç»‡è€…</view>
      </view>
      <view class="ranking-item" wx:for="{{rankings}}" wx:key="id" wx:if="{{index >= 3 && index < 10}}">
        <view class="rank-number">{{index + 1}}</view>
        <image class="rank-avatar" src="{{item.avatar_url}}" mode="aspectFill"></image>
        <view class="rank-info">
          <text class="rank-name">{{item.nickname}}</text>
          <text class="rank-stats">æ‰“å¡{{item.checkins_count}}æ¬¡ Â· å®Œæˆç‡{{item.completion_rate}}%</text>
        </view>
      </view>
    </view>
    <view class="view-more" wx:if="{{rankings.length > 10}}" bindtap="viewFullRanking">
      <text>æŸ¥çœ‹å®Œæ•´æ’è¡Œ â†’</text>
    </view>
  </view>

  <!-- æ‰“å¡è¶‹åŠ¿ -->
  <view class="trend-section" wx:if="{{checkinTrend}}">
    <view class="section-title">
      <text class="title-icon">ğŸ“ˆ</text>
      <text class="title-text">æ‰“å¡è¶‹åŠ¿</text>
      <view class="trend-period">
        <text class="period-item {{trendPeriod === '7' ? 'active' : ''}}" bindtap="changeTrendPeriod" data-period="7">7å¤©</text>
        <text class="period-item {{trendPeriod === '30' ? 'active' : ''}}" bindtap="changeTrendPeriod" data-period="30">30å¤©</text>
        <text class="period-item {{trendPeriod === 'all' ? 'active' : ''}}" bindtap="changeTrendPeriod" data-period="all">å…¨éƒ¨</text>
      </view>
    </view>
    <view class="trend-chart">
      <view class="chart-container">
        <view class="chart-bars">
          <view class="chart-bar" wx:for="{{checkinTrend}}" wx:key="date">
            <view class="bar-fill" style="height: {{item.percentage}}%"></view>
            <text class="bar-label">{{item.label}}</text>
            <text class="bar-value">{{item.count}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å‚ä¸ç»Ÿè®¡ -->
  <view class="participation-stats" wx:if="{{participationStats}}">
    <view class="section-title">
      <text class="title-icon">ğŸ‘¥</text>
      <text class="title-text">å‚ä¸ç»Ÿè®¡</text>
    </view>
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-header">
          <text class="stat-icon">ğŸ“Š</text>
          <text class="stat-title">å‚ä¸åˆ†å¸ƒ</text>
        </view>
        <view class="stat-content">
          <view class="participation-chart">
            <view class="chart-segment participants" style="flex: {{participationStats.participants_ratio}}">
              <text class="segment-label">å‚ä¸è€…</text>
              <text class="segment-value">{{participationStats.participants_count}}</text>
            </view>
            <view class="chart-segment observers" style="flex: {{participationStats.observers_ratio}}">
              <text class="segment-label">å›´è§‚è€…</text>
              <text class="segment-value">{{participationStats.observers_count}}</text>
            </view>
          </view>
        </view>
      </view>
      <view class="stat-item">
        <view class="stat-header">
          <text class="stat-icon">âœ…</text>
          <text class="stat-title">å®ŒæˆçŠ¶æ€</text>
        </view>
        <view class="stat-content">
          <view class="completion-list">
            <view class="completion-item">
              <text class="completion-label">å·²å®Œæˆ</text>
              <text class="completion-value">{{participationStats.completed_count}}äºº</text>
            </view>
            <view class="completion-item">
              <text class="completion-label">è¿›è¡Œä¸­</text>
              <text class="completion-value">{{participationStats.in_progress_count}}äºº</text>
            </view>
            <view class="completion-item">
              <text class="completion-label">åˆšå¼€å§‹</text>
              <text class="completion-value">{{participationStats.started_count}}äºº</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- äº’åŠ¨ç»Ÿè®¡ -->
  <view class="interaction-stats" wx:if="{{interactionStats}}">
    <view class="section-title">
      <text class="title-icon">ğŸ’</text>
      <text class="title-text">äº’åŠ¨ç»Ÿè®¡</text>
    </view>
    <view class="interaction-grid">
      <view class="interaction-card">
        <text class="interaction-number">{{interactionStats.total_flowers}}</text>
        <text class="interaction-label">å°çº¢èŠ±æ€»æ•°</text>
        <view class="interaction-desc">é¼“åŠ±ä¸æ”¯æŒ</view>
      </view>
      <view class="interaction-card">
        <text class="interaction-number">{{interactionStats.total_comments}}</text>
        <text class="interaction-label">è¯„è®ºæ€»æ•°</text>
        <view class="interaction-desc">äº¤æµä¸è®¨è®º</view>
      </view>
      <view class="interaction-card">
        <text class="interaction-number">{{interactionStats.total_likes}}</text>
        <text class="interaction-label">ç‚¹èµæ€»æ•°</text>
        <view class="interaction-desc">è®¤å¯ä¸é¼“åŠ±</view>
      </view>
      <view class="interaction-card">
        <text class="interaction-number">{{interactionStats.avg_interaction}}</text>
        <text class="interaction-label">å¹³å‡äº’åŠ¨</text>
        <view class="interaction-desc">æ¯äººäº’åŠ¨æ¬¡æ•°</view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œåŒº -->
  <view class="bottom-actions" wx:if="{{eventInfo}}">
    <button class="action-btn outline" bindtap="exportData">
      <text class="btn-icon">ğŸ“Š</text>
      <text class="btn-text">å¯¼å‡ºæ•°æ®</text>
    </button>
    <button class="action-btn primary" bindtap="goBack">
      <text class="btn-icon">â†</text>
      <text class="btn-text">è¿”å›è¯¦æƒ…</text>
    </button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">ç»Ÿè®¡æ•°æ®åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && !eventInfo}}">
    <text class="empty-emoji">ğŸ“Š</text>
    <text class="empty-text">ç»Ÿè®¡æ•°æ®ä¸å­˜åœ¨</text>
    <text class="empty-desc">è¯¥æ´»åŠ¨å¯èƒ½å·²è¢«åˆ é™¤æˆ–æ‚¨æ²¡æœ‰è®¿é—®æƒé™</text>
    <button class="btn btn-primary" bindtap="goBack">è¿”å›</button>
  </view>
</view>