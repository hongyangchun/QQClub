<!--pages/event/participate.wxml-->
<view class="container participate-container">
  <!-- ç®€åŒ–çš„å‚ä¸è€…å¤´éƒ¨ -->
  <view class="participate-header-simple">
    <view class="header-content">
      <view class="participate-badge">
        <text class="participate-icon">ğŸ¯</text>
        <text class="participate-text">å‚ä¸è€…</text>
      </view>
      <view class="event-basic-info">
        <text class="event-title-simple">{{eventInfo.book_name || 'å…±è¯»æ´»åŠ¨'}}</text>
        <view class="event-meta-simple">
          <text class="meta-text">å®Œæˆè¿›åº¦: {{myEnrollment.completion_rate || 0}}%</text>
          <text class="meta-divider">Â·</text>
          <text class="meta-text">ç¬¬{{currentDay}}/{{eventInfo.days_count || 30}}å¤©</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ä»Šæ—¥ä»»åŠ¡å¡ç‰‡ - ä¼˜å…ˆæ˜¾ç¤º -->
  <view class="today-task-card" wx:if="{{todayTask}}">
    <view class="task-header">
      <text class="task-title">ğŸ“… ä»Šæ—¥ä»»åŠ¡</text>
      <text class="task-date">{{todayTask.date}}</text>
    </view>

    <view class="task-content">
      <view class="task-section" wx:if="{{todayTask.reading_content}}">
        <text class="task-section-title">ğŸ“– ä»Šæ—¥é˜…è¯»</text>
        <text class="task-section-content">{{todayTask.reading_content}}</text>
      </view>

      <view class="task-section" wx:if="{{todayTask.thinking_questions}}">
        <text class="task-section-title">ğŸ’­ æ€è€ƒé¢˜</text>
        <view class="questions-list">
          <text class="question-item" wx:for="{{todayTask.thinking_questions}}" wx:key="index">{{index + 1}}. {{item}}</text>
        </view>
      </view>
    </view>

    <!-- æ‰“å¡çŠ¶æ€ -->
    <view class="checkin-status">
      <view class="status-info" wx:if="{{hasCheckedToday}}">
        <text class="status-icon">âœ…</text>
        <text class="status-text">ä»Šæ—¥å·²å®Œæˆæ‰“å¡</text>
        <text class="checkin-time">{{todayCheckinTime}}</text>
      </view>

      <button class="checkin-btn {{hasCheckedToday ? 'checked' : 'primary'}}"
              bindtap="submitCheckIn"
              disabled="{{hasCheckedToday || !canCheckIn}}">
        <text class="btn-icon">{{hasCheckedToday ? 'âœ…' : 'âœï¸'}}</text>
        <text class="btn-text">{{hasCheckedToday ? 'å·²æ‰“å¡' : 'æäº¤æ‰“å¡'}}</text>
      </button>
    </view>
  </view>

  <!-- æ‰“å¡ä½œä¸šåˆ—è¡¨ - æœ€æ˜¾çœ¼çš„ä½ç½® -->
  <view class="checkins-main-card">
    <view class="card-header">
      <text class="card-title">âœï¸ æ‰“å¡ä½œä¸š</text>
      <view class="filter-tabs">
        <text class="filter-tab {{checkinFilter === 'all' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="all">å…¨éƒ¨</text>
        <text class="filter-tab {{checkinFilter === 'today' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="today">ä»Šæ—¥</text>
        <text class="filter-tab {{checkinFilter === 'featured' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="featured">ç²¾é€‰</text>
      </view>
    </view>

    <view class="checkins-list" wx:if="{{checkins.length > 0}}">
      <view class="checkin-item" wx:for="{{checkins}}" wx:key="id">
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <view class="checkin-header">
          <image class="user-avatar" src="{{item.author.avatar_url}}" mode="aspectFill"></image>
          <view class="user-info">
            <view class="user-name-row">
              <text class="user-name">{{item.author.nickname}}</text>
              <view class="user-badge" wx:if="{{item.day_number}}">ç¬¬{{item.day_number}}å¤©</view>
              <view class="featured-badge" wx:if="{{item.is_featured}}">ç²¾é€‰</view>
            </view>
            <text class="checkin-time">{{item.created_at_relative}}</text>
          </view>
        </view>

        <!-- æ‰“å¡å†…å®¹ -->
        <view class="checkin-content">
          <text class="content-text">{{item.content}}</text>
          <view class="content-images" wx:if="{{item.images && item.images.length > 0}}">
            <image class="content-image" wx:for="{{item.images}}" wx:for-item="image" wx:key="index"
                   src="{{image}}" mode="aspectFill" bindtap="previewImage" data-urls="{{item.images}}" data-current="{{image}}"></image>
          </view>
        </view>

        <!-- äº’åŠ¨åŒºåŸŸ -->
        <view class="interaction-bar">
          <view class="interaction-left">
            <button class="interaction-btn {{item.is_liked ? 'liked' : ''}}" bindtap="likeCheckin" data-id="{{item.id}}">
              <text class="interaction-icon">{{item.is_liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
              <text class="interaction-count">{{item.likes_count}}</text>
            </button>
            <button class="interaction-btn" bindtap="commentCheckin" data-id="{{item.id}}">
              <text class="interaction-icon">ğŸ’¬</text>
              <text class="interaction-count">{{item.comments_count}}</text>
            </button>
            <button class="interaction-btn" bindtap="giveFlowerToCheckin" data-id="{{item.id}}" data-user-id="{{item.author.id}}" wx:if="{{item.author.id !== userInfo.id}}">
              <text class="interaction-icon">ğŸŒ¸</text>
              <text class="interaction-count">é€èŠ±</text>
            </button>
          </view>
          <button class="interaction-btn share-btn" bindtap="shareCheckin" data-id="{{item.id}}">
            <text class="interaction-icon">ğŸ“¤</text>
          </button>
        </view>

        <!-- è¯„è®ºåŒºåŸŸ -->
        <view class="comments-section" wx:if="{{item.comments && item.comments.length > 0}}">
          <view class="comment-item" wx:for="{{item.comments}}" wx:for-item="comment" wx:key="comment.id" wx:for-index="commentIndex">
            <image class="comment-avatar" src="{{comment.author.avatar_url}}" mode="aspectFill"></image>
            <view class="comment-content">
              <text class="comment-author">{{comment.author.nickname}}</text>
              <text class="comment-text">{{comment.content}}</text>
              <text class="comment-time">{{comment.created_at_relative}}</text>
            </view>
            <button class="comment-delete" wx:if="{{comment.author.id === userInfo.id}}" bindtap="deleteComment" data-checkin-id="{{item.id}}" data-comment-id="{{comment.id}}" data-comment-index="{{commentIndex}}">
              <text class="delete-icon">ğŸ—‘ï¸</text>
            </button>
          </view>
          <button class="add-comment-btn" bindtap="commentCheckin" data-id="{{item.id}}">
            <text class="add-comment-text">æ·»åŠ è¯„è®º...</text>
          </button>
        </view>

        <!-- è¯„è®ºè¾“å…¥æ¡†ï¼ˆéšè—çŠ¶æ€ä¸‹ï¼‰ -->
        <view class="comment-input-modal" wx:if="{{showCommentModal && currentCheckinId === item.id}}">
          <view class="comment-input-wrapper">
            <textarea class="comment-textarea" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." value="{{commentContent}}" bindinput="onCommentInput" maxlength="500"></textarea>
            <view class="comment-actions">
              <button class="cancel-btn" bindtap="hideCommentInput">å–æ¶ˆ</button>
              <button class="submit-btn" bindtap="submitComment">å‘é€</button>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-checkins" wx:else>
      <text class="empty-emoji">ğŸ“</text>
      <text class="empty-text">æš‚æ— æ‰“å¡ä½œä¸š</text>
      <text class="empty-desc">æˆä¸ºç¬¬ä¸€ä¸ªæ‰“å¡çš„äººå§ï¼</text>
    </view>
  </view>

  <!-- æˆ‘çš„å‚ä¸ç»Ÿè®¡ -->
  <view class="my-stats-card" wx:if="{{myEnrollment}}">
    <view class="card-header">
      <text class="card-title">ğŸ“Š æˆ‘çš„ç»Ÿè®¡</text>
    </view>
    <view class="stats-grid-modern">
      <view class="stat-item-modern">
        <view class="stat-icon-wrapper">
          <text class="stat-icon">âœï¸</text>
        </view>
        <view class="stat-content">
          <text class="stat-number">{{myEnrollment.check_ins_count || 0}}</text>
          <text class="stat-label">å·²æ‰“å¡</text>
        </view>
      </view>
      <view class="stat-item-modern">
        <view class="stat-icon-wrapper">
          <text class="stat-icon">ğŸŒ¸</text>
        </view>
        <view class="stat-content">
          <text class="stat-number">{{myEnrollment.flowers_received_count || 0}}</text>
          <text class="stat-label">æ”¶åˆ°èŠ±</text>
        </view>
      </view>
      <view class="stat-item-modern">
        <view class="stat-icon-wrapper">
          <text class="stat-icon">ğŸ“ˆ</text>
        </view>
        <view class="stat-content">
          <text class="stat-number">{{myEnrollment.completion_rate || 0}}%</text>
          <text class="stat-label">å®Œæˆç‡</text>
        </view>
      </view>
      <view class="stat-item-modern">
        <view class="stat-icon-wrapper">
          <text class="stat-icon">ğŸ‘‘</text>
        </view>
        <view class="stat-content">
          <text class="stat-number">{{myEnrollment.leader_days_count || 0}}</text>
          <text class="stat-label">é¢†è¯»å¤©æ•°</text>
        </view>
      </view>
    </view>

    <!-- æ´»åŠ¨è¿›åº¦ -->
    <view class="activity-progress-modern">
      <view class="progress-header">
        <text class="progress-label">æ´»åŠ¨è¿›åº¦</text>
        <view class="progress-info-compact">
          <text class="progress-percentage">{{currentDay}}/{{eventInfo.days_count || 30}}å¤©</text>
        </view>
      </view>
      <view class="progress-bar-modern">
        <view class="progress-fill-modern" style="width: {{Math.min(100, Math.round((currentDay / (eventInfo.days_count || 30)) * 100))}}%"></view>
      </view>
    </view>
  </view>

  <!-- æ‰“å¡ç»Ÿè®¡ -->
  <view class="stats-card">
    <view class="card-header">
      <text class="card-title">ğŸ“Š æ‰“å¡ç»Ÿè®¡</text>
    </view>
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{totalCheckinsCount || 0}}</text>
        <text class="stat-label">æ€»æ‰“å¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{todayCheckinsCount || 0}}</text>
        <text class="stat-label">ä»Šæ—¥æ‰“å¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{totalFlowersCount || 0}}</text>
        <text class="stat-label">å°çº¢èŠ±</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{eventInfo.participants_count || 0}}</text>
        <text class="stat-label">å‚ä¸äººæ•°</text>
      </view>
    </view>
  </view>

  <!-- æ´»åŠ¨ä¿¡æ¯ï¼ˆæŠ˜å çŠ¶æ€ï¼‰ -->
  <view class="event-info-collapsible">
    <view class="collapsible-header" bindtap="toggleEventInfo">
      <text class="collapsible-title">æ´»åŠ¨ä¿¡æ¯</text>
      <text class="collapsible-icon">{{showEventInfo ? 'â–¼' : 'â–¶'}}</text>
    </view>
    <view class="collapsible-content" wx:if="{{showEventInfo}}">
      <text class="event-title">{{eventInfo.title}}</text>
      <text class="event-desc">{{eventInfo.description}}</text>
      <view class="event-meta">
        <text class="meta-item">ğŸ“… {{eventInfo.date_range}}</text>
        <text class="meta-item">ğŸ“– {{eventInfo.book_name}}</text>
        <text class="meta-item">ğŸ‘¥ {{eventInfo.participants_count}}äººå‚ä¸</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <view class="bottom-nav">
    <button class="nav-btn active" bindtap="goToParticipate">
      <text class="nav-icon">ğŸ¯</text>
      <text class="nav-text">å…±è¯»</text>
    </button>
    <button class="nav-btn" bindtap="goToObserve">
      <text class="nav-icon">ğŸ‘€</text>
      <text class="nav-text">å›´è§‚</text>
    </button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>