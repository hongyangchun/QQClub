<!--pages/event/observe.wxml-->
<view class="container observe-container">
  <!-- ç®€åŒ–çš„å›´è§‚æ¨¡å¼æ ‡è¯†å¤´éƒ¨ -->
  <view class="observe-header-simple">
    <view class="header-content">
      <view class="observe-badge">
        <text class="observe-icon">ğŸ‘€</text>
        <text class="observe-text">å›´è§‚æ¨¡å¼</text>
      </view>
      <view class="event-basic-info">
        <text class="event-title-simple">{{eventInfo.book_name || 'å…±è¯»æ´»åŠ¨'}}</text>
        <view class="event-meta-simple">
          <text class="meta-text">{{todayCheckinsCount || 0}}äººä»Šæ—¥æ‰“å¡</text>
          <text class="meta-divider">Â·</text>
          <text class="meta-text">ç¬¬{{currentDay}}/{{eventInfo.days_count || 30}}å¤©</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ‰“å¡ä½œä¸šåˆ—è¡¨ - æœ€æ˜¾çœ¼çš„ä½ç½® -->
  <view class="checkins-main-card">
    <view class="card-header">
      <text class="card-title">âœï¸ æ‰“å¡ä½œä¸š</text>
      <view class="filter-tabs">
        <text class="filter-tab {{checkinFilter === 'all' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="all">å…¨éƒ¨</text>
        <text class="filter-tab {{checkinFilter === 'today' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="today">ä»Šæ—¥</text>
        <text class="filter-tab {{checkinFilter === 'featured' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="featured">ç²¾é€‰</text>
      </view>
    </view>

    <view class="checkins-list" wx:if="{{checkins.length > 0}}">
      <view class="checkin-item" wx:for="{{checkins}}" wx:key="id">
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <view class="checkin-header">
          <image class="user-avatar" src="{{item.author.avatar_url}}" mode="aspectFill"></image>
          <view class="user-info">
            <view class="user-name-row">
              <text class="user-name">{{item.author.nickname}}</text>
              <view class="user-badge" wx:if="{{item.day_number}}">ç¬¬{{item.day_number}}å¤©</view>
            </view>
            <text class="checkin-time">{{item.created_at_relative}}</text>
          </view>
        </view>

        <!-- æ‰“å¡å†…å®¹ -->
        <view class="checkin-content">
          <text class="content-text">{{item.content}}</text>
          <view class="content-images" wx:if="{{item.images && item.images.length > 0}}">
            <image class="content-image" wx:for="{{item.images}}" wx:for-item="image" wx:key="index"
                   src="{{image}}" mode="aspectFill" bindtap="previewImage" data-urls="{{item.images}}" data-current="{{image}}"></image>
          </view>
        </view>

        <!-- äº’åŠ¨åŒºåŸŸ -->
        <view class="interaction-bar">
          <view class="interaction-left">
            <button class="interaction-btn {{item.is_liked ? 'liked' : ''}}" bindtap="likeCheckin" data-id="{{item.id}}">
              <text class="interaction-icon">{{item.is_liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
              <text class="interaction-count">{{item.likes_count}}</text>
            </button>
            <button class="interaction-btn" bindtap="commentCheckin" data-id="{{item.id}}">
              <text class="interaction-icon">ğŸ’¬</text>
              <text class="interaction-count">{{item.comments_count}}</text>
            </button>
            <button class="interaction-btn" bindtap="giveFlowerToCheckin" data-id="{{item.id}}" data-user-id="{{item.author.id}}">
              <text class="interaction-icon">ğŸŒ¸</text>
              <text class="interaction-count">é€èŠ±</text>
            </button>
          </view>
          <button class="interaction-btn share-btn" bindtap="shareCheckin" data-id="{{item.id}}">
            <text class="interaction-icon">ğŸ“¤</text>
          </button>
        </view>

        <!-- è¯„è®ºåŒºåŸŸ -->
        <view class="comments-section" wx:if="{{item.comments && item.comments.length > 0}}">
          <view class="comment-item" wx:for="{{item.comments}}" wx:for-item="comment" wx:key="comment.id" wx:for-index="commentIndex">
            <image class="comment-avatar" src="{{comment.author.avatar_url}}" mode="aspectFill"></image>
            <view class="comment-content">
              <text class="comment-author">{{comment.author.nickname}}</text>
              <text class="comment-text">{{comment.content}}</text>
              <text class="comment-time">{{comment.created_at_relative}}</text>
            </view>
            <button class="comment-delete" wx:if="{{comment.author.id === userInfo.id}}" bindtap="deleteComment" data-checkin-id="{{item.id}}" data-comment-id="{{comment.id}}" data-comment-index="{{commentIndex}}">
              <text class="delete-icon">ğŸ—‘ï¸</text>
            </button>
          </view>
          <button class="add-comment-btn" bindtap="commentCheckin" data-id="{{item.id}}">
            <text class="add-comment-text">æ·»åŠ è¯„è®º...</text>
          </button>
        </view>

        <!-- è¯„è®ºè¾“å…¥æ¡†ï¼ˆéšè—çŠ¶æ€ä¸‹ï¼‰ -->
        <view class="comment-input-modal" wx:if="{{showCommentModal && currentCheckinId === item.id}}">
          <view class="comment-input-wrapper">
            <textarea class="comment-textarea" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." value="{{commentContent}}" bindinput="onCommentInput" maxlength="500"></textarea>
            <view class="comment-actions">
              <button class="cancel-btn" bindtap="hideCommentInput">å–æ¶ˆ</button>
              <button class="submit-btn" bindtap="submitComment">å‘é€</button>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-checkins" wx:else>
      <text class="empty-emoji">ğŸ“</text>
      <text class="empty-text">æš‚æ— æ‰“å¡ä½œä¸š</text>
      <text class="empty-desc">æˆä¸ºç¬¬ä¸€ä¸ªæ‰“å¡çš„äººå§ï¼</text>
      <button class="upgrade-btn" bindtap="upgradeToParticipant" wx:if="{{eventInfo.can_enroll}}">
        <text class="btn-text">å‡çº§ä¸ºå‚ä¸è€…</text>
      </button>
    </view>
  </view>

  <!-- æ‰“å¡ç»Ÿè®¡ -->
  <view class="stats-card">
    <view class="card-header">
      <text class="card-title">ğŸ“Š æ‰“å¡ç»Ÿè®¡</text>
    </view>
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{totalCheckinsCount || 0}}</text>
        <text class="stat-label">æ€»æ‰“å¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{todayCheckinsCount || 0}}</text>
        <text class="stat-label">ä»Šæ—¥æ‰“å¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{totalFlowersCount || 0}}</text>
        <text class="stat-label">å°çº¢èŠ±</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{eventInfo.participants_count || 0}}</text>
        <text class="stat-label">å‚ä¸äººæ•°</text>
      </view>
    </view>
  </view>

  <!-- å‡çº§æç¤º -->
  <view class="upgrade-prompt" wx:if="{{!myEnrollment && eventInfo.can_enroll}}">
    <view class="upgrade-content">
      <text class="upgrade-title">ğŸ¯ æƒ³è¦å‚ä¸æ‰“å¡å—ï¼Ÿ</text>
      <text class="upgrade-desc">å‡çº§ä¸ºå‚ä¸è€…ï¼Œè®°å½•ä½ çš„é˜…è¯»æ„Ÿæ‚Ÿ</text>
      <button class="upgrade-btn primary" bindtap="upgradeToParticipant">
        <text class="btn-text">ç«‹å³å‡çº§</text>
      </button>
    </view>
  </view>

  <!-- æ´»åŠ¨ä¿¡æ¯ï¼ˆæŠ˜å çŠ¶æ€ï¼‰ -->
  <view class="event-info-collapsible">
    <view class="collapsible-header" bindtap="toggleEventInfo">
      <text class="collapsible-title">æ´»åŠ¨ä¿¡æ¯</text>
      <text class="collapsible-icon">{{showEventInfo ? 'â–¼' : 'â–¶'}}</text>
    </view>
    <view class="collapsible-content" wx:if="{{showEventInfo}}">
      <text class="event-title">{{eventInfo.title}}</text>
      <text class="event-desc">{{eventInfo.description}}</text>
      <view class="event-meta">
        <text class="meta-item">ğŸ“… {{eventInfo.date_range}}</text>
        <text class="meta-item">ğŸ“– {{eventInfo.book_name}}</text>
        <text class="meta-item">ğŸ‘¥ {{eventInfo.participants_count}}äººå‚ä¸</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <view class="bottom-nav">
    <button class="nav-btn" bindtap="goToParticipate">
      <text class="nav-icon">ğŸ¯</text>
      <text class="nav-text">å…±è¯»</text>
    </button>
    <button class="nav-btn active" bindtap="goToObserve">
      <text class="nav-icon">ğŸ‘€</text>
      <text class="nav-text">å›´è§‚</text>
    </button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>