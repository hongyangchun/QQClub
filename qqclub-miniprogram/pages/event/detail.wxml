<!--pages/event/detail.wxml-->
<view class="container page-container">
  <!-- æ´»åŠ¨å¤´éƒ¨ä¿¡æ¯ -->
  <view class="event-hero" wx:if="{{eventInfo}}">
    <view class="hero-background"></view>
    <view class="hero-content">
      <!-- æ´»åŠ¨çŠ¶æ€ -->
      <view class="event-status-bar">
        <view class="status-item approval-{{eventInfo.approval_status}}">
          <text class="status-dot"></text>
          <text class="status-text">{{eventInfo.approval_status_text}}</text>
        </view>
        <view class="status-item status-{{eventInfo.status}}">
          <text class="status-icon">{{eventInfo.status_icon}}</text>
          <text class="status-text">{{eventInfo.status_text}}</text>
        </view>
      </view>

      <!-- æ´»åŠ¨æ ‡é¢˜å’Œä¹¦ç± -->
      <view class="event-title-section">
        <view class="event-title">{{eventInfo.title}}</view>
        <view class="event-book">
          <text class="book-icon">ğŸ“–</text>
          <text class="book-name">{{eventInfo.book_name}}</text>
        </view>
      </view>

      <!-- æ´»åŠ¨æ—¶é—´ä¿¡æ¯ -->
      <view class="event-time-info">
        <view class="time-item">
          <text class="time-icon">ğŸ“…</text>
          <view class="time-content">
            <text class="time-label">æ´»åŠ¨æ—¶é—´</text>
            <text class="time-value">{{eventInfo.date_range}}</text>
          </view>
        </view>
        <view class="time-item">
          <text class="time-icon">â°</text>
          <view class="time-content">
            <text class="time-label">æ´»åŠ¨å¤©æ•°</text>
            <text class="time-value">{{eventInfo.days_count}}å¤©</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ´»åŠ¨æ“ä½œåŒº -->
  <view class="action-section" wx:if="{{eventInfo}}">
    <!-- å‚ä¸ç»Ÿè®¡ -->
    <view class="participation-stats">
      <view class="stat-card">
        <view class="stat-number">{{eventInfo.participants_count}}</view>
        <view class="stat-label">å‚ä¸äººæ•°</view>
      </view>
      <view class="stat-card">
        <view class="stat-number">{{eventInfo.max_participants}}</view>
        <view class="stat-label">æœ€å¤§äººæ•°</view>
      </view>
      <view class="stat-card">
        <view class="stat-number">{{eventInfo.enrollment_fee}}</view>
        <view class="stat-label">è´¹ç”¨(å…ƒ)</view>
      </view>
      <view class="stat-card">
        <view class="stat-number">{{eventInfo.completed_today || 0}}</view>
        <view class="stat-label">ä»Šæ—¥æ‰“å¡</view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons" wx:if="{{!loading}}">
      <!-- å‚ä¸è€…æŒ‰é’® -->
      <view class="participant-actions" wx:if="{{userRole === 'participant'}}">
        <button class="action-btn primary" bindtap="submitCheckIn">
          <text class="btn-icon">âœï¸</text>
          <text class="btn-text">æäº¤æ‰“å¡</text>
        </button>
        <button class="action-btn secondary" bindtap="viewProgress">
          <text class="btn-icon">ğŸ“Š</text>
          <text class="btn-text">æŸ¥çœ‹è¿›åº¦</text>
        </button>
      </view>

      <!-- å›´è§‚è€…æŒ‰é’® -->
      <view class="observer-actions" wx:if="{{userRole === 'observer'}}">
        <button class="action-btn primary" bindtap="switchToParticipant" wx:if="{{eventInfo.can_enroll}}">
          <text class="btn-icon">ğŸ¯</text>
          <text class="btn-text">è½¬ä¸ºå‚ä¸</text>
        </button>
        <button class="action-btn secondary" bindtap="viewDiscussions">
          <text class="btn-icon">ğŸ’¬</text>
          <text class="btn-text">æŸ¥çœ‹è®¨è®º</text>
        </button>
      </view>

      <!-- æœªå‚ä¸æŒ‰é’® -->
      <view class="guest-actions" wx:if="{{userRole === 'guest'}}">
        <button class="action-btn primary" bindtap="enrollAsParticipant" wx:if="{{eventInfo.can_enroll}}">
          <text class="btn-icon">ğŸ¯</text>
          <text class="btn-text">ç«‹å³å‚ä¸</text>
        </button>
        <button class="action-btn outline" bindtap="enrollAsObserver">
          <text class="btn-icon">ğŸ‘ï¸</text>
          <text class="btn-text">å›´è§‚æ´»åŠ¨</text>
        </button>
      </view>

      <!-- ç»„ç»‡è€…æŒ‰é’® -->
      <view class="organizer-actions" wx:if="{{userRole === 'organizer'}}">
        <button class="action-btn primary" bindtap="manageEvent">
          <text class="btn-icon">âš™ï¸</text>
          <text class="btn-text">ç®¡ç†æ´»åŠ¨</text>
        </button>
        <button class="action-btn secondary" bindtap="viewStatistics">
          <text class="btn-icon">ğŸ“ˆ</text>
          <text class="btn-text">æ•°æ®ç»Ÿè®¡</text>
        </button>
      </view>
    </view>
  </view>

  <!-- æ´»åŠ¨å†…å®¹åŒºåŸŸ -->
  <view class="content-section" wx:if="{{eventInfo}}">
    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <view class="tab-section">
      <view class="tab-bar">
        <view class="tab-item {{currentTab === 'info' ? 'active' : ''}}" bindtap="switchTab" data-tab="info">
          <text class="tab-text">æ´»åŠ¨è¯¦æƒ…</text>
        </view>
        <view class="tab-item {{currentTab === 'checkins' ? 'active' : ''}}" bindtap="switchTab" data-tab="checkins">
          <text class="tab-text">æ‰“å¡ä½œä¸š</text>
          <view class="tab-badge" wx:if="{{checkinsCount > 0}}">{{checkinsCount}}</view>
        </view>
        <view class="tab-item {{currentTab === 'participants' ? 'active' : ''}}" bindtap="switchTab" data-tab="participants">
          <text class="tab-text">å‚ä¸æˆå‘˜</text>
          <view class="tab-badge">{{eventInfo.participants_count}}</view>
        </view>
        <view class="tab-item {{currentTab === 'discussions' ? 'active' : ''}}" bindtap="switchTab" data-tab="discussions">
          <text class="tab-text">æ´»åŠ¨è®¨è®º</text>
          <view class="tab-badge" wx:if="{{discussionsCount > 0}}">{{discussionsCount}}</view>
        </view>
      </view>
    </view>

    <!-- æ´»åŠ¨è¯¦æƒ…é¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'info'}}">
      <view class="info-card">
        <view class="card-title">æ´»åŠ¨ä»‹ç»</view>
        <view class="card-content">
          <text class="description">{{eventInfo.description || 'æš‚æ— è¯¦ç»†ä»‹ç»'}}</text>
        </view>
      </view>

      <view class="info-card">
        <view class="card-title">æ´»åŠ¨è§„åˆ™</view>
        <view class="card-content">
          <text class="rules">{{eventInfo.rules || 'æš‚æ— è§„åˆ™è¯´æ˜'}}</text>
        </view>
      </view>

      <view class="info-card">
        <view class="card-title">ç»„ç»‡è€…ä¿¡æ¯</view>
        <view class="organizer-info">
          <image class="organizer-avatar" src="{{eventInfo.leader.avatar_url}}" mode="aspectFill"></image>
          <view class="organizer-details">
            <view class="organizer-name">{{eventInfo.leader.nickname}}</view>
            <view class="organizer-desc">{{eventInfo.leader.bio || 'æ´»åŠ¨ç»„ç»‡è€…'}}</view>
          </view>
          <button class="contact-btn" bindtap="contactOrganizer">
            <text class="btn-icon">ğŸ’¬</text>
          </button>
        </view>
      </view>
    </view>

    <!-- æ‰“å¡ä½œä¸šé¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'checkins'}}">
      <view class="checkins-header">
        <text class="section-title">æ‰“å¡ä½œä¸šåˆ—è¡¨</text>
        <view class="filter-tabs">
          <view class="filter-tab {{checkinFilter === 'all' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="all">
            å…¨éƒ¨
          </view>
          <view class="filter-tab {{checkinFilter === 'today' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="today">
            ä»Šæ—¥
          </view>
          <view class="filter-tab {{checkinFilter === 'liked' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="liked">
            å·²ç‚¹èµ
          </view>
        </view>
      </view>

      <view class="checkins-list" wx:if="{{checkins.length > 0}}">
        <view class="checkin-card" wx:for="{{checkins}}" wx:key="id" bindtap="viewCheckinDetail" data-id="{{item.id}}">
          <!-- æ‰“å¡è€…ä¿¡æ¯ -->
          <view class="checkin-header">
            <image class="user-avatar" src="{{item.author.avatar_url}}" mode="aspectFill"></image>
            <view class="user-info">
              <view class="user-name">{{item.author.nickname}}</view>
              <view class="checkin-time">{{item.created_at_relative}}</view>
            </view>
            <view class="checkin-day">
              <text class="day-number">ç¬¬{{item.day_number}}å¤©</text>
            </view>
          </view>

          <!-- æ‰“å¡å†…å®¹ -->
          <view class="checkin-content">
            <text class="checkin-text">{{item.content}}</text>

            <!-- æ‰“å¡å›¾ç‰‡ -->
            <view class="checkin-images" wx:if="{{item.images && item.images.length > 0}}">
              <image class="checkin-image" wx:for="{{item.images}}" wx:for-item="image" wx:key="index" src="{{image}}" mode="aspectFill" bindtap="previewImage" data-urls="{{item.images}}" data-current="{{image}}"></image>
            </view>
          </view>

          <!-- æ‰“å¡äº’åŠ¨ -->
          <view class="checkin-actions">
            <view class="action-item" bindtap="likeCheckin" data-id="{{item.id}}" catchtap="true">
              <text class="action-icon {{item.is_liked ? 'liked' : ''}}">â¤ï¸</text>
              <text class="action-count">{{item.likes_count}}</text>
            </view>
            <view class="action-item" bindtap="commentCheckin" data-id="{{item.id}}" catchtap="true">
              <text class="action-icon">ğŸ’¬</text>
              <text class="action-count">{{item.comments_count}}</text>
            </view>
            <view class="action-item" wx:if="{{userRole !== 'observer'}}" bindtap="shareCheckin" data-id="{{item.id}}" catchtap="true">
              <text class="action-icon">ğŸ“¤</text>
            </view>
          </view>

          <!-- è¯„è®ºåŒº -->
          <view class="comments-section" wx:if="{{item.comments && item.comments.length > 0}}">
            <view class="comment-item" wx:for="{{item.comments}}" wx:for-item="comment" wx:key="id">
              <image class="comment-avatar" src="{{comment.author.avatar_url}}" mode="aspectFill"></image>
              <view class="comment-content">
                <view class="comment-header">
                  <text class="comment-name">{{comment.author.nickname}}</text>
                  <text class="comment-time">{{comment.created_at_relative}}</text>
                </view>
                <text class="comment-text">{{comment.content}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{checkins.length === 0}}">
        <text class="empty-emoji">ğŸ“</text>
        <text class="empty-text">æš‚æ— æ‰“å¡ä½œä¸š</text>
        <text class="empty-desc">å¿«æ¥æäº¤ç¬¬ä¸€ä¸ªæ‰“å¡å§ï¼</text>
      </view>
    </view>

    <!-- å‚ä¸æˆå‘˜é¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'participants'}}">
      <view class="participants-list" wx:if="{{participants.length > 0}}">
        <view class="participant-card" wx:for="{{participants}}" wx:key="id">
          <image class="participant-avatar" src="{{item.avatar_url}}" mode="aspectFill"></image>
          <view class="participant-info">
            <view class="participant-name">{{item.nickname}}</view>
            <view class="participant-role">{{item.role_text}}</view>
            <view class="participant-stats">
              <text class="stat-text">æ‰“å¡{{item.checkins_count}}æ¬¡</text>
              <text class="stat-divider">Â·</text>
              <text class="stat-text">æ´»è·ƒåº¦{{item.activity_score}}%</text>
            </view>
          </view>
          <view class="participant-badge" wx:if="{{item.is_organizer}}">
            ç»„ç»‡è€…
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{participants.length === 0}}">
        <text class="empty-emoji">ğŸ‘¥</text>
        <text class="empty-text">æš‚æ— å‚ä¸æˆå‘˜</text>
        <text class="empty-desc">å¿«æ¥å‚ä¸è¿™ä¸ªæ´»åŠ¨å§ï¼</text>
      </view>
    </view>

    <!-- æ´»åŠ¨è®¨è®ºé¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'discussions'}}">
      <view class="discussions-list" wx:if="{{discussions.length > 0}}">
        <view class="discussion-card" wx:for="{{discussions}}" wx:key="id" bindtap="viewDiscussion" data-id="{{item.id}}">
          <view class="discussion-header">
            <image class="author-avatar" src="{{item.author.avatar_url}}" mode="aspectFill"></image>
            <view class="discussion-info">
              <view class="discussion-title">{{item.title}}</view>
              <view class="discussion-meta">
                <text class="author-name">{{item.author.nickname}}</text>
                <text class="discussion-time">{{item.created_at_relative}}</text>
              </view>
            </view>
          </view>
          <view class="discussion-preview">{{item.content_preview}}</view>
          <view class="discussion-stats">
            <text class="stat-item">ğŸ’¬ {{item.comments_count}}</text>
            <text class="stat-item">ğŸ‘ï¸ {{item.views_count}}</text>
          </view>
        </view>
      </view>

      <!-- å‘èµ·è®¨è®ºæŒ‰é’® -->
      <button class="start-discussion-btn" bindtap="startDiscussion" wx:if="{{userRole !== 'observer'}}">
        <text class="btn-icon">ğŸ’¬</text>
        <text class="btn-text">å‘èµ·è®¨è®º</text>
      </button>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{discussions.length === 0}}">
        <text class="empty-emoji">ğŸ’­</text>
        <text class="empty-text">æš‚æ— è®¨è®ºè¯é¢˜</text>
        <text class="empty-desc">æ¥å‘èµ·ç¬¬ä¸€ä¸ªè®¨è®ºå§ï¼</text>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && !eventInfo}}">
    <text class="empty-emoji">ğŸ“š</text>
    <text class="empty-text">æ´»åŠ¨ä¸å­˜åœ¨</text>
    <text class="empty-desc">è¯¥æ´»åŠ¨å¯èƒ½å·²è¢«åˆ é™¤æˆ–æ‚¨æ²¡æœ‰è®¿é—®æƒé™</text>
    <button class="btn btn-primary" bindtap="goBack">è¿”å›åˆ—è¡¨</button>
  </view>
</view>