<!--pages/event/detail.wxml-->
<view class="container page-container">
  <!-- 活动头部信息 -->
  <view class="event-hero" wx:if="{{eventInfo}}">
    <view class="hero-background"></view>
    <view class="hero-content">
      <!-- 活动状态 -->
      <view class="event-status-bar">
        <view class="status-item approval-{{eventInfo.approval_status}}">
          <text class="status-dot"></text>
          <text class="status-text">{{eventInfo.approval_status_text}}</text>
        </view>
        <view class="status-item status-{{eventInfo.status}}">
          <text class="status-icon">{{eventInfo.status_icon}}</text>
          <text class="status-text">{{eventInfo.status_text}}</text>
        </view>
      </view>

      <!-- 活动标题和书籍 -->
      <view class="event-title-section">
        <view class="event-title">{{eventInfo.title}}</view>
        <view class="event-book">
          <text class="book-icon">📖</text>
          <text class="book-name">{{eventInfo.book_name}}</text>
        </view>
      </view>

      <!-- 活动时间信息 -->
      <view class="event-time-info">
        <view class="time-item">
          <text class="time-icon">📅</text>
          <view class="time-content">
            <text class="time-label">活动时间</text>
            <text class="time-value">{{eventInfo.date_range}}</text>
          </view>
        </view>
        <view class="time-item">
          <text class="time-icon">⏰</text>
          <view class="time-content">
            <text class="time-label">活动天数</text>
            <text class="time-value">{{eventInfo.days_count}}天</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 活动操作区 -->
  <view class="action-section" wx:if="{{eventInfo}}">
    <!-- 参与统计 -->
    <view class="participation-stats">
      <view class="stat-card">
        <view class="stat-number">{{eventInfo.participants_count}}</view>
        <view class="stat-label">参与人数</view>
      </view>
      <view class="stat-card">
        <view class="stat-number">{{eventInfo.max_participants}}</view>
        <view class="stat-label">最大人数</view>
      </view>
      <view class="stat-card">
        <view class="stat-number">{{eventInfo.enrollment_fee}}</view>
        <view class="stat-label">费用(元)</view>
      </view>
      <view class="stat-card">
        <view class="stat-number">{{eventInfo.completed_today || 0}}</view>
        <view class="stat-label">今日打卡</view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons" wx:if="{{!loading}}">
      <!-- 参与者按钮 -->
      <view class="participant-actions" wx:if="{{userRole === 'participant'}}">
        <button class="action-btn primary" bindtap="submitCheckIn">
          <text class="btn-icon">✍️</text>
          <text class="btn-text">提交打卡</text>
        </button>
        <button class="action-btn secondary" bindtap="viewProgress">
          <text class="btn-icon">📊</text>
          <text class="btn-text">查看进度</text>
        </button>
      </view>

      <!-- 围观者按钮 -->
      <view class="observer-actions" wx:if="{{userRole === 'observer'}}">
        <button class="action-btn primary" bindtap="switchToParticipant" wx:if="{{eventInfo.can_enroll}}">
          <text class="btn-icon">🎯</text>
          <text class="btn-text">转为参与</text>
        </button>
        <button class="action-btn secondary" bindtap="viewDiscussions">
          <text class="btn-icon">💬</text>
          <text class="btn-text">查看讨论</text>
        </button>
      </view>

      <!-- 未参与按钮 -->
      <view class="guest-actions" wx:if="{{userRole === 'guest'}}">
        <button class="action-btn primary" bindtap="enrollAsParticipant" wx:if="{{eventInfo.can_enroll}}">
          <text class="btn-icon">🎯</text>
          <text class="btn-text">立即参与</text>
        </button>
        <button class="action-btn outline" bindtap="enrollAsObserver">
          <text class="btn-icon">👁️</text>
          <text class="btn-text">围观活动</text>
        </button>
      </view>

      <!-- 组织者按钮 -->
      <view class="organizer-actions" wx:if="{{userRole === 'organizer'}}">
        <button class="action-btn primary" bindtap="manageEvent">
          <text class="btn-icon">⚙️</text>
          <text class="btn-text">管理活动</text>
        </button>
        <button class="action-btn secondary" bindtap="viewStatistics">
          <text class="btn-icon">📈</text>
          <text class="btn-text">数据统计</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 活动内容区域 -->
  <view class="content-section" wx:if="{{eventInfo}}">
    <!-- 标签页切换 -->
    <view class="tab-section">
      <view class="tab-bar">
        <view class="tab-item {{currentTab === 'info' ? 'active' : ''}}" bindtap="switchTab" data-tab="info">
          <text class="tab-text">活动详情</text>
        </view>
        <view class="tab-item {{currentTab === 'checkins' ? 'active' : ''}}" bindtap="switchTab" data-tab="checkins">
          <text class="tab-text">打卡作业</text>
          <view class="tab-badge" wx:if="{{checkinsCount > 0}}">{{checkinsCount}}</view>
        </view>
        <view class="tab-item {{currentTab === 'participants' ? 'active' : ''}}" bindtap="switchTab" data-tab="participants">
          <text class="tab-text">参与成员</text>
          <view class="tab-badge">{{eventInfo.participants_count}}</view>
        </view>
        <view class="tab-item {{currentTab === 'discussions' ? 'active' : ''}}" bindtap="switchTab" data-tab="discussions">
          <text class="tab-text">活动讨论</text>
          <view class="tab-badge" wx:if="{{discussionsCount > 0}}">{{discussionsCount}}</view>
        </view>
      </view>
    </view>

    <!-- 活动详情页 -->
    <view class="tab-content" wx:if="{{currentTab === 'info'}}">
      <view class="info-card">
        <view class="card-title">活动介绍</view>
        <view class="card-content">
          <text class="description">{{eventInfo.description || '暂无详细介绍'}}</text>
        </view>
      </view>

      <view class="info-card">
        <view class="card-title">活动规则</view>
        <view class="card-content">
          <text class="rules">{{eventInfo.rules || '暂无规则说明'}}</text>
        </view>
      </view>

      <view class="info-card">
        <view class="card-title">组织者信息</view>
        <view class="organizer-info">
          <image class="organizer-avatar" src="{{eventInfo.leader.avatar_url}}" mode="aspectFill"></image>
          <view class="organizer-details">
            <view class="organizer-name">{{eventInfo.leader.nickname}}</view>
            <view class="organizer-desc">{{eventInfo.leader.bio || '活动组织者'}}</view>
          </view>
          <button class="contact-btn" bindtap="contactOrganizer">
            <text class="btn-icon">💬</text>
          </button>
        </view>
      </view>
    </view>

    <!-- 打卡作业页 -->
    <view class="tab-content" wx:if="{{currentTab === 'checkins'}}">
      <view class="checkins-header">
        <text class="section-title">打卡作业列表</text>
        <view class="filter-tabs">
          <view class="filter-tab {{checkinFilter === 'all' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="all">
            全部
          </view>
          <view class="filter-tab {{checkinFilter === 'today' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="today">
            今日
          </view>
          <view class="filter-tab {{checkinFilter === 'liked' ? 'active' : ''}}" bindtap="filterCheckins" data-filter="liked">
            已点赞
          </view>
        </view>
      </view>

      <view class="checkins-list" wx:if="{{checkins.length > 0}}">
        <view class="checkin-card" wx:for="{{checkins}}" wx:key="id" bindtap="viewCheckinDetail" data-id="{{item.id}}">
          <!-- 打卡者信息 -->
          <view class="checkin-header">
            <image class="user-avatar" src="{{item.author.avatar_url}}" mode="aspectFill"></image>
            <view class="user-info">
              <view class="user-name">{{item.author.nickname}}</view>
              <view class="checkin-time">{{item.created_at_relative}}</view>
            </view>
            <view class="checkin-day">
              <text class="day-number">第{{item.day_number}}天</text>
            </view>
          </view>

          <!-- 打卡内容 -->
          <view class="checkin-content">
            <text class="checkin-text">{{item.content}}</text>

            <!-- 打卡图片 -->
            <view class="checkin-images" wx:if="{{item.images && item.images.length > 0}}">
              <image class="checkin-image" wx:for="{{item.images}}" wx:for-item="image" wx:key="index" src="{{image}}" mode="aspectFill" bindtap="previewImage" data-urls="{{item.images}}" data-current="{{image}}"></image>
            </view>
          </view>

          <!-- 打卡互动 -->
          <view class="checkin-actions">
            <view class="action-item" bindtap="likeCheckin" data-id="{{item.id}}" catchtap="true">
              <text class="action-icon {{item.is_liked ? 'liked' : ''}}">❤️</text>
              <text class="action-count">{{item.likes_count}}</text>
            </view>
            <view class="action-item" bindtap="commentCheckin" data-id="{{item.id}}" catchtap="true">
              <text class="action-icon">💬</text>
              <text class="action-count">{{item.comments_count}}</text>
            </view>
            <view class="action-item" wx:if="{{userRole !== 'observer'}}" bindtap="shareCheckin" data-id="{{item.id}}" catchtap="true">
              <text class="action-icon">📤</text>
            </view>
          </view>

          <!-- 评论区 -->
          <view class="comments-section" wx:if="{{item.comments && item.comments.length > 0}}">
            <view class="comment-item" wx:for="{{item.comments}}" wx:for-item="comment" wx:key="id">
              <image class="comment-avatar" src="{{comment.author.avatar_url}}" mode="aspectFill"></image>
              <view class="comment-content">
                <view class="comment-header">
                  <text class="comment-name">{{comment.author.nickname}}</text>
                  <text class="comment-time">{{comment.created_at_relative}}</text>
                </view>
                <text class="comment-text">{{comment.content}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{checkins.length === 0}}">
        <text class="empty-emoji">📝</text>
        <text class="empty-text">暂无打卡作业</text>
        <text class="empty-desc">快来提交第一个打卡吧！</text>
      </view>
    </view>

    <!-- 参与成员页 -->
    <view class="tab-content" wx:if="{{currentTab === 'participants'}}">
      <view class="participants-list" wx:if="{{participants.length > 0}}">
        <view class="participant-card" wx:for="{{participants}}" wx:key="id">
          <image class="participant-avatar" src="{{item.avatar_url}}" mode="aspectFill"></image>
          <view class="participant-info">
            <view class="participant-name">{{item.nickname}}</view>
            <view class="participant-role">{{item.role_text}}</view>
            <view class="participant-stats">
              <text class="stat-text">打卡{{item.checkins_count}}次</text>
              <text class="stat-divider">·</text>
              <text class="stat-text">活跃度{{item.activity_score}}%</text>
            </view>
          </view>
          <view class="participant-badge" wx:if="{{item.is_organizer}}">
            组织者
          </view>
        </view>
      </view>

      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{participants.length === 0}}">
        <text class="empty-emoji">👥</text>
        <text class="empty-text">暂无参与成员</text>
        <text class="empty-desc">快来参与这个活动吧！</text>
      </view>
    </view>

    <!-- 活动讨论页 -->
    <view class="tab-content" wx:if="{{currentTab === 'discussions'}}">
      <view class="discussions-list" wx:if="{{discussions.length > 0}}">
        <view class="discussion-card" wx:for="{{discussions}}" wx:key="id" bindtap="viewDiscussion" data-id="{{item.id}}">
          <view class="discussion-header">
            <image class="author-avatar" src="{{item.author.avatar_url}}" mode="aspectFill"></image>
            <view class="discussion-info">
              <view class="discussion-title">{{item.title}}</view>
              <view class="discussion-meta">
                <text class="author-name">{{item.author.nickname}}</text>
                <text class="discussion-time">{{item.created_at_relative}}</text>
              </view>
            </view>
          </view>
          <view class="discussion-preview">{{item.content_preview}}</view>
          <view class="discussion-stats">
            <text class="stat-item">💬 {{item.comments_count}}</text>
            <text class="stat-item">👁️ {{item.views_count}}</text>
          </view>
        </view>
      </view>

      <!-- 发起讨论按钮 -->
      <button class="start-discussion-btn" bindtap="startDiscussion" wx:if="{{userRole !== 'observer'}}">
        <text class="btn-icon">💬</text>
        <text class="btn-text">发起讨论</text>
      </button>

      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{discussions.length === 0}}">
        <text class="empty-emoji">💭</text>
        <text class="empty-text">暂无讨论话题</text>
        <text class="empty-desc">来发起第一个讨论吧！</text>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{!loading && !eventInfo}}">
    <text class="empty-emoji">📚</text>
    <text class="empty-text">活动不存在</text>
    <text class="empty-desc">该活动可能已被删除或您没有访问权限</text>
    <button class="btn btn-primary" bindtap="goBack">返回列表</button>
  </view>
</view>