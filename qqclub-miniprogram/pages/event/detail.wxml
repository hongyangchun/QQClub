<!--pages/event/detail.wxml-->
<view class="container page-container">
  <!-- æ´»åŠ¨å¤´éƒ¨ä¿¡æ¯ - é‡æ–°è®¾è®¡çš„ç°ä»£åŒ–banner -->
  <view class="event-hero-modern" wx:if="{{eventInfo}}">
    <view class="hero-background-modern"></view>
    <view class="hero-content-modern">
      <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
      <view class="hero-main">
        <view class="event-banner-layout">
          <!-- å·¦ä¾§ï¼šä¹¦ç±å°é¢ -->
          <view class="book-cover-section">
            <image
              class="book-cover-main"
              src="{{eventInfo.book_cover_image || 'https://picsum.photos/120/160?random=book'}}"
              mode="aspectFill"
              binderror="handleBookCoverError"
            ></image>
            <view class="book-cover-shine"></view>
          </view>

          <!-- ä¸­é—´ï¼šæ´»åŠ¨ä¿¡æ¯ -->
          <view class="event-info-section">
            <view class="event-title-main">{{eventInfo.title}}</view>
            <view class="event-book-name">{{eventInfo.book_name}}</view>
            <view class="event-meta-row">
              <view class="meta-badge status-{{eventInfo.status}}">{{getEventStatusText(eventInfo.status)}}</view>
              <text class="meta-text">{{eventInfo.participants_count || 0}}äººå‚ä¸</text>
              <text class="meta-divider">Â·</text>
              <text class="meta-text">{{getDaysLeft(eventInfo)}}</text>
            </view>
          </view>

          <!-- å³ä¾§ï¼šå¯¼èˆªæŒ‰é’® -->
          <view class="nav-buttons-section">
            <view class="nav-button-modern" bindtap="goToActivityInfo">
              <text class="nav-icon">â„¹ï¸</text>
            </view>
            <view class="nav-button-modern" bindtap="goToStatistics">
              <text class="nav-icon">ğŸ“Š</text>
            </view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨è£…é¥° -->
      <view class="hero-decoration">
        <view class="decoration-wave"></view>
      </view>
    </view>
  </view>

  <!-- æˆ‘çš„å‚ä¸çŠ¶æ€åŒº -->
  <view class="my-status-section" wx:if="{{eventInfo && userInfo}}">
    <view class="status-header">
      <view class="role-badge role-{{userRole}}">
        <text class="role-icon">{{getRoleIcon(userRole)}}</text>
        <text class="role-text">{{getRoleText(userRole)}}</text>
      </view>
      <view class="status-info" wx:if="{{myEnrollment}}">
        <text class="join-date">åŠ å…¥æ—¶é—´ï¼š{{myEnrollment.enrollment_date}}</text>
        <text class="completion-rate" wx:if="{{userRole === 'participant'}}">å®Œæˆç‡ï¼š{{myEnrollment.completion_rate}}%</text>
      </view>
    </view>

    <!-- ä¸ªäººè¿›åº¦æ¡ -->
    <view class="progress-section" wx:if="{{userRole === 'participant'}}">
      <view class="progress-header">
        <text class="progress-label">æˆ‘çš„è¿›åº¦</text>
        <text class="progress-text">{{myEnrollment.check_ins_count || 0}}/{{eventInfo.days_count}}å¤©</text>
      </view>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{(myEnrollment.check_ins_count || 0) / eventInfo.days_count * 100}}%"></view>
      </view>
    </view>
  </view>

  <!-- æ´»åŠ¨æ“ä½œåŒº -->
  <view class="action-section" wx:if="{{eventInfo}}">

    <!-- æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸»è¦æ“ä½œå…¥å£ -->
    <view class="main-actions" wx:if="{{!loading}}">
      <!-- å‚ä¸è€…ï¼šè¿›å…¥å…±è¯»ä¸»é¡µ -->
      <view class="participant-main-action" wx:if="{{userRole === 'participant'}}">
        <button class="main-action-btn participant" bindtap="goToParticipatePage">
          <view class="main-action-content">
            <text class="main-action-icon">ğŸ“–</text>
            <text class="main-action-title">è¿›å…¥å…±è¯»ä¸»é¡µ</text>
            <text class="main-action-desc">æŸ¥çœ‹ä»Šæ—¥ä»»åŠ¡ã€æäº¤æ‰“å¡</text>
          </view>
          <text class="main-action-arrow">â†’</text>
        </button>
      </view>

      <!-- å›´è§‚è€…ï¼šæ˜¾ç¤ºåŠ å…¥å…±è¯»æŒ‰é’® -->
      <view class="observer-main-action" wx:if="{{userRole === 'observer'}}">
        <button class="main-action-btn primary" bindtap="enrollAsParticipant" wx:if="{{eventInfo.can_enroll}}">
          <view class="main-action-content">
            <text class="main-action-icon">ğŸ¯</text>
            <text class="main-action-title">åŠ å…¥å…±è¯»</text>
            <text class="main-action-desc">æ‰“å¡ã€é¢†è¯»ã€è·å¾—è¯ä¹¦</text>
          </view>
        </button>
        <button class="main-action-btn outline" bindtap="goToObservePage">
          <view class="main-action-content">
            <text class="main-action-icon">ğŸ‘€</text>
            <text class="main-action-title">å›´è§‚å­¦ä¹ </text>
            <text class="main-action-desc">æŸ¥çœ‹ç²¾é€‰å†…å®¹å’Œè®¨è®º</text>
          </view>
          <text class="main-action-arrow">â†’</text>
        </button>
      </view>

      <!-- æ¸¸å®¢ï¼šæ˜¾ç¤ºç™»å½•æç¤º -->
      <view class="guest-main-actions" wx:if="{{userRole === 'guest'}}">
        <view class="login-prompt">
          <text class="prompt-text">è¯·å…ˆç™»å½•ä»¥å‚ä¸æ´»åŠ¨</text>
          <button class="main-action-btn primary" bindtap="goToAuth">
            <view class="main-action-content">
              <text class="main-action-icon">ğŸ”</text>
              <text class="main-action-title">ç«‹å³ç™»å½•</text>
            </view>
          </button>
        </view>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œæŒ‰é’® -->
    <view class="quick-actions" wx:if="{{!loading}}">
      <!-- å‚ä¸è€…å¿«æ·æ“ä½œ -->
      <view class="participant-quick-actions" wx:if="{{userRole === 'participant'}}">
        <button class="quick-action-btn" bindtap="quickCheckIn">
          <text class="quick-action-icon">âœï¸</text>
          <text class="quick-action-text">å¿«é€Ÿæ‰“å¡</text>
        </button>
        <button class="quick-action-btn" bindtap="viewRanking">
          <text class="quick-action-icon">ğŸ†</text>
          <text class="quick-action-text">æ’è¡Œæ¦œ</text>
        </button>
        <button class="quick-action-btn" bindtap="giveFlowers">
          <text class="quick-action-icon">ğŸŒ¸</text>
          <text class="quick-action-text">é€å°çº¢èŠ±</text>
        </button>
      </view>

      <!-- å›´è§‚è€…å¿«æ·æ“ä½œ - ç®€åŒ–ç‰ˆ -->
      <view class="observer-quick-actions" wx:if="{{userRole === 'observer'}}">
        <button class="quick-action-btn" bindtap="viewFeaturedContent">
          <text class="quick-action-icon">â­</text>
          <text class="quick-action-text">ç²¾é€‰å†…å®¹</text>
        </button>
        <button class="quick-action-btn" bindtap="shareEvent">
          <text class="quick-action-icon">ğŸ“¤</text>
          <text class="quick-action-text">åˆ†äº«æ´»åŠ¨</text>
        </button>
      </view>
    </view>
  </view>

  <!-- æ‰“å¡ä½œä¸šå±•ç¤ºåŒºåŸŸ -->
  <view class="main-content-section simplified" wx:if="{{eventInfo}}">
    <view class="section-header simple">
      <!-- å·¦ä¾§ï¼šæ ‡é¢˜å’Œæ•°é‡å¾½ç«  -->
      <view class="section-left">
        <view class="section-title-large">
          <text class="title-text-large">æ‰“å¡ä½œä¸š</text>
          <view class="tab-badge large" wx:if="{{checkinsCount > 0}}">{{checkinsCount}}</view>
        </view>
      </view>

      <!-- å³ä¾§ï¼šç­›é€‰æ ‡ç­¾ -->
      <view class="filter-tabs right-aligned">
        <view
          class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}"
          bindtap="changeFilter"
          data-filter="all"
        >
          <text class="tab-text">å…¨éƒ¨</text>
        </view>
        <view
          class="filter-tab {{currentFilter === 'today' ? 'active' : ''}}"
          bindtap="changeFilter"
          data-filter="today"
        >
          <text class="tab-text">ä»Šæ—¥</text>
        </view>
        <view
          class="filter-tab {{currentFilter === 'calendar' ? 'active' : ''}}"
          bindtap="toggleCalendar"
        >
          <text class="tab-text">æ—¥å†</text>
        </view>
      </view>
    </view>

    <!-- æ—¥å†é€‰æ‹©å™¨ -->
    <view class="calendar-section mobile" wx:if="{{showCalendar}}">
      <view class="calendar-header mobile">
        <view class="calendar-nav-row">
          <view class="calendar-nav-left">
            <button class="calendar-nav-btn mobile prev-year" bindtap="changeYear" data-direction="-1">Â«</button>
            <button class="calendar-nav-btn mobile prev-month" bindtap="changeMonth" data-direction="-1">â€¹</button>
          </view>
          <view class="calendar-title-wrapper">
            <text class="calendar-title">{{currentYear}}å¹´{{currentMonth}}æœˆ</text>
            <button class="calendar-today-btn mobile" bindtap="goToToday">ä»Šæ—¥</button>
          </view>
          <view class="calendar-nav-right">
            <button class="calendar-nav-btn mobile next-month" bindtap="changeMonth" data-direction="1">â€º</button>
            <button class="calendar-nav-btn mobile next-year" bindtap="changeYear" data-direction="1">Â»</button>
          </view>
        </view>
      </view>
      <view class="calendar-weekdays mobile">
        <text class="weekday mobile">æ—¥</text>
        <text class="weekday mobile">ä¸€</text>
        <text class="weekday mobile">äºŒ</text>
        <text class="weekday mobile">ä¸‰</text>
        <text class="weekday mobile">å››</text>
        <text class="weekday mobile">äº”</text>
        <text class="weekday mobile">å…­</text>
      </view>
      <view class="calendar-days mobile">
        <view class="calendar-day mobile {{item.isToday ? 'today' : ''}} {{item.isSelected ? 'selected' : ''}} {{item.hasCheckins ? 'has-checkins' : ''}}"
          wx:for="{{calendarDays}}"
          wx:key="date"
          bindtap="selectDate"
          data-date="{{item.date}}"
        >
          <text class="day-number mobile">{{item.day}}</text>
          <view class="checkin-indicator mobile" wx:if="{{item.hasCheckins}}">
            <text class="indicator-dot"></text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ‰“å¡åˆ—è¡¨ - åªåœ¨æœ‰æ•°æ®ä¸”æ—¥å†æœªæ˜¾ç¤ºæ—¶å±•ç¤º -->
    <view class="checkins-list enhanced" wx:if="{{checkins.length > 0 && !showCalendar}}">
      <view class="checkin-card enhanced" wx:for="{{checkins}}" wx:key="id" bindtap="viewCheckinDetail" data-id="{{item.id}}">
        <!-- æ‰“å¡è€…ä¿¡æ¯ -->
        <view class="checkin-header enhanced">
          <image class="user-avatar enhanced" src="{{item.author.avatar_url}}" mode="aspectFill"></image>
          <view class="user-info enhanced">
            <text class="user-name">{{item.author.nickname}}</text>
            <text class="checkin-time">{{item.created_at_relative}}</text>
          </view>
          <view class="checkin-day enhanced">ç¬¬{{item.day_number}}å¤©</view>
        </view>

        <!-- æ‰“å¡å†…å®¹ -->
        <view class="checkin-content">
          <text class="checkin-text">{{item.content}}</text>

          <!-- æ‰“å¡å›¾ç‰‡ -->
          <view class="checkin-images" wx:if="{{item.images && item.images.length > 0}}">
            <image
              class="checkin-image"
              wx:for="{{item.images}}"
              wx:for-item="img"
              wx:key="*this"
              src="{{img}}"
              mode="aspectFill"
              bindtap="previewImage"
              data-urls="{{item.images}}"
              data-current="{{img}}"
            ></image>
          </view>
        </view>

        <!-- äº’åŠ¨æŒ‰é’® -->
        <view class="checkin-actions">
          <view class="action-item" bindtap="likeCheckin" data-id="{{item.id}}">
            <text class="action-icon {{item.is_liked ? 'liked' : ''}}">{{item.is_liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            <text class="action-count">{{item.likes_count}}</text>
          </view>
          <view class="action-item" bindtap="commentCheckin" data-id="{{item.id}}">
            <text class="action-icon">ğŸ’¬</text>
            <text class="action-count">{{item.comments_count}}</text>
          </view>
          <view class="action-item" bindtap="shareCheckin" data-id="{{item.id}}">
            <text class="action-icon">ğŸ“¤</text>
            <text class="action-count">åˆ†äº«</text>
          </view>
          <view class="action-item" bindtap="giveFlowerToCheckin" data-id="{{item.id}}" data-user-id="{{item.author.id}}">
            <text class="action-icon">ğŸŒ¸</text>
            <text class="action-count">é€èŠ±</text>
          </view>
        </view>

        <!-- è¯„è®ºåŒºåŸŸ -->
        <view class="comments-section" wx:if="{{item.comments && item.comments.length > 0}}">
          <view class="comment-item" wx:for="{{item.comments}}" wx:for-item="comment" wx:key="comment.id">
            <image class="comment-avatar" src="{{comment.author.avatar_url}}" mode="aspectFill"></image>
            <view class="comment-content">
              <view class="comment-header">
                <text class="comment-name">{{comment.author.nickname}}</text>
                <text class="comment-time">{{comment.created_at_relative}}</text>
              </view>
              <text class="comment-text">{{comment.content}}</text>
              <view class="comment-actions" wx:if="{{comment.author.id === userInfo.id}}">
                <text class="comment-action edit" bindtap="editComment" data-checkin-id="{{item.id}}" data-comment-id="{{comment.id}}" data-comment-index="{{index}}" data-content="{{comment.content}}">ç¼–è¾‘</text>
                <text class="comment-action delete" bindtap="deleteComment" data-checkin-id="{{item.id}}" data-comment-id="{{comment.id}}" data-comment-index="{{index}}">åˆ é™¤</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ - åªåœ¨éæ—¥å†æ¨¡å¼ä¸”æœ‰é€‰æ‹©æ—¶æ˜¾ç¤º -->
    <view class="empty-state simple" wx:if="{{checkins.length === 0 && !showCalendar}}">
      <text class="empty-emoji">ğŸ“</text>
      <text class="empty-text">{{currentFilter === 'calendar' && selectedDate ? selectedDate + ' æš‚æ— æ‰“å¡' : 'æš‚æ— æ‰“å¡ä½œä¸š'}}</text>
      <text class="empty-desc">{{currentFilter === 'calendar' && selectedDate ? 'é€‰æ‹©å…¶ä»–æ—¥æœŸæŸ¥çœ‹' : 'ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®å¼€å§‹æ‰“å¡'}}</text>
    </view>
  </view>

  
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && !eventInfo}}">
    <text class="empty-emoji">ğŸ“š</text>
    <text class="empty-text">æ´»åŠ¨ä¸å­˜åœ¨</text>
    <text class="empty-desc">è¯¥æ´»åŠ¨å¯èƒ½å·²è¢«åˆ é™¤æˆ–æ‚¨æ²¡æœ‰è®¿é—®æƒé™</text>
    <button class="btn btn-primary" bindtap="goBack">è¿”å›åˆ—è¡¨</button>
  </view>

  
  <!-- æ‚¬æµ®æ‰“å¡æŒ‰é’® - åœ†å½¢è®¾è®¡ï¼Œåªæ˜¾ç¤ºå›¾æ ‡ -->
  <view class="floating-checkin-btn round" wx:if="{{userInfo && !loading}}" bindtap="startCheckIn">
    <text class="floating-icon">âœï¸</text>
    <view class="floating-ripple"></view>
  </view>

  <!-- è¯„è®ºè¾“å…¥æ¨¡æ€æ¡† -->
  <view class="comment-modal" wx:if="{{showCommentModal}}" bindtap="hideCommentInput">
    <view class="comment-modal-content" catchtap="stopPropagation">
      <view class="comment-modal-header">
        <text class="comment-modal-title">å‘è¡¨è¯„è®º</text>
        <view class="comment-modal-close" bindtap="hideCommentInput">Ã—</view>
      </view>
      <view class="comment-modal-body">
        <textarea
          class="comment-textarea"
          placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."
          value="{{commentContent}}"
          bindinput="onCommentInput"
          maxlength="500"
        ></textarea>
      </view>
      <view class="comment-modal-footer">
        <button class="comment-btn cancel" bindtap="hideCommentInput">å–æ¶ˆ</button>
        <button class="comment-btn submit" bindtap="submitComment">å‘è¡¨</button>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘è¯„è®ºæ¨¡æ€æ¡† -->
  <view class="comment-modal" wx:if="{{showEditCommentModal}}" bindtap="hideEditCommentInput">
    <view class="comment-modal-content" catchtap="stopPropagation">
      <view class="comment-modal-header">
        <text class="comment-modal-title">ç¼–è¾‘è¯„è®º</text>
        <view class="comment-modal-close" bindtap="hideEditCommentInput">Ã—</view>
      </view>
      <view class="comment-modal-body">
        <textarea
          class="comment-textarea"
          placeholder="ä¿®æ”¹ä½ çš„è¯„è®º..."
          value="{{editCommentContent}}"
          bindinput="onEditCommentInput"
          maxlength="500"
        ></textarea>
      </view>
      <view class="comment-modal-footer">
        <button class="comment-btn cancel" bindtap="hideEditCommentInput">å–æ¶ˆ</button>
        <button class="comment-btn submit" bindtap="submitEditComment">ä¿å­˜</button>
      </view>
    </view>
  </view>

  </view>