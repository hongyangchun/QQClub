<!--pages/event/list.wxml-->
<view class="container page-container">
  <!-- ç­›é€‰æ  -->
  <view class="filter-bar">
    <view class="filter-tabs">
      <view
        class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}"
        bindtap="changeFilter"
        data-filter="all"
      >
        å…¨éƒ¨
      </view>
      <view
        class="filter-tab {{currentFilter === 'enrolling' ? 'active' : ''}}"
        bindtap="changeFilter"
        data-filter="enrolling"
      >
        æŠ¥åä¸­
      </view>
      <view
        class="filter-tab {{currentFilter === 'in_progress' ? 'active' : ''}}"
        bindtap="changeFilter"
        data-filter="in_progress"
      >
        è¿›è¡Œä¸­
      </view>
      <view
        class="filter-tab {{currentFilter === 'completed' ? 'active' : ''}}"
        bindtap="changeFilter"
        data-filter="completed"
      >
        å·²å®Œæˆ
      </view>
    </view>
    <view class="filter-sort" bindtap="showSortMenu">
      <text class="sort-text">{{sortText}}</text>
      <text class="sort-arrow">â–¼</text>
    </view>
  </view>

  <!-- æ´»åŠ¨åˆ—è¡¨ -->
  <view class="event-list" wx:if="{{events.length > 0}}">
    <view
      class="event-item card"
      wx:for="{{events}}"
      wx:key="id"
      bindtap="goToEventDetail"
      data-id="{{item.id}}"
    >
      <view class="card-body">
        <!-- æ´»åŠ¨çŠ¶æ€æ ‡ç­¾ -->
        <view class="event-status mb-2">
          <text class="tag {{item.approval_status === 'approved' ? 'tag-success' : item.approval_status === 'rejected' ? 'tag-error' : 'tag-secondary'}}">
            {{item.approval_status_text}}
          </text>
          <text class="tag tag-primary">{{item.status_text}}</text>
        </view>

        <!-- æ´»åŠ¨æ ‡é¢˜å’Œä¹¦ç± -->
        <view class="event-title text-medium mb-2">{{item.title}}</view>
        <view class="event-book text-small text-secondary mb-3">
          <text class="book-icon">ğŸ“–</text>
          <text>{{item.book_name}}</text>
        </view>

        <!-- æ´»åŠ¨ä¿¡æ¯ -->
        <view class="event-info-grid mb-3">
          <view class="info-item">
            <text class="info-icon">ğŸ“…</text>
            <text class="info-text">{{item.date_range}}</text>
          </view>
          <view class="info-item">
            <text class="info-icon">ğŸ‘¥</text>
            <text class="info-text">{{item.participants_count}}/{{item.max_participants}}äºº</text>
          </view>
          <view class="info-item">
            <text class="info-icon">ğŸ’°</text>
            <text class="info-text">ï¿¥{{item.enrollment_fee}}</text>
          </view>
          <view class="info-item">
            <text class="info-icon">ğŸ“†</text>
            <text class="info-text">{{item.days_count}}å¤©</text>
          </view>
        </view>

        <!-- æ´»åŠ¨æè¿° -->
        <view class="event-desc text-small text-secondary mb-3" wx:if="{{item.description}}">
          <text class="desc-text">{{item.description_preview}}</text>
        </view>

        <!-- æ´»åŠ¨ç»„ç»‡è€… -->
        <view class="event-leader flex items-center text-small text-hint">
          <image class="avatar avatar-small mr-2" src="{{item.leader.avatar_url}}" mode="aspectFill"></image>
          <text>ç»„ç»‡è€…ï¼š{{item.leader.nickname}}</text>
        </view>

        <!-- æ´»åŠ¨æ“ä½œæŒ‰é’® -->
        <view class="event-actions mt-3" wx:if="{{item.can_enroll || item.is_participant}}">
          <button
            class="btn btn-primary btn-small"
            bindtap="enrollEvent"
            data-id="{{item.id}}"
            catch:tap="true"
            wx:if="{{item.can_enroll}}"
          >
            ç«‹å³æŠ¥å
          </button>
          <view class="btn btn-success btn-small" wx:if="{{item.is_participant}}">
            å·²æŠ¥å
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty" wx:if="{{!loading && events.length === 0}}">
    <view class="empty-icon">ğŸ“š</view>
    <view class="empty-text">æš‚æ— æ´»åŠ¨</view>
    <view class="empty-desc">è¿˜æ²¡æœ‰ç›¸å…³æ´»åŠ¨ï¼Œå¿«æ¥åˆ›å»ºä¸€ä¸ªå§ï¼</view>
    <button class="btn btn-primary mt-4" bindtap="goToCreateEvent">åˆ›å»ºæ´»åŠ¨</button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view class="load-more" wx:if="{{hasMore && !loading}}">
    <button class="btn btn-outline btn-block" bindtap="loadMore">åŠ è½½æ›´å¤š</button>
  </view>

  <!-- æ²¡æœ‰æ›´å¤š -->
  <view class="no-more" wx:if="{{!hasMore && events.length > 0}}">
    <text class="text-small text-hint">æ²¡æœ‰æ›´å¤šæ´»åŠ¨äº†</text>
  </view>
</view>

<!-- æ’åºèœå• -->
<view class="sort-modal" wx:if="{{showSortModal}}" bindtap="hideSortMenu">
  <view class="sort-content" catchtap="stopPropagation">
    <view class="sort-header">
      <view class="sort-title">æ’åºæ–¹å¼</view>
      <view class="sort-close" bindtap="hideSortMenu">Ã—</view>
    </view>
    <view class="sort-options">
      <view
        class="sort-option {{currentSort === 'created_at_desc' ? 'active' : ''}}"
        bindtap="changeSort"
        data-sort="created_at_desc"
      >
        <text>æœ€æ–°åˆ›å»º</text>
        <text class="check" wx:if="{{currentSort === 'created_at_desc'}}">âœ“</text>
      </view>
      <view
        class="sort-option {{currentSort === 'start_date_asc' ? 'active' : ''}}"
        bindtap="changeSort"
        data-sort="start_date_asc"
      >
        <text>å¼€å§‹æ—¶é—´</text>
        <text class="check" wx:if="{{currentSort === 'start_date_asc'}}">âœ“</text>
      </view>
      <view
        class="sort-option {{currentSort === 'participants_desc' ? 'active' : ''}}"
        bindtap="changeSort"
        data-sort="participants_desc"
      >
        <text>å‚ä¸äººæ•°</text>
        <text class="check" wx:if="{{currentSort === 'participants_desc'}}">âœ“</text>
      </view>
      <view
        class="sort-option {{currentSort === 'enrollment_fee_asc' ? 'active' : ''}}"
        bindtap="changeSort"
        data-sort="enrollment_fee_asc"
      >
        <text>è´¹ç”¨æœ€ä½</text>
        <text class="check" wx:if="{{currentSort === 'enrollment_fee_asc'}}">âœ“</text>
      </view>
    </view>
  </view>
</view>

<!-- æµ®åŠ¨åˆ›å»ºæŒ‰é’® -->
<view class="fab" bindtap="goToCreateEvent" wx:if="{{userInfo}}">
  <text>+</text>
</view>