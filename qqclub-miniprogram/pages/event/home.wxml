<!--pages/event/detail.wxml-->
<view class="container page-container">
  <!-- æ´»åŠ¨å¤´éƒ¨ä¿¡æ¯ - é‡æ–°è®¾è®¡çš„ç°ä»£åŒ–banner -->
  <view class="event-hero-modern" wx:if="{{eventInfo}}">
    <view class="hero-background-modern"></view>
    <view class="hero-content-modern">
      <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
      <view class="hero-main">
        <view class="event-banner-layout">
          <!-- å·¦ä¾§ï¼šä¹¦ç±å°é¢ -->
          <view class="book-cover-section">
            <image
              class="book-cover-main"
              src="{{eventInfo.book_cover_image || 'https://picsum.photos/120/160?random=book'}}"
              mode="aspectFill"
              binderror="handleBookCoverError"
            ></image>
            <view class="book-cover-shine"></view>
          </view>

          <!-- ä¸­é—´ï¼šæ´»åŠ¨ä¿¡æ¯ -->
          <view class="event-info-section">
            <view class="event-title-main">{{eventInfo.title}}</view>
            <view class="event-book-name">{{eventInfo.book_name}}</view>
            <view class="event-meta-row">
              <view class="meta-badge status-{{eventInfo.status}}">{{getEventStatusText(eventInfo.status)}}</view>
              <text class="meta-text">{{eventInfo.participants_count || 0}}äººå‚ä¸</text>
              <text class="meta-divider">Â·</text>
              <text class="meta-text">{{getDaysLeft(eventInfo)}}</text>
            </view>
          </view>

          <!-- å³ä¾§ï¼šå¯¼èˆªæŒ‰é’® -->
          <view class="nav-buttons-section">
            <view class="nav-button-modern" bindtap="goToActivityInfo">
              <text class="nav-icon">â„¹ï¸</text>
            </view>
            <view class="nav-button-modern" bindtap="goToStatistics">
              <text class="nav-icon">ğŸ“Š</text>
            </view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨è£…é¥° -->
      <view class="hero-decoration">
        <view class="decoration-wave"></view>
      </view>
    </view>
  </view>

  
  <!-- æ‰“å¡ä½œä¸šå±•ç¤ºåŒºåŸŸ -->
  <view class="main-content-section simplified" wx:if="{{eventInfo}}">
    <view class="section-header simple">
      <!-- å·¦ä¾§ï¼šæ ‡é¢˜å’Œæ•°é‡å¾½ç«  -->
      <view class="section-left">
        <view class="section-title-large">
          <text class="title-text-large">æ‰“å¡ä½œä¸š</text>
          <view class="tab-badge large" wx:if="{{checkinsCount > 0}}">{{checkinsCount}}</view>
        </view>
      </view>

      <!-- å³ä¾§ï¼šç­›é€‰æ ‡ç­¾ -->
      <view class="filter-tabs right-aligned">
        <view
          class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}"
          bindtap="changeFilter"
          data-filter="all"
        >
          <text class="tab-text">å…¨éƒ¨</text>
        </view>
        <view
          class="filter-tab {{currentFilter === 'today' ? 'active' : ''}}"
          bindtap="changeFilter"
          data-filter="today"
        >
          <text class="tab-text">ä»Šæ—¥</text>
        </view>
        <view
          class="filter-tab {{currentFilter === 'calendar' ? 'active' : ''}}"
          bindtap="toggleCalendar"
        >
          <text class="tab-text">æ—¥å†</text>
        </view>
      </view>
    </view>

    <!-- æ—¥å†é€‰æ‹©å™¨ -->
    <view class="calendar-section mobile" wx:if="{{showCalendar}}">
      <view class="calendar-header mobile">
        <view class="calendar-nav-row">
          <view class="calendar-nav-left">
            <button class="calendar-nav-btn mobile prev-year" bindtap="changeYear" data-direction="-1">Â«</button>
            <button class="calendar-nav-btn mobile prev-month" bindtap="changeMonth" data-direction="-1">â€¹</button>
          </view>
          <view class="calendar-title-wrapper">
            <text class="calendar-title">{{currentYear}}å¹´{{currentMonth}}æœˆ</text>
            <button class="calendar-today-btn mobile" bindtap="goToToday">ä»Šæ—¥</button>
          </view>
          <view class="calendar-nav-right">
            <button class="calendar-nav-btn mobile next-month" bindtap="changeMonth" data-direction="1">â€º</button>
            <button class="calendar-nav-btn mobile next-year" bindtap="changeYear" data-direction="1">Â»</button>
          </view>
        </view>
      </view>
      <view class="calendar-weekdays mobile">
        <text class="weekday mobile">æ—¥</text>
        <text class="weekday mobile">ä¸€</text>
        <text class="weekday mobile">äºŒ</text>
        <text class="weekday mobile">ä¸‰</text>
        <text class="weekday mobile">å››</text>
        <text class="weekday mobile">äº”</text>
        <text class="weekday mobile">å…­</text>
      </view>
      <view class="calendar-days mobile">
        <view class="calendar-day mobile {{item.isToday ? 'today' : ''}} {{item.isSelected ? 'selected' : ''}} {{item.hasCheckins ? 'has-checkins' : ''}}"
          wx:for="{{calendarDays}}"
          wx:key="date"
          bindtap="selectDate"
          data-date="{{item.date}}"
        >
          <text class="day-number mobile">{{item.day}}</text>
          <view class="checkin-indicator mobile" wx:if="{{item.hasCheckins}}">
            <text class="indicator-dot"></text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ‰“å¡åˆ—è¡¨ - åªåœ¨æœ‰æ•°æ®ä¸”æ—¥å†æœªæ˜¾ç¤ºæ—¶å±•ç¤º -->
    <view class="checkins-list enhanced" wx:if="{{checkins.length > 0 && !showCalendar}}">
      <view class="checkin-card enhanced" wx:for="{{checkins}}" wx:key="id" bindtap="viewCheckinDetail" data-id="{{item.id}}">
        <!-- æ‰“å¡è€…ä¿¡æ¯ -->
        <view class="checkin-header enhanced">
          <image class="user-avatar enhanced" src="{{item.author.avatar_url}}" mode="aspectFill"></image>
          <view class="user-info enhanced">
            <text class="user-name">{{item.author.nickname}}</text>
            <text class="checkin-time">{{item.created_at_relative}}</text>
          </view>
          <view class="checkin-day enhanced">ç¬¬{{item.day_number}}å¤©</view>
        </view>

        <!-- æ‰“å¡å†…å®¹ -->
        <view class="checkin-content">
          <text class="checkin-text">{{item.content}}</text>

          <!-- æ‰“å¡å›¾ç‰‡ -->
          <view class="checkin-images" wx:if="{{item.images && item.images.length > 0}}">
            <image
              class="checkin-image"
              wx:for="{{item.images}}"
              wx:for-item="img"
              wx:key="*this"
              src="{{img}}"
              mode="aspectFill"
              bindtap="previewImage"
              data-urls="{{item.images}}"
              data-current="{{img}}"
            ></image>
          </view>
        </view>

        <!-- äº’åŠ¨æŒ‰é’® -->
        <view class="checkin-actions">
          <view class="action-item" bindtap="likeCheckin" data-id="{{item.id}}">
            <text class="action-icon {{item.is_liked ? 'liked' : ''}}">{{item.is_liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            <text class="action-count">{{item.likes_count}}</text>
          </view>
          <view class="action-item" bindtap="commentCheckin" data-id="{{item.id}}">
            <text class="action-icon">ğŸ’¬</text>
            <text class="action-count">{{item.comments_count}}</text>
          </view>
          <view class="action-item" bindtap="shareCheckin" data-id="{{item.id}}">
            <text class="action-icon">ğŸ“¤</text>
            <text class="action-count">åˆ†äº«</text>
          </view>
          <view class="action-item" bindtap="giveFlowerToCheckin" data-id="{{item.id}}" data-user-id="{{item.author.id}}">
            <text class="action-icon">ğŸŒ¸</text>
            <text class="action-count">é€èŠ±</text>
          </view>
        </view>

        <!-- è¯„è®ºåŒºåŸŸ -->
        <view class="comments-section" wx:if="{{item.comments && item.comments.length > 0}}">
          <view class="comment-item" wx:for="{{item.comments}}" wx:for-item="comment" wx:key="comment.id">
            <image class="comment-avatar" src="{{comment.author.avatar_url}}" mode="aspectFill"></image>
            <view class="comment-content">
              <view class="comment-header">
                <text class="comment-name">{{comment.author.nickname}}</text>
                <text class="comment-time">{{comment.created_at_relative}}</text>
              </view>
              <text class="comment-text">{{comment.content}}</text>
              <view class="comment-actions" wx:if="{{comment.author.id === userInfo.id}}">
                <text class="comment-action edit" bindtap="editComment" data-checkin-id="{{item.id}}" data-comment-id="{{comment.id}}" data-comment-index="{{index}}" data-content="{{comment.content}}">ç¼–è¾‘</text>
                <text class="comment-action delete" bindtap="deleteComment" data-checkin-id="{{item.id}}" data-comment-id="{{comment.id}}" data-comment-index="{{index}}">åˆ é™¤</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ - åªåœ¨éæ—¥å†æ¨¡å¼ä¸”æœ‰é€‰æ‹©æ—¶æ˜¾ç¤º -->
    <view class="empty-state simple" wx:if="{{checkins.length === 0 && !showCalendar}}">
      <text class="empty-emoji">ğŸ“</text>
      <text class="empty-text">{{currentFilter === 'calendar' && selectedDate ? selectedDate + ' æš‚æ— æ‰“å¡' : 'æš‚æ— æ‰“å¡ä½œä¸š'}}</text>
      <text class="empty-desc">{{currentFilter === 'calendar' && selectedDate ? 'é€‰æ‹©å…¶ä»–æ—¥æœŸæŸ¥çœ‹' : 'ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®å¼€å§‹æ‰“å¡'}}</text>
    </view>
  </view>

  
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && !eventInfo}}">
    <text class="empty-emoji">ğŸ“š</text>
    <text class="empty-text">æ´»åŠ¨ä¸å­˜åœ¨</text>
    <text class="empty-desc">è¯¥æ´»åŠ¨å¯èƒ½å·²è¢«åˆ é™¤æˆ–æ‚¨æ²¡æœ‰è®¿é—®æƒé™</text>
    <button class="btn btn-primary" bindtap="goBack">è¿”å›åˆ—è¡¨</button>
  </view>

  
  <!-- æ™ºèƒ½æ‚¬æµ®æŒ‰é’® - æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒåŠŸèƒ½ -->
  <view class="floating-checkin-btn smart" wx:if="{{userInfo && !loading}}" bindtap="handleFloatingAction">
    <text class="floating-text">{{userRole === 'participant' ? 'å»æ‰“å¡' : 'å»æŠ¥å'}}</text>
    <view class="floating-ripple"></view>
  </view>

  <!-- è¯„è®ºè¾“å…¥æ¨¡æ€æ¡† -->
  <view class="comment-modal" wx:if="{{showCommentModal}}" bindtap="hideCommentInput">
    <view class="comment-modal-content" catchtap="stopPropagation">
      <view class="comment-modal-header">
        <text class="comment-modal-title">å‘è¡¨è¯„è®º</text>
        <view class="comment-modal-close" bindtap="hideCommentInput">Ã—</view>
      </view>
      <view class="comment-modal-body">
        <textarea
          class="comment-textarea"
          placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."
          value="{{commentContent}}"
          bindinput="onCommentInput"
          maxlength="500"
        ></textarea>
      </view>
      <view class="comment-modal-footer">
        <button class="comment-btn cancel" bindtap="hideCommentInput">å–æ¶ˆ</button>
        <button class="comment-btn submit" bindtap="submitComment">å‘è¡¨</button>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘è¯„è®ºæ¨¡æ€æ¡† -->
  <view class="comment-modal" wx:if="{{showEditCommentModal}}" bindtap="hideEditCommentInput">
    <view class="comment-modal-content" catchtap="stopPropagation">
      <view class="comment-modal-header">
        <text class="comment-modal-title">ç¼–è¾‘è¯„è®º</text>
        <view class="comment-modal-close" bindtap="hideEditCommentInput">Ã—</view>
      </view>
      <view class="comment-modal-body">
        <textarea
          class="comment-textarea"
          placeholder="ä¿®æ”¹ä½ çš„è¯„è®º..."
          value="{{editCommentContent}}"
          bindinput="onEditCommentInput"
          maxlength="500"
        ></textarea>
      </view>
      <view class="comment-modal-footer">
        <button class="comment-btn cancel" bindtap="hideEditCommentInput">å–æ¶ˆ</button>
        <button class="comment-btn submit" bindtap="submitEditComment">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- æŠ¥åè§„åˆ™ç¡®è®¤å¼¹çª— -->
  <view class="rule-confirm-modal" wx:if="{{showRuleConfirmModal}}" bindtap="hideRuleConfirmModal">
    <view class="rule-confirm-content" catchtap="stopPropagation">
      <view class="rule-confirm-header">
        <text class="rule-confirm-title">æ´»åŠ¨å‚ä¸è§„åˆ™</text>
        <view class="rule-confirm-close" bindtap="hideRuleConfirmModal">Ã—</view>
      </view>
      <view class="rule-confirm-body">
        <view class="rule-section">
          <text class="rule-title">ğŸ“š æ´»åŠ¨è¦æ±‚</text>
          <text class="rule-text">â€¢ æ¯æ—¥æŒ‰æ—¶å®Œæˆé˜…è¯»ä»»åŠ¡å¹¶æäº¤æ‰“å¡</text>
          <text class="rule-text">â€¢ æ‰“å¡å†…å®¹éœ€å›´ç»•å½“æ—¥å­¦ä¹ ä¸»é¢˜</text>
          <text class="rule-text">â€¢ ç§¯æå‚ä¸è®¨è®ºï¼Œè¥é€ è‰¯å¥½å­¦ä¹ æ°›å›´</text>
        </view>
        <view class="rule-section">
          <text class="rule-title">âœï¸ æ‰“å¡è§„åˆ™</text>
          <text class="rule-text">â€¢ æ¯æ—¥æ‰“å¡æ—¶é—´ï¼š{{eventInfo.checkin_deadline || '23:59' }}å‰</text>
          <text class="rule-text">â€¢ æœ€ä½å®Œæˆæ ‡å‡†ï¼š{{eventInfo.completion_standard || 80}}%</text>
          <text class="rule-text">â€¢ è¿ç»­æ‰“å¡3å¤©æœªå®Œæˆå°†è‡ªåŠ¨é€€å‡ºæ´»åŠ¨</text>
        </view>
        <view class="rule-section">
          <text class="rule-title">ğŸ† å®Œæˆå¥–åŠ±</text>
          <text class="rule-text">â€¢ å®Œæˆå…¨éƒ¨æ‰“å¡è·å¾—å‚ä¸è¯ä¹¦</text>
          <text class="rule-text">â€¢ ä¼˜ç§€æ‰“å¡å¯è·å¾—å°çº¢èŠ±å¥–åŠ±</text>
          <text class="rule-text">â€¢ ç§¯æå‚ä¸è€…æœ‰æœºä¼šæˆä¸ºä¸‹æœŸé¢†è¯»äºº</text>
        </view>
      </view>
      <view class="rule-confirm-footer">
        <button class="rule-confirm-btn cancel" bindtap="hideRuleConfirmModal">æˆ‘å†æƒ³æƒ³</button>
        <button class="rule-confirm-btn confirm" bindtap="confirmJoinActivity">ç¡®è®¤å‚åŠ </button>
      </view>
    </view>
  </view>

  </view>