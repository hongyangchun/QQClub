<!--pages/event/stats.wxml-->
<view class="container page-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-nav">
      <view class="nav-btn" bindtap="goBack">
        <text class="nav-icon">â€¹</text>
      </view>
      <view class="nav-title">æ´»åŠ¨æ•°æ®ç»Ÿè®¡</view>
      <view class="nav-btn" bindtap="shareStats">
        <text class="nav-icon">ğŸ“¤</text>
      </view>
    </view>
  </view>

  <!-- æ´»åŠ¨æ¦‚è§ˆå¡ç‰‡ -->
  <view class="overview-section" wx:if="{{eventInfo}}">
    <view class="overview-card">
      <view class="event-basic">
        <view class="event-title">{{eventInfo.title}}</view>
        <view class="event-subtitle">{{eventInfo.book_name}}</view>
        <view class="event-status {{eventInfo.status}}">
          <text class="status-icon">{{eventInfo.status_icon}}</text>
          <text class="status-text">{{eventInfo.status_text}}</text>
        </view>
      </view>

      <view class="progress-overview">
        <view class="progress-circle">
          <view class="circle-progress">
            <view class="progress-value">{{overallProgress}}%</view>
            <view class="progress-label">æ€»ä½“è¿›åº¦</view>
          </view>
        </view>
        <view class="progress-info">
          <view class="progress-item">
            <text class="progress-label">æ´»åŠ¨å¤©æ•°</text>
            <text class="progress-value">{{eventInfo.days_count}}å¤©</text>
          </view>
          <view class="progress-item">
            <text class="progress-label">å·²è¿›è¡Œ</text>
            <text class="progress-value">{{eventInfo.days_passed}}å¤©</text>
          </view>
          <view class="progress-item">
            <text class="progress-label">å‰©ä½™</text>
            <text class="progress-value">{{eventInfo.days_left}}å¤©</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å‚ä¸ç»Ÿè®¡ -->
  <view class="stats-section">
    <view class="section-header">
      <text class="section-title">å‚ä¸ç»Ÿè®¡</text>
      <text class="section-subtitle">å®æ—¶æ›´æ–°</text>
    </view>

    <view class="stats-grid">
      <view class="stat-card primary">
        <view class="stat-icon">ğŸ‘¥</view>
        <view class="stat-content">
          <view class="stat-number">{{eventInfo.participants_count}}</view>
          <view class="stat-label">å‚ä¸äººæ•°</view>
        </view>
      </view>

      <view class="stat-card success">
        <view class="stat-icon">âœ…</view>
        <view class="stat-content">
          <view class="stat-number">{{completedTodayCount}}</view>
          <view class="stat-label">ä»Šæ—¥å®Œæˆ</view>
        </view>
      </view>

      <view class="stat-card warning">
        <view class="stat-icon">â°</view>
        <view class="stat-content">
          <view class="stat-number">{{pendingTodayCount}}</view>
          <view class="stat-label">å¾…å®Œæˆ</view>
        </view>
      </view>

      <view class="stat-card info">
        <view class="stat-icon">ğŸ‘ï¸</view>
        <view class="stat-content">
          <view class="stat-number">{{observersCount}}</view>
          <view class="stat-label">å›´è§‚äººæ•°</view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ‰“å¡ç»Ÿè®¡ -->
  <view class="stats-section">
    <view class="section-header">
      <text class="section-title">æ‰“å¡ç»Ÿè®¡</text>
      <view class="time-filter">
        <view class="filter-tab {{timeFilter === 'week' ? 'active' : ''}}" bindtap="switchTimeFilter" data-filter="week">
          æœ¬å‘¨
        </view>
        <view class="filter-tab {{timeFilter === 'month' ? 'active' : ''}}" bindtap="switchTimeFilter" data-filter="month">
          æœ¬æœˆ
        </view>
        <view class="filter-tab {{timeFilter === 'all' ? 'active' : ''}}" bindtap="switchTimeFilter" data-filter="all">
          å…¨éƒ¨
        </view>
      </view>
    </view>

    <view class="checkin-stats">
      <view class="chart-container">
        <view class="chart-title">æ¯æ—¥æ‰“å¡è¶‹åŠ¿</view>
        <view class="chart-content">
          <!-- æ¨¡æ‹Ÿå›¾è¡¨ -->
          <view class="mock-chart">
            <view class="chart-bars">
              <view class="bar-item" wx:for="{{dailyStats}}" wx:key="date">
                <view class="bar" style="height: {{item.height}}rpx; background: {{item.color}};"></view>
                <view class="bar-label">{{item.label}}</view>
                <view class="bar-value">{{item.count}}</view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ‰“å¡æ’è¡Œæ¦œ -->
    <view class="ranking-section">
      <view class="ranking-header">
        <text class="ranking-title">æ‰“å¡æ’è¡Œæ¦œ</text>
        <text class="ranking-subtitle">å‰10å</text>
      </view>

      <view class="ranking-list">
        <view class="ranking-item {{item.rank <= 3 ? 'top-ranked' : ''}}" wx:for="{{topParticipants}}" wx:key="id">
          <view class="rank-badge">
            <text class="rank-number">{{item.rank}}</text>
            <text class="rank-medal" wx:if="{{item.rank <= 3}}">{{item.medal}}</text>
          </view>

          <image class="user-avatar" src="{{item.avatar_url}}" mode="aspectFill"></image>
          <view class="user-info">
            <view class="user-name">{{item.nickname}}</view>
            <view class="user-stats">
              <text class="stat-text">æ‰“å¡{{item.checkins_count}}æ¬¡</text>
              <text class="stat-divider">Â·</text>
              <text class="stat-text">æ´»è·ƒåº¦{{item.activity_score}}%</text>
            </view>
          </view>

          <view class="achievement-badge" wx:if="{{item.streak > 0}}">
            <text class="streak-text">è¿ç»­{{item.streak}}å¤©</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ´»è·ƒåº¦åˆ†æ -->
  <view class="stats-section">
    <view class="section-header">
      <text class="section-title">æ´»è·ƒåº¦åˆ†æ</text>
      <text class="section-subtitle">åŸºäºæœ€è¿‘7å¤©æ•°æ®</text>
    </view>

    <view class="activity-analysis">
      <view class="analysis-cards">
        <view class="analysis-card">
          <view class="analysis-icon">ğŸ”¥</view>
          <view class="analysis-content">
            <view class="analysis-value">{{averageCheckins}}æ¬¡</view>
            <view class="analysis-label">æ—¥å‡æ‰“å¡</view>
          </view>
        </view>

        <view class="analysis-card">
          <view class="analysis-icon">ğŸ“ˆ</view>
          <view class="analysis-content">
            <view class="analysis-value">{{completionRate}}%</view>
            <view class="analysis-label">å®Œæˆç‡</view>
          </view>
        </view>

        <view class="analysis-card">
          <view class="analysis-icon">ğŸ’ª</view>
          <view class="analysis-content">
            <view class="analysis-value">{{activeUsers}}äºº</view>
            <view class="analysis-label">æ´»è·ƒç”¨æˆ·</view>
          </view>
        </view>
      </view>

      <view class="activity-heatmap">
        <view class="heatmap-title">æ´»è·ƒåº¦çƒ­åŠ›å›¾</view>
        <view class="heatmap-grid">
          <view class="heatmap-cell" wx:for="{{heatmapData}}" wx:key="date"
                style="background: {{item.color}};"
                bindtap="showHeatmapDetail"
                data-date="{{item.date}}">
            <view class="cell-tooltip">{{item.count}}æ¬¡æ‰“å¡</view>
          </view>
        </view>
        <view class="heatmap-legend">
          <text class="legend-text">å°‘</text>
          <view class="legend-colors">
            <view class="legend-color" style="background: rgba(79, 70, 229, 0.1);"></view>
            <view class="legend-color" style="background: rgba(79, 70, 229, 0.3);"></view>
            <view class="legend-color" style="background: rgba(79, 70, 229, 0.5);"></view>
            <view class="legend-color" style="background: rgba(79, 70, 229, 0.7);"></view>
            <view class="legend-color" style="background: rgba(79, 70, 229, 0.9);"></view>
          </view>
          <text class="legend-text">å¤š</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && !eventInfo}}">
    <text class="empty-emoji">ğŸ“Š</text>
    <text class="empty-text">æš‚æ— ç»Ÿè®¡æ•°æ®</text>
    <text class="empty-desc">æ´»åŠ¨å¯èƒ½å°šæœªå¼€å§‹æˆ–å·²ç»“æŸ</text>
    <button class="btn btn-primary" bindtap="goBack">è¿”å›</button>
  </view>
</view>