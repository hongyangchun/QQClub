<!--pages/forum/detail.wxml-->
<view class="container page-container">
  <!-- å¸–å­å¤´éƒ¨ -->
  <view class="post-header" wx:if="{{postInfo}}">
    <view class="header-nav">
      <view class="nav-btn" bindtap="goBack">
        <text class="nav-icon">â€¹</text>
      </view>
      <view class="nav-title">å¸–å­è¯¦æƒ…</view>
      <view class="nav-btn" bindtap="showMoreActions">
        <text class="nav-icon">â‹¯</text>
      </view>
    </view>
  </view>

  <!-- å¸–å­å†…å®¹ -->
  <view class="post-content" wx:if="{{postInfo}}">
    <!-- å¸–å­ä¿¡æ¯ -->
    <view class="post-info-card">
      <view class="post-category-badge">
        <text class="category-icon">{{postInfo.category_icon}}</text>
        <text class="category-name">{{postInfo.category_name}}</text>
      </view>

      <view class="post-title">{{postInfo.title}}</view>

      <view class="post-meta">
        <view class="author-info">
          <image class="author-avatar" src="{{postInfo.author.avatar_url}}" mode="aspectFill"></image>
          <view class="author-details">
            <view class="author-name">
              <text>{{postInfo.author.nickname}}</text>
              <text class="author-badge" wx:if="{{postInfo.author.badge}}">{{postInfo.author.badge}}</text>
            </view>
            <view class="post-time">{{postInfo.created_at}}</view>
          </view>
        </view>

        <view class="post-stats">
          <view class="stat-item">
            <text class="stat-icon">ğŸ‘ï¸</text>
            <text class="stat-text">{{postInfo.views_count}}</text>
          </view>
          <view class="stat-item">
            <text class="stat-icon">ğŸ’¬</text>
            <text class="stat-text">{{postInfo.comments_count}}</text>
          </view>
        </view>
      </view>

      <!-- å¸–å­æ ‡ç­¾ -->
      <view class="post-tags" wx:if="{{postInfo.tags && postInfo.tags.length > 0}}">
        <view class="tag-item" wx:for="{{postInfo.tags}}" wx:key="index">
          <text class="tag-text">#{{item}}</text>
        </view>
      </view>
    </view>

    <!-- å¸–å­æ­£æ–‡ -->
    <view class="post-body">
      <text class="post-text">{{postInfo.content}}</text>

      <!-- å¸–å­å›¾ç‰‡ -->
      <view class="post-images" wx:if="{{postInfo.images && postInfo.images.length > 0}}">
        <view class="image-grid grid-{{postInfo.images.length}}">
          <image class="post-image" wx:for="{{postInfo.images}}" wx:for-item="image" wx:key="index"
                 src="{{image}}" mode="aspectFill"
                 bindtap="previewImage"
                 data-urls="{{postInfo.images}}"
                 data-current="{{image}}">
          </image>
        </view>
      </view>
    </view>

    <!-- å¸–å­æ“ä½œæ  -->
    <view class="post-actions">
      <view class="action-item {{postInfo.is_liked ? 'liked' : ''}}" bindtap="likePost">
        <text class="action-icon">{{postInfo.is_liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        <text class="action-text">{{postInfo.likes_count}}</text>
      </view>

      <view class="action-item" bindtap="focusCommentInput">
        <text class="action-icon">ğŸ’¬</text>
        <text class="action-text">è¯„è®º</text>
      </view>

      <view class="action-item" bindtap="collectPost" wx:if="{{!postInfo.is_collected}}">
        <text class="action-icon">â­</text>
        <text class="action-text">æ”¶è—</text>
      </view>

      <view class="action-item collected" bindtap="uncollectPost" wx:if="{{postInfo.is_collected}}">
        <text class="action-icon">â­</text>
        <text class="action-text">å·²æ”¶è—</text>
      </view>

      <view class="action-item" bindtap="sharePost">
        <text class="action-icon">ğŸ“¤</text>
        <text class="action-text">åˆ†äº«</text>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºåŒº -->
  <view class="comments-section" wx:if="{{postInfo}}">
    <view class="comments-header">
      <text class="comments-title">è¯„è®º ({{comments.length}})</text>
      <view class="sort-options">
        <text class="sort-text {{commentSort === 'newest' ? 'active' : ''}}" bindtap="sortComments" data-sort="newest">æœ€æ–°</text>
        <text class="sort-divider">Â·</text>
        <text class="sort-text {{commentSort === 'hottest' ? 'active' : ''}}" bindtap="sortComments" data-sort="hottest">æœ€çƒ­</text>
      </view>
    </view>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <view class="comments-list" wx:if="{{comments.length > 0}}">
      <view class="comment-item" wx:for="{{comments}}" wx:key="id">
        <image class="comment-avatar" src="{{item.author.avatar_url}}" mode="aspectFill"></image>

        <view class="comment-content">
          <view class="comment-header">
            <view class="comment-author">
              <text class="author-name">{{item.author.nickname}}</text>
              <text class="author-badge" wx:if="{{item.author.badge}}">{{item.author.badge}}</text>
              <text class="floor-number">#{{item.floor}}</text>
            </view>
            <text class="comment-time">{{item.created_at}}</text>
          </view>

          <text class="comment-text">{{item.content}}</text>

          <!-- è¯„è®ºå›¾ç‰‡ -->
          <view class="comment-images" wx:if="{{item.images && item.images.length > 0}}">
            <image class="comment-image" wx:for="{{item.images}}" wx:for-item="image" wx:key="index"
                   src="{{image}}" mode="aspectFill"
                   bindtap="previewImage"
                   data-urls="{{item.images}}"
                   data-current="{{image}}">
            </image>
          </view>

          <!-- å›å¤åˆ—è¡¨ -->
          <view class="replies-section" wx:if="{{item.replies && item.replies.length > 0}}">
            <view class="reply-item" wx:for="{{item.replies}}" wx:for-item="reply" wx:key="id">
              <text class="reply-author">{{reply.author.nickname}}</text>
              <text class="reply-text">å›å¤</text>
              <text class="reply-target">@{{reply.target_name}}</text>
              <text class="reply-content">: {{reply.content}}</text>
            </view>

            <view class="view-more-replies" wx:if="{{item.replies_count > item.replies.length}}" bindtap="loadMoreReplies" data-comment-id="{{item.id}}">
              <text class="more-text">æŸ¥çœ‹æ›´å¤š{{item.replies_count - item.replies.length}}æ¡å›å¤</text>
            </view>
          </view>

          <!-- è¯„è®ºæ“ä½œ -->
          <view class="comment-actions">
            <view class="comment-action {{item.is_liked ? 'liked' : ''}}" bindtap="likeComment" data-id="{{item.id}}">
              <text class="action-icon">{{item.is_liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
              <text class="action-count">{{item.likes_count}}</text>
            </view>

            <view class="comment-action" bindtap="replyToComment" data-comment="{{item}}">
              <text class="action-icon">ğŸ’¬</text>
              <text class="action-text">å›å¤</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºè¯„è®ºçŠ¶æ€ -->
    <view class="empty-comments" wx:if="{{comments.length === 0}}">
      <text class="empty-emoji">ğŸ’¬</text>
      <text class="empty-text">æš‚æ— è¯„è®º</text>
      <text class="empty-desc">æ¥å‘è¡¨ç¬¬ä¸€ä¸ªè¯„è®ºå§ï¼</text>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMoreComments}}" bindtap="loadMoreComments">
      <text class="load-text">{{loadingComments ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤šè¯„è®º'}}</text>
    </view>
  </view>

  <!-- è¯„è®ºè¾“å…¥æ¡† -->
  <view class="comment-input-container {{showCommentInput ? 'show' : ''}}" wx:if="{{postInfo}}">
    <view class="comment-input-wrapper">
      <input class="comment-input"
             placeholder="{{replyingTo ? 'å›å¤ @' + replyingTo.author.nickname : 'å‘è¡¨è¯„è®º...'}}"
             value="{{commentText}}"
             bindinput="onCommentInput"
             bindfocus="onCommentFocus"
             bindblur="onCommentBlur"
             confirm-type="send"
             bindconfirm="submitComment">
      </input>

      <view class="input-actions">
        <view class="action-btn" bindtap="chooseImage" wx:if="{{!commentImages.length}}">
          <text class="btn-icon">ğŸ“·</text>
        </view>

        <view class="action-btn image-preview" bindtap="previewImage" data-urls="{{commentImages}}" data-current="{{commentImages[0]}}" wx:if="{{commentImages.length}}">
          <text class="btn-icon">ğŸ“·</text>
        </view>

        <view class="action-btn send-btn {{commentText.trim() || commentImages.length ? 'active' : ''}}" bindtap="submitComment">
          <text class="btn-icon">ğŸ“¤</text>
        </view>
      </view>

      <!-- è¯„è®ºå›¾ç‰‡é¢„è§ˆ -->
      <view class="comment-image-preview" wx:if="{{commentImages.length > 0}}">
        <view class="preview-item" wx:for="{{commentImages}}" wx:key="index">
          <image class="preview-image" src="{{item}}" mode="aspectFill"></image>
          <view class="remove-image" bindtap="removeCommentImage" data-index="{{index}}">
            <text class="remove-icon">Ã—</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ›´å¤šæ“ä½œå¼¹çª— -->
  <view class="action-modal {{showActionModal ? 'show' : ''}}" bindtap="hideActionModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ›´å¤šæ“ä½œ</text>
        <view class="modal-close" bindtap="hideActionModal">
          <text class="close-icon">Ã—</text>
        </view>
      </view>

      <view class="action-list">
        <view class="modal-action-item" bindtap="reportPost" wx:if="{{!isAuthor}}">
          <text class="action-icon">ğŸš«</text>
          <text class="action-text">ä¸¾æŠ¥å¸–å­</text>
        </view>

        <view class="modal-action-item" bindtap="editPost" wx:if="{{isAuthor}}">
          <text class="action-icon">âœï¸</text>
          <text class="action-text">ç¼–è¾‘å¸–å­</text>
        </view>

        <view class="modal-action-item" bindtap="deletePost" wx:if="{{isAuthor}}">
          <text class="action-icon">ğŸ—‘ï¸</text>
          <text class="action-text">åˆ é™¤å¸–å­</text>
        </view>

        <view class="modal-action-item" bindtap="copyLink">
          <text class="action-icon">ğŸ“‹</text>
          <text class="action-text">å¤åˆ¶é“¾æ¥</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && !postInfo}}">
    <text class="empty-emoji">ğŸ“„</text>
    <text class="empty-text">å¸–å­ä¸å­˜åœ¨</text>
    <text class="empty-desc">è¯¥å¸–å­å¯èƒ½å·²è¢«åˆ é™¤æˆ–æ‚¨æ²¡æœ‰è®¿é—®æƒé™</text>
    <button class="btn btn-primary" bindtap="goBack">è¿”å›</button>
  </view>
</view>