<!--pages/forum/list.wxml-->
<view class="container page-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-content">
      <view class="header-title">
        <text class="title-icon">ğŸ’¬</text>
        <text>äº¤æµåŒº</text>
      </view>
      <view class="header-subtitle">åˆ†äº«é˜…è¯»å¿ƒå¾—ï¼Œç»“è¯†å¿—åŒé“åˆçš„æœ‹å‹</view>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-section">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <text class="search-icon">ğŸ”</text>
        <input class="search-input" placeholder="æœç´¢å¸–å­ã€è¯é¢˜ã€ç”¨æˆ·..." bindinput="onSearchInput" confirm-type="search" bindconfirm="onSearchConfirm" />
        <view class="search-clear" wx:if="{{searchKeyword}}" bindtap="clearSearch">Ã—</view>
      </view>
      <button class="search-btn" bindtap="performSearch">æœç´¢</button>
    </view>
  </view>

  <!-- æ¿å—åˆ‡æ¢ -->
  <view class="category-tabs">
    <view class="tab-item {{currentCategory === 'all' ? 'active' : ''}}" bindtap="switchCategory" data-category="all">
      <text class="tab-text">å…¨éƒ¨</text>
      <view class="tab-indicator" wx:if="{{currentCategory === 'all'}}"></view>
    </view>
    <view class="tab-item {{currentCategory === 'reading' ? 'active' : ''}}" bindtap="switchCategory" data-category="reading">
      <text class="tab-text">è¯»ä¹¦å¿ƒå¾—</text>
      <view class="tab-badge" wx:if="{{categoryCounts.reading > 0}}">{{categoryCounts.reading}}</view>
      <view class="tab-indicator" wx:if="{{currentCategory === 'reading'}}"></view>
    </view>
    <view class="tab-item {{currentCategory === 'activity' ? 'active' : ''}}" bindtap="switchCategory" data-category="activity">
      <text class="tab-text">æ´»åŠ¨è®¨è®º</text>
      <view class="tab-badge" wx:if="{{categoryCounts.activity > 0}}">{{categoryCounts.activity}}</view>
      <view class="tab-indicator" wx:if="{{currentCategory === 'activity'}}"></view>
    </view>
    <view class="tab-item {{currentCategory === 'chat' ? 'active' : ''}}" bindtap="switchCategory" data-category="chat">
      <text class="tab-text">é—²èŠåŒº</text>
      <view class="tab-badge" wx:if="{{categoryCounts.chat > 0}}">{{categoryCounts.chat}}</view>
      <view class="tab-indicator" wx:if="{{currentCategory === 'chat'}}"></view>
    </view>
    <view class="tab-item {{currentCategory === 'help' ? 'active' : ''}}" bindtap="switchCategory" data-category="help">
      <text class="tab-text">æ±‚åŠ©é—®ç­”</text>
      <view class="tab-badge" wx:if="{{categoryCounts.help > 0}}">{{categoryCounts.help}}</view>
      <view class="tab-indicator" wx:if="{{currentCategory === 'help'}}"></view>
    </view>
  </view>

  <!-- æ’åºé€‰é¡¹ -->
  <view class="sort-section">
    <view class="sort-tabs">
      <view class="sort-tab {{currentSort === 'latest' ? 'active' : ''}}" bindtap="changeSort" data-sort="latest">
        <text class="sort-text">æœ€æ–°</text>
      </view>
      <view class="sort-tab {{currentSort === 'hot' ? 'active' : ''}}" bindtap="changeSort" data-sort="hot">
        <text class="sort-text">çƒ­é—¨</text>
      </view>
      <view class="sort-tab {{currentSort === 'essence' ? 'active' : ''}}" bindtap="changeSort" data-sort="essence">
        <text class="sort-text">ç²¾å</text>
      </view>
    </view>
  </view>

  <!-- å¸–å­åˆ—è¡¨ -->
  <view class="posts-container" wx:if="{{posts.length > 0}}">
    <view class="posts-list">
      <view class="post-card" wx:for="{{posts}}" wx:key="id" bindtap="goToPostDetail" data-id="{{item.id}}">
        <!-- å¸–å­å¤´éƒ¨ -->
        <view class="post-header">
          <view class="author-info">
            <image class="author-avatar" src="{{item.author.avatar_url}}" mode="aspectFill"></image>
            <view class="author-details">
              <view class="author-name">{{item.author.nickname}}</view>
              <view class="post-meta">
                <text class="post-category">{{item.category_name}}</text>
                <text class="post-time">{{item.created_at_relative}}</text>
              </view>
            </view>
          </view>
          <view class="post-actions">
            <view class="action-btn" catchtap="toggleMoreMenu" data-id="{{item.id}}">
              <text class="action-icon">â‹¯</text>
            </view>
          </view>
        </view>

        <!-- å¸–å­å†…å®¹ -->
        <view class="post-body">
          <view class="post-title">{{item.title}}</view>
          <view class="post-content">{{item.content_preview}}</view>

          <!-- å›¾ç‰‡é¢„è§ˆ -->
          <view class="post-images" wx:if="{{item.images && item.images.length > 0}}">
            <image class="post-image" wx:for="{{item.images}}" wx:for-item="image" wx:key="index" src="{{image}}" mode="aspectFill" bindtap="previewImage" data-urls="{{item.images}}" data-current="{{image}}"></image>
          </view>
        </view>

        <!-- å¸–å­æ ‡ç­¾ -->
        <view class="post-tags" wx:if="{{item.tags && item.tags.length > 0}}">
          <view class="tag" wx:for="{{item.tags}}" wx:key="index" bindtap="searchByTag" data-tag="{{item}}">
            #{{item}}
          </view>
        </view>

        <!-- å¸–å­åº•éƒ¨ -->
        <view class="post-footer">
          <view class="post-stats">
            <view class="stat-item">
              <text class="stat-icon">ğŸ‘ï¸</text>
              <text class="stat-text">{{item.views_count}}</text>
            </view>
            <view class="stat-item">
              <text class="stat-icon">ğŸ’¬</text>
              <text class="stat-text">{{item.comments_count}}</text>
            </view>
            <view class="stat-item" bindtap="likePost" data-id="{{item.id}}" catchtap="true">
              <text class="stat-icon {{item.liked_by_current_user ? 'liked' : ''}}">{{item.liked_by_current_user ? 'â¤ï¸' : 'ğŸ¤'}}</text>
              <text class="stat-text">{{item.likes_count}}</text>
            </view>
          </view>
          <view class="post-status" wx:if="{{item.is_essence}}">
            <view class="essence-badge">ç²¾å</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && posts.length === 0}}">
    <view class="empty-illustration">
      <text class="empty-emoji">ğŸ’­</text>
    </view>
    <view class="empty-title">æš‚æ— å¸–å­</view>
    <view class="empty-desc">å¿«æ¥å‘ç¬¬ä¸€ä¸ªå¸–å­ï¼Œå¼€å¯è®¨è®ºå§ï¼</view>
    <button class="btn btn-primary" bindtap="goToCreatePost">
      <text>å‘ä¸ªå¸–å­</text>
      <text class="btn-arrow">â†’</text>
    </button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">ç²¾å½©å†…å®¹åŠ è½½ä¸­...</text>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view class="load-more-section" wx:if="{{hasMore && !loading}}">
    <button class="load-more-btn" bindtap="loadMore">
      <text class="load-text">åŠ è½½æ›´å¤šå¸–å­</text>
      <text class="load-icon">â†“</text>
    </button>
  </view>

  <!-- æ²¡æœ‰æ›´å¤š -->
  <view class="end-reached" wx:if="{{!hasMore && posts.length > 0}}">
    <view class="end-line"></view>
    <text class="end-text">å·²ç»åˆ°åº•äº†</text>
  </view>
</view>

<!-- æ›´å¤šæ“ä½œèœå• -->
<view class="more-menu-modal" wx:if="{{showMoreMenu}}" bindtap="hideMoreMenu">
  <view class="more-menu-content" catchtap="stopPropagation">
    <view class="menu-item" wx:if="{{currentPost.author_info.id === userId}}" bindtap="editPost">
      <text class="menu-icon">âœï¸</text>
      <text class="menu-text">ç¼–è¾‘å¸–å­</text>
    </view>
    <view class="menu-item" wx:if="{{currentPost.author_info.id === userId}}" bindtap="deletePost">
      <text class="menu-icon">ğŸ—‘ï¸</text>
      <text class="menu-text">åˆ é™¤å¸–å­</text>
    </view>
    <view class="menu-item" bindtap="reportPost">
      <text class="menu-icon">ğŸš¨</text>
      <text class="menu-text">ä¸¾æŠ¥å¸–å­</text>
    </view>
    <view class="menu-item" bindtap="sharePost">
      <text class="menu-icon">ğŸ“¤</text>
      <text class="menu-text">åˆ†äº«å¸–å­</text>
    </view>
  </view>
</view>

<!-- æµ®åŠ¨å‘å¸–æŒ‰é’® -->
<view class="fab" bindtap="goToCreatePost" wx:if="{{userInfo}}">
  <text class="fab-icon">âœï¸</text>
</view>