name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  RUBY_VERSION: '3.2'
  POSTGRES_VERSION: '14'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: qqclub_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: true
        working-directory: ./qqclub_api

    - name: Install dependencies
      working-directory: ./qqclub_api
      run: bundle install --jobs 4 --retry 3

    - name: Set up database
      working-directory: ./qqclub_api
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/qqclub_test
      run: |
        bundle exec rails db:create
        bundle exec rails db:schema:load

    - name: Run tests
      working-directory: ./qqclub_api
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/qqclub_test
      run: bundle exec rails test

    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: qqclub_api/coverage/
        retention-days: 7

  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: true
        working-directory: ./qqclub_api

    - name: Install dependencies
      working-directory: ./qqclub_api
      run: bundle install --jobs 4 --retry 3

    - name: Run RuboCop
      working-directory: ./qqclub_api
      run: |
        # Install RuboCop if not in Gemfile
        gem install rubocop rubocop-rails rubocop-performance || true
        bundle exec rubocop --format github || true
      continue-on-error: true

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: true
        working-directory: ./qqclub_api

    - name: Install dependencies
      working-directory: ./qqclub_api
      run: bundle install --jobs 4 --retry 3

    - name: Run Bundler Audit
      working-directory: ./qqclub_api
      run: |
        gem install bundler-audit
        bundle audit check --update
      continue-on-error: true

    - name: Run Brakeman (Rails Security Scanner)
      working-directory: ./qqclub_api
      run: |
        gem install brakeman
        brakeman -q -w2 -z
      continue-on-error: true

  build:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: true
        working-directory: ./qqclub_api

    - name: Install dependencies
      working-directory: ./qqclub_api
      run: bundle install --jobs 4 --retry 3

    - name: Check for syntax errors
      working-directory: ./qqclub_api
      run: |
        ruby -c $(find app lib -name '*.rb') || true

    - name: Check database schema
      working-directory: ./qqclub_api
      run: |
        bundle exec rails db:schema:dump
        git diff --exit-code db/schema.rb || (echo "Schema is out of sync!" && exit 1)
      continue-on-error: true

  dependencies:
    name: Dependency Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}

    - name: Check for outdated dependencies
      working-directory: ./qqclub_api
      run: |
        bundle install
        bundle outdated --strict || true
      continue-on-error: true

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test, lint, security, build]
    if: always()

    steps:
    - name: Check job results
      run: |
        echo "Test: ${{ needs.test.result }}"
        echo "Lint: ${{ needs.lint.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo "Build: ${{ needs.build.result }}"

    - name: Fail if tests failed
      if: needs.test.result == 'failure'
      run: exit 1

    - name: Success message
      if: needs.test.result == 'success'
      run: echo "All CI checks completed successfully!"
