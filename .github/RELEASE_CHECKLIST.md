# 发布到生产环境检查清单

每次将代码从 `develop` 合并到 `main` 并发布到生产环境前，请完成以下检查：

## 📋 发布前检查清单

### 1. 代码质量检查
- [ ] 所有 CI/CD 测试通过（绿色✅）
- [ ] 所有新功能都有单元测试
- [ ] 代码已经在 develop 分支稳定运行至少 24 小时
- [ ] 没有遗留的 TODO 或 FIXME 注释（关键代码）

### 2. 版本管理
- [ ] 确定新版本号（遵循语义化版本 semver）
  - 主版本号（重大变更）
  - 次版本号（新功能）
  - 修订号（bug 修复）
- [ ] 准备好版本标签（如 v1.2.0）
- [ ] 更新 CHANGELOG.md

### 3. 数据库和配置
- [ ] 数据库迁移已测试且可回滚
- [ ] 环境变量已配置（生产环境）
- [ ] 配置文件已更新
- [ ] 敏感信息没有硬编码

### 4. 依赖和兼容性
- [ ] 所有依赖已更新到安全版本
- [ ] 没有安全漏洞警告
- [ ] API 变更向后兼容（或有迁移计划）
- [ ] 微信小程序版本兼容

### 5. 文档
- [ ] API 文档已更新
- [ ] README 已更新（如有必要）
- [ ] 发布说明已准备
- [ ] 用户手册已更新（如有变更）

### 6. 部署准备
- [ ] 备份计划已准备
- [ ] 回滚方案已确认
- [ ] 监控和日志已配置
- [ ] 性能测试通过（如有重大变更）

### 7. 通知和沟通
- [ ] 团队成员已知晓发布计划
- [ ] 用户通知已准备（如有必要）
- [ ] 维护窗口已安排（如需停机）

## 🚀 发布流程

### 步骤 1：创建发布 PR
```bash
git checkout develop
git pull origin develop
gh pr create --base main --title "Release v1.2.0" --body "$(cat RELEASE_NOTES.md)"
```

### 步骤 2：等待 CI/CD 通过
- 查看所有检查是否为绿色✅
- 如有失败，修复后重新检查

### 步骤 3：执行上述检查清单
- 逐项确认每个检查点
- 确保万无一失

### 步骤 4：合并到 main
```bash
# 在 GitHub PR 页面：
# 1. 点击 "Merge pull request"
# 2. 使用管理员权限绕过审核要求
# 3. 选择 "Create a merge commit"（保留完整历史）
```

### 步骤 5：打标签
```bash
git checkout main
git pull origin main
git tag -a v1.2.0 -m "Release version 1.2.0

新功能：
- 功能 A
- 功能 B

Bug 修复：
- 修复 C
- 修复 D

破坏性变更：
- 变更 E（如有）
"
git push origin main --tags
```

### 步骤 6：部署
```bash
# 使用部署脚本
./scripts/qq-deploy.sh

# 或手动部署
# ...
```

### 步骤 7：发布后验证
- [ ] 生产环境访问正常
- [ ] 关键功能测试通过
- [ ] 日志没有异常错误
- [ ] 性能指标正常

### 步骤 8：记录和归档
- [ ] 更新发布历史文档
- [ ] 关闭相关 Issue
- [ ] 在团队沟通渠道通知

## ⚠️ 紧急回滚流程

如果发布后发现严重问题：

```bash
# 1. 立即回滚到上一个标签
git checkout main
git revert HEAD --no-edit
git push origin main

# 2. 或使用标签回滚
git reset --hard v1.1.0
git push origin main --force  # 需要临时禁用分支保护

# 3. 重新部署上一个版本
./scripts/qq-deploy.sh v1.1.0

# 4. 通知相关人员
# 5. 分析问题原因
# 6. 准备修复版本
```

## 📝 发布说明模板

创建 `RELEASE_NOTES.md`：

```markdown
# Release v1.2.0 - 2025-01-16

## 🎉 新功能
- [功能模块] 添加 XXX 功能
- [功能模块] 增强 YYY 体验

## 🐛 Bug 修复
- 修复 AAA 问题
- 解决 BBB 错误

## 🔧 改进
- 优化 CCC 性能
- 重构 DDD 代码

## ⚠️ 破坏性变更
- API 端点 /api/xxx 已废弃，请使用 /api/v1/xxx
- 数据库字段 old_field 已重命名为 new_field

## 📊 统计
- 新增代码：+XXX 行
- 删除代码：-YYY 行
- 文件变更：ZZZ 个

## 🙏 致谢
感谢所有贡献者！
```

## 🎯 最佳实践

1. **发布时间**：选择低流量时段
2. **发布频率**：建议每 1-2 周一次小版本发布
3. **灰度发布**：重大变更先小范围测试
4. **监控告警**：发布后密切关注 30 分钟

---

**记住**：发布到生产是重要时刻，宁可多花 5 分钟检查，也不要让问题进入生产环境！

🚀 祝每次发布都顺利！
