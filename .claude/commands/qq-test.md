# QQClub Test - QQClub 项目测试执行命令

这个命令帮助你对 QQClub 项目进行全面的测试，包括单元测试、集成测试和API测试。

## 执行流程

### 1. 环境检查
首先确保测试环境准备就绪：
- 检查 Rails 服务器状态
- 验证数据库连接
- 确认必要的测试数据
- 检查依赖项是否最新

### 2. 测试分类执行
按测试类型和优先级执行测试：

#### 2.1 基础功能测试
- **用户认证系统测试**
  - 模拟登录功能
  - JWT token 验证
  - 用户资料更新

- **论坛功能测试**
  - 帖子 CRUD 操作
  - 置顶和隐藏功能
  - 权限控制验证

#### 2.2 业务逻辑测试
- **读书活动测试**
  - 活动创建和审批
  - 用户报名流程
  - 活动状态管理

- **打卡系统测试**
  - 打卡提交和验证
  - 内容修改功能
  - 字数统计检查

#### 2.3 权限系统测试
- **角色权限验证**
  - 管理员权限测试
  - 小组长权限测试
  - 领读人权限测试
  - 时间窗口权限测试

- **边界条件测试**
  - 权限越界尝试
  - 无效token处理
  - 资源访问控制

#### 2.4 小红花系统测试
- **领读内容管理**
- **小红花发放机制**
- **统计功能验证**

### 3. API 集成测试
使用 `docs/technical/API_TESTING_GUIDE.md` 中的测试用例：
- 执行完整的 API 测试脚本
- 验证所有端点的响应
- 检查错误处理机制

### 4. 性能测试
- **响应时间测试**
  - 关键API端点的响应时间
  - 并发请求处理能力
  - 数据库查询性能

- **负载测试**
  - 模拟多用户同时操作
  - 系统稳定性检查
  - 资源使用监控

### 5. 测试报告生成
生成详细的测试报告：
- **测试结果汇总**
  - 通过/失败的测试用例
  - 覆盖率统计
  - 性能指标

- **问题清单**
  - 发现的bug和问题
  - 性能瓶颈点
  - 改进建议

## 测试策略

### 测试环境
- **开发环境**: 功能验证和基础测试
- **测试环境**: 集成测试和性能测试
- **预生产环境**: 用户验收测试

### 测试频率
- **日常开发**: 功能模块完成后即时测试
- **集成阶段**: 每周全面测试
- **发布前**: 完整回归测试

### 测试数据管理
- 使用 fixtures 或 factories 创建测试数据
- 保持测试数据的独立性
- 定期清理和更新测试数据

## 常见测试场景

### 用户注册和登录流程
```bash
# 1. 创建用户
# 2. 验证登录
# 3. 检查用户信息
# 4. 测试权限验证
```

### 完整的读书活动流程
```bash
# 1. 创建活动（小组长）
# 2. 审批活动（管理员）
# 3. 用户报名
# 4. 发布阅读计划
# 5. 用户打卡
# 6. 领读人评选小红花
```

### 权限边界测试
```bash
# 1. 普通用户尝试管理员操作
# 2. 非作者尝试编辑帖子
# 3. 过期权限验证
# 4. 跨资源访问控制
```

## 自动化测试脚本

### API 测试脚本
```bash
#!/bin/bash
# 基础API测试
echo "开始 API 测试..."

# 认证测试
curl -X POST http://localhost:3000/api/auth/mock_login \
  -H "Content-Type: application/json" \
  -d '{"nickname": "测试用户", "wx_openid": "test_001"}'

# 论坛测试
# 活动测试
# 权限测试

echo "API 测试完成"
```

### 数据库一致性检查
```ruby
# 在 Rails console 中执行
User.count
ReadingEvent.count
Post.count
CheckIn.count
Flower.count
```

## 故障排查

### 常见问题
1. **测试环境配置问题**
   - 数据库连接失败
   - 环境变量缺失
   - 依赖版本冲突

2. **测试数据问题**
   - 测试数据不足
   - 数据状态不一致
   - 外键约束冲突

3. **权限测试失败**
   - Token 验证问题
   - 角色配置错误
   - 时间窗口计算错误

### 调试技巧
- 查看 Rails 日志：`tail -f log/test.log`
- 使用 byebug 或 binding.irb 进行断点调试
- 检查数据库状态：`bin/rails db:test:prepare`

## 持续改进

### 测试覆盖率优化
- 定期检查测试覆盖率
- 补充缺失的测试用例
- 优化测试执行效率

### 测试流程改进
- 自动化更多测试场景
- 改进测试数据管理
- 优化测试报告格式

---

这个命令确保你的 QQClub 项目始终保持高质量的代码和稳定的功能，通过全面的测试覆盖来保障系统的可靠性。