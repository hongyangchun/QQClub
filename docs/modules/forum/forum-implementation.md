# QQClub è®ºå›äº¤æµæ¨¡å— - å®æ–½æŒ‡å—

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

**ç›®æ ‡è¯»è€…**: å¼€å‘å›¢é˜Ÿã€DevOpså·¥ç¨‹å¸ˆã€é¡¹ç›®ç»ç†
**æ–‡æ¡£å†…å®¹**: è®ºå›æ¨¡å—çš„å¼€å‘è®¡åˆ’ã€æµ‹è¯•ç­–ç•¥ã€éƒ¨ç½²æŒ‡å—ã€è¿ç»´ç®¡ç†
**ä¸å…¶ä»–æ–‡æ¡£å…³ç³»**: æœ¬æ–‡æ¡£æ˜¯è®ºå›æ¨¡å—çš„å…·ä½“å®æ–½æŒ‡å¯¼ï¼ŒæŠ€æœ¯è®¾è®¡è¯·å‚è€ƒ [è®ºå›æŠ€æœ¯è®¾è®¡](forum-technical.md)

---

## ğŸš€ é¡¹ç›®å®æ–½è®¡åˆ’

### å¼€å‘é˜¶æ®µè§„åˆ’

#### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½å¼€å‘ (4å‘¨)
**ç›®æ ‡**: å»ºç«‹åŸºç¡€çš„è®ºå›äº¤æµèƒ½åŠ›

**æ ¸å¿ƒåŠŸèƒ½**:
- [x] ç”¨æˆ·å‘å¸–å’Œè¯„è®ºåŠŸèƒ½
- [x] åŸºç¡€çš„å†…å®¹å±•ç¤ºå’Œæµè§ˆ
- [x] ç®€å•çš„ç”¨æˆ·ç®¡ç†
- [x] åŸºç¡€çš„å†…å®¹å®¡æ ¸

**å¼€å‘ä»»åŠ¡**:
```
Week 1: æ•°æ®åº“è®¾è®¡å’ŒåŸºç¡€æ¨¡å‹
â”œâ”€â”€ åˆ›å»ºè®ºå›ç›¸å…³æ•°æ®è¡¨
â”œâ”€â”€ å®ç°User, Post, CommentåŸºç¡€æ¨¡å‹
â”œâ”€â”€ è®¾ç½®åŸºç¡€çš„æ•°æ®éªŒè¯å’Œå…³è”
â””â”€â”€ åˆ›å»ºåŸºç¡€æµ‹è¯•ç”¨ä¾‹

Week 2: å¸–å­å’Œè¯„è®ºåŠŸèƒ½
â”œâ”€â”€ å®ç°å¸–å­CRUD API
â”œâ”€â”€ å®ç°è¯„è®ºCRUD API
â”œâ”€â”€ æ·»åŠ åŸºç¡€çš„å†…å®¹å±•ç¤ºé¡µé¢
â””â”€â”€ å®ç°ç®€å•çš„åˆ†é¡µåŠŸèƒ½

Week 3: ç”¨æˆ·ç®¡ç†å’Œè®¤è¯
â”œâ”€â”€ é›†æˆå¾®ä¿¡ç™»å½•
â”œâ”€â”€ å®ç°ç”¨æˆ·è§’è‰²æƒé™ç³»ç»Ÿ
â”œâ”€â”€ æ·»åŠ ç”¨æˆ·ä¸ªäººä¸»é¡µ
â””â”€â”€ å®ç°ç”¨æˆ·å…³æ³¨åŠŸèƒ½

Week 4: å†…å®¹å®¡æ ¸å’ŒåŸºç¡€ç®¡ç†
â”œâ”€â”€ å®ç°æ•æ„Ÿè¯è¿‡æ»¤
â”œâ”€â”€ æ·»åŠ ä¸¾æŠ¥åŠŸèƒ½
â”œâ”€â”€ åˆ›å»ºç®¡ç†å‘˜åå°ç•Œé¢
â””â”€â”€ å®ŒæˆåŸºç¡€åŠŸèƒ½æµ‹è¯•
```

**äº¤ä»˜ç‰©**:
- å¯è¿è¡Œçš„è®ºå›åŸºç¡€ç‰ˆæœ¬
- å®Œæ•´çš„APIæ–‡æ¡£
- åŸºç¡€åŠŸèƒ½æµ‹è¯•å¥—ä»¶
- ç”¨æˆ·æ‰‹å†Œå’Œéƒ¨ç½²æ–‡æ¡£

#### ç¬¬äºŒé˜¶æ®µï¼šç¤¾åŒºæ²»ç†åŠŸèƒ½ (3å‘¨)
**ç›®æ ‡**: å®Œå–„ç¤¾åŒºæ²»ç†æœºåˆ¶

**æ–°å¢åŠŸèƒ½**:
- [ ] å®Œæ•´çš„å†…å®¹å®¡æ ¸ä½“ç³»
- [ ] ç”¨æˆ·ä¸¾æŠ¥å’Œå¤„ç†æœºåˆ¶
- [ ] ç‰ˆä¸»ç®¡ç†ç³»ç»Ÿ
- [ ] ç¤¾åŒºè§„åˆ™é…ç½®

**å¼€å‘ä»»åŠ¡**:
```
Week 5: é«˜çº§å†…å®¹å®¡æ ¸
â”œâ”€â”€ å®ç°å›¾ç‰‡å†…å®¹è¯†åˆ«
â”œâ”€â”€ æ·»åŠ AIå†…å®¹æ£€æµ‹
â”œâ”€â”€ å®ç°å®¡æ ¸å·¥ä½œæµ
â””â”€â”€ åˆ›å»ºå®¡æ ¸å†å²è®°å½•

Week 6: ç”¨æˆ·ä¸¾æŠ¥ç³»ç»Ÿ
â”œâ”€â”€ å®ç°ä¸¾æŠ¥åŠŸèƒ½
â”œâ”€â”€ æ·»åŠ ä¸¾æŠ¥å¤„ç†æµç¨‹
â”œâ”€â”€ åˆ›å»ºä¸¾æŠ¥ç»Ÿè®¡æŠ¥è¡¨
â””â”€â”€ å®ç°è‡ªåŠ¨å¤„ç†è§„åˆ™

Week 7: ç‰ˆä¸»ç®¡ç†ç³»ç»Ÿ
â”œâ”€â”€ å®ç°ç‰ˆä¸»æƒé™ç®¡ç†
â”œâ”€â”€ æ·»åŠ ç‰ˆä¸»å·¥ä½œå°
â”œâ”€â”€ å®ç°ç‰ˆä¸»ç»©æ•ˆç»Ÿè®¡
â””â”€â”€ å®Œæˆç¤¾åŒºæ²»ç†åŠŸèƒ½æµ‹è¯•
```

#### ç¬¬ä¸‰é˜¶æ®µï¼šæ¿€åŠ±æœºåˆ¶ (2å‘¨)
**ç›®æ ‡**: å»ºç«‹ç”¨æˆ·æ¿€åŠ±ä½“ç³»

**æ–°å¢åŠŸèƒ½**:
- [ ] ç§¯åˆ†å’Œç­‰çº§ç³»ç»Ÿ
- [ ] å¾½ç« ç³»ç»Ÿ
- [ ] æ’è¡Œæ¦œåŠŸèƒ½
- [ ] ç”¨æˆ·æ´»è·ƒåº¦ç»Ÿè®¡

**å¼€å‘ä»»åŠ¡**:
```
Week 8: ç§¯åˆ†ç­‰çº§ç³»ç»Ÿ
â”œâ”€â”€ å®ç°ç§¯åˆ†è·å–å’Œæ¶ˆè´¹
â”œâ”€â”€ æ·»åŠ ç”¨æˆ·ç­‰çº§å‡çº§
â”œâ”€â”€ åˆ›å»ºç§¯åˆ†æµæ°´è®°å½•
â””â”€â”€ å®ç°ç­‰çº§æƒç›Šé…ç½®

Week 9: å¾½ç« å’Œæ’è¡Œæ¦œ
â”œâ”€â”€ å®ç°å¾½ç« ç³»ç»Ÿ
â”œâ”€â”€ æ·»åŠ å¤šç»´åº¦æ’è¡Œæ¦œ
â”œâ”€â”€ åˆ›å»ºç”¨æˆ·æˆå°±é¡µé¢
â””â”€â”€ å®Œæˆæ¿€åŠ±æœºåˆ¶æµ‹è¯•
```

#### ç¬¬å››é˜¶æ®µï¼šæ™ºèƒ½åŒ–è¿è¥ (3å‘¨)
**ç›®æ ‡**: æå‡ç”¨æˆ·ä½“éªŒå’Œè¿è¥æ•ˆç‡

**æ–°å¢åŠŸèƒ½**:
- [ ] æ™ºèƒ½å†…å®¹æ¨è
- [ ] ç”¨æˆ·è¡Œä¸ºåˆ†æ
- [ ] è‡ªåŠ¨åŒ–è¿è¥å·¥å…·
- [ ] æ•°æ®å¯è§†åŒ–ä»ªè¡¨æ¿

#### ç¬¬äº”é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–å’Œæ‰©å±• (2å‘¨)
**ç›®æ ‡**: ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½å’Œæ‰©å±•åŠŸèƒ½

**ä¼˜åŒ–é‡ç‚¹**:
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
- [ ] å‰ç«¯æ€§èƒ½ä¼˜åŒ–
- [ ] ç³»ç»Ÿç›‘æ§å®Œå–„

### é‡Œç¨‹ç¢‘è®¾ç½®

| é‡Œç¨‹ç¢‘ | æ—¶é—´èŠ‚ç‚¹ | ä¸»è¦äº¤ä»˜ç‰© | éªŒæ”¶æ ‡å‡† |
|--------|----------|------------|----------|
| M1: MVPç‰ˆæœ¬ | ç¬¬4å‘¨æœ« | åŸºç¡€è®ºå›åŠŸèƒ½ | ç”¨æˆ·å¯æ­£å¸¸å‘å¸–è¯„è®º |
| M2: ç¤¾åŒºæ²»ç† | ç¬¬7å‘¨æœ« | å®Œæ•´æ²»ç†ä½“ç³» | å†…å®¹å®¡æ ¸æµç¨‹å®Œæ•´ |
| M3: æ¿€åŠ±æœºåˆ¶ | ç¬¬9å‘¨æœ« | ç”¨æˆ·æ¿€åŠ±ä½“ç³» | ç§¯åˆ†å¾½ç« ç³»ç»Ÿå¯ç”¨ |
| M4: æ™ºèƒ½åŒ–è¿è¥ | ç¬¬12å‘¨æœ« | è¿è¥å·¥å…·åŒ… | æ¨èç³»ç»Ÿä¸Šçº¿ |
| M5: ç”Ÿäº§å°±ç»ª | ç¬¬14å‘¨æœ« | ä¼˜åŒ–ç‰ˆæœ¬ | æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡ |

---

## ğŸ‘¥ å›¢é˜Ÿç»„ç»‡æ¶æ„

### å¼€å‘å›¢é˜Ÿé…ç½®

#### æ ¸å¿ƒå›¢é˜Ÿ (6äºº)
- **é¡¹ç›®ç»ç†** (1äºº): é¡¹ç›®åè°ƒã€è¿›åº¦ç®¡ç†ã€é£é™©æ§åˆ¶
- **åç«¯å¼€å‘** (2äºº): APIå¼€å‘ã€æ•°æ®åº“è®¾è®¡ã€ä¸šåŠ¡é€»è¾‘å®ç°
- **å‰ç«¯å¼€å‘** (2äºº): Webç•Œé¢ã€å°ç¨‹åºç•Œé¢ã€äº¤äº’å®ç°
- **æµ‹è¯•å·¥ç¨‹å¸ˆ** (1äºº): æµ‹è¯•ç”¨ä¾‹è®¾è®¡ã€è‡ªåŠ¨åŒ–æµ‹è¯•ã€è´¨é‡ä¿è¯

#### æ”¯æŒå›¢é˜Ÿ (3äºº)
- **UI/UXè®¾è®¡å¸ˆ** (1äºº): ç•Œé¢è®¾è®¡ã€äº¤äº’è®¾è®¡ã€è®¾è®¡è§„èŒƒ
- **DevOpså·¥ç¨‹å¸ˆ** (1äºº): éƒ¨ç½²é…ç½®ã€ç›‘æ§è¿ç»´ã€æ€§èƒ½ä¼˜åŒ–
- **äº§å“ç»ç†** (1äºº): éœ€æ±‚åˆ†æã€äº§å“è§„åˆ’ã€ç”¨æˆ·è°ƒç ”

### åä½œæµç¨‹

#### å¼€å‘æµç¨‹
```mermaid
graph TD
    A[éœ€æ±‚åˆ†æ] --> B[æŠ€æœ¯è®¾è®¡]
    B --> C[ä»»åŠ¡åˆ†è§£]
    C --> D[å¼€å‘å®ç°]
    D --> E[ä»£ç å®¡æŸ¥]
    E --> F[æµ‹è¯•éªŒè¯]
    F --> G[éƒ¨ç½²ä¸Šçº¿]
    G --> H[ç›‘æ§ç»´æŠ¤]
    H --> A
```

#### æ¯æ—¥ç«™ä¼š
- **æ—¶é—´**: æ¯å¤©ä¸Šåˆ9:30
- **å‚ä¸è€…**: å…¨ä½“å¼€å‘å›¢é˜Ÿ
- **å†…å®¹**: æ˜¨æ—¥å®Œæˆã€ä»Šæ—¥è®¡åˆ’ã€é—®é¢˜éšœç¢
- **æ—¶é•¿**: 15åˆ†é’Ÿ

#### æ¯å‘¨å¤ç›˜
- **æ—¶é—´**: æ¯å‘¨äº”ä¸‹åˆ
- **å‚ä¸è€…**: é¡¹ç›®å›¢é˜Ÿ + äº§å“ç»ç†
- **å†…å®¹**: è¿›åº¦å›é¡¾ã€é—®é¢˜æ€»ç»“ã€ä¸‹å‘¨è®¡åˆ’
- **æ—¶é•¿**: 1å°æ—¶

---

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒæ­å»º

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

#### 1. ç³»ç»Ÿè¦æ±‚
```bash
# æ“ä½œç³»ç»Ÿ
- macOS 10.15+ / Ubuntu 18.04+ / Windows 10+

# å¼€å‘å·¥å…·
- Ruby 3.2.0+
- Rails 8.0+
- PostgreSQL 15+
- Redis 7.0+
- Node.js 18.0+
- Git 2.30+
```

#### 2. ç¯å¢ƒé…ç½®è„šæœ¬
```bash
#!/bin/bash
# setup_forum_dev.sh

echo "=== QQClub è®ºå›æ¨¡å—å¼€å‘ç¯å¢ƒæ­å»º ==="

# å®‰è£…Ruby (ä½¿ç”¨rbenv)
if ! command -v rbenv &> /dev/null; then
    echo "å®‰è£…rbenv..."
    brew install rbenv
    echo 'eval "$(rbenv init -)"' >> ~/.zshrc
fi

echo "å®‰è£…Ruby 3.2.0..."
rbenv install 3.2.0
rbenv global 3.2.0

# å®‰è£…Rails
echo "å®‰è£…Rails..."
gem install rails -v 8.0.0

# å®‰è£…PostgreSQL
if ! command -v psql &> /dev/null; then
    echo "å®‰è£…PostgreSQL..."
    brew install postgresql@15
    brew services start postgresql@15
fi

# åˆ›å»ºå¼€å‘æ•°æ®åº“
echo "åˆ›å»ºå¼€å‘æ•°æ®åº“..."
createdb qqclub_development
createdb qqclub_test

# å®‰è£…Redis
if ! command -v redis-server &> /dev/null; then
    echo "å®‰è£…Redis..."
    brew install redis
    brew services start redis
fi

# å…‹éš†é¡¹ç›®
echo "å…‹éš†é¡¹ç›®ä»£ç ..."
git clone https://github.com/your-org/qqclub.git
cd qqclub

# å®‰è£…ä¾èµ–
echo "å®‰è£…é¡¹ç›®ä¾èµ–..."
bundle install
yarn install

# é…ç½®ç¯å¢ƒå˜é‡
echo "é…ç½®ç¯å¢ƒå˜é‡..."
cp .env.example .env.development

# åˆå§‹åŒ–æ•°æ®åº“
echo "åˆå§‹åŒ–æ•°æ®åº“..."
rails db:create db:migrate db:seed

echo "=== å¼€å‘ç¯å¢ƒæ­å»ºå®Œæˆ ==="
echo "å¯åŠ¨å¼€å‘æœåŠ¡å™¨: rails server"
echo "è¿è¡Œæµ‹è¯•: rails test"
```

#### 3. Docker å¼€å‘ç¯å¢ƒ
```dockerfile
# Dockerfile.dev
FROM ruby:3.2.0-alpine

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    build-base \
    postgresql-dev \
    tzdata \
    nodejs \
    npm \
    git

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶Gemfileå¹¶å®‰è£…ä¾èµ–
COPY Gemfile Gemfile.lock ./
RUN bundle config set --local deployment 'true' && \
    bundle install --jobs 4 --retry 3

# å¤åˆ¶package.jsonå¹¶å®‰è£…Node.jsä¾èµ–
COPY package.json yarn.lock ./
RUN yarn install

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV RAILS_ENV=development
ENV RAILS_LOG_TO_STDOUT=true

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å‘½ä»¤
CMD ["rails", "server", "-b", "0.0.0.0"]
```

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - bundle_cache:/usr/local/bundle
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/qqclub_development
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis
    command: rails server -b 0.0.0.0

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=qqclub_development
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7.0-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  bundle_cache:
  postgres_data:
  redis_data:
```

### å¼€å‘å·¥å…·é…ç½®

#### 1. VS Code é…ç½®
```json
// .vscode/settings.json
{
  "ruby.useLanguageServer": true,
  "ruby.lint": {
    "rubocop": {
      "lint": true,
      "rails": true
    },
    "reek": true,
    "fasterer": true
  },
  "ruby.format": "rubocop",
  "emmet.includeLanguages": {
    "erb": "html"
  },
  "files.associations": {
    "*.erb": "html.erb"
  },
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true
  }
}
```

#### 2. Git Hooks é…ç½®
```bash
#!/bin/bash
# .git/hooks/pre-commit

echo "è¿è¡Œé¢„æäº¤æ£€æŸ¥..."

# è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥
bundle exec rubocop --parallel
if [ $? -ne 0 ]; then
    echo "âŒ ä»£ç é£æ ¼æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤"
    exit 1
fi

# è¿è¡Œé™æ€åˆ†æ
bundle exec reek
if [ $? -ne 0 ]; then
    echo "âš ï¸  ä»£ç æœ‰å¼‚å‘³ï¼Œå»ºè®®æ”¹è¿›"
fi

# è¿è¡ŒåŸºç¡€æµ‹è¯•
bundle exec rails test:units
if [ $? -ne 0 ]; then
    echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤"
    exit 1
fi

echo "âœ… é¢„æäº¤æ£€æŸ¥é€šè¿‡"
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”

```
        /\
       /  \
      / E2E \     - ç«¯åˆ°ç«¯æµ‹è¯• (10%)
     /______\
    /        \
   /Integration\ - é›†æˆæµ‹è¯• (20%)
  /__________\
 /            \
/   Unit Test  \  - å•å…ƒæµ‹è¯• (70%)
/______________\
```

### å•å…ƒæµ‹è¯•

#### 1. æ¨¡å‹æµ‹è¯•
```ruby
# test/models/post_test.rb
require "test_helper"

class PostTest < ActiveSupport::TestCase
  def setup
    @user = create(:user, :verified)
    @category = create(:category)
    @post = build(:post, user: @user, category: @category)
  end

  test "åº”è¯¥æœ‰æ•ˆä¸”æ‰€æœ‰éªŒè¯é€šè¿‡" do
    assert @post.valid?
  end

  test "æ ‡é¢˜ä¸èƒ½ä¸ºç©º" do
    @post.title = ""
    assert_not @post.valid?
    assert_includes @post.errors[:title], "ä¸èƒ½ä¸ºç©º"
  end

  test "å†…å®¹ä¸èƒ½ä¸ºç©º" do
    @post.content = ""
    assert_not @post.valid?
    assert_includes @post.errors[:content], "ä¸èƒ½ä¸ºç©º"
  end

  test "æ ‡é¢˜é•¿åº¦åº”è¯¥åœ¨5-200å­—ç¬¦ä¹‹é—´" do
    @post.title = "1234"  # å¤ªçŸ­
    assert_not @post.valid?

    @post.title = "a" * 201  # å¤ªé•¿
    assert_not @post.valid?

    @post.title = "æœ‰æ•ˆçš„æ ‡é¢˜"
    assert @post.valid?
  end

  test "åº”è¯¥è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦" do
    @post.content = "è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„å¸–å­å†…å®¹ï¼Œåº”è¯¥èƒ½å¤Ÿè‡ªåŠ¨ç”Ÿæˆæ‘˜è¦..."
    @post.save
    assert_not_nil @post.excerpt
    assert @post.excerpt.length <= 200
  end

  test "å‘å¸ƒæ—¶é—´åº”è¯¥åœ¨åˆ›å»ºæ—¶é—´ä¹‹å" do
    @post.save!
    travel_to 1.hour.from_now
    @post.publish!
    assert @post.published_at > @post.created_at
    travel_back
  end
end
```

#### 2. æœåŠ¡ç±»æµ‹è¯•
```ruby
# test/services/content_moderation_service_test.rb
require "test_helper"

class ContentModerationServiceTest < ActiveSupport::TestCase
  def setup
    @sensitive_word = create(:sensitive_word, word: "è¿ç¦è¯", level: 3)
  end

  test "åº”è¯¥æ£€æµ‹åˆ°æ•æ„Ÿè¯" do
    content = "è¿™é‡ŒåŒ…å«è¿ç¦è¯å†…å®¹"
    result = ContentModerationService.detect_sensitive_words(content)

    assert result[:score] > 0
    assert_includes result[:words], "è¿ç¦è¯"
    assert result[:positions].any?
  end

  test "æ­£å¸¸å†…å®¹åº”è¯¥é€šè¿‡æ£€æµ‹" do
    content = "è¿™æ˜¯ä¸€ä¸ªæ­£å¸¸çš„å¸–å­å†…å®¹"
    result = ContentModerationService.detect_sensitive_words(content)

    assert_equal 0, result[:score]
    assert_empty result[:words]
  end

  test "åº”è¯¥è®¡ç®—æ•æ„Ÿåº¦åˆ†æ•°" do
    create(:sensitive_word, word: "è½»å¾®è¯", level: 1)
    create(:sensitive_word, word: "ä¸¥é‡è¯", level: 3)

    content = "è½»å¾®è¯å’Œä¸¥é‡è¯æ··åˆå†…å®¹"
    result = ContentModerationService.detect_sensitive_words(content)

    assert result[:score] > 3  # ä¸¥é‡è¯æƒé‡æ›´é«˜
  end

  test "åº”è¯¥å¤„ç†å¤§å°å†™å’Œç©ºæ ¼" do
    variations = [
      "è¿ç¦è¯",
      " è¿ç¦è¯ ",
      "è¿ ç¦ è¯",
      "WEI JIN CI"
    ]

    variations.each do |content|
      result = ContentModerationService.detect_sensitive_words(content)
      assert result[:score] > 0, "åº”è¯¥æ£€æµ‹åˆ°å˜ä½“: #{content}"
    end
  end
end
```

#### 3. æ§åˆ¶å™¨æµ‹è¯•
```ruby
# test/controllers/api/posts_controller_test.rb
require "test_helper"

class Api::PostsControllerTest < ActionDispatch::IntegrationTest
  def setup
    @user = create(:user, :verified)
    @auth_headers = auth_headers_for(@user)
    @category = create(:category)
  end

  test "åº”è¯¥è·å–å¸–å­åˆ—è¡¨" do
    create_list(:post, 5, :published, category: @category)

    get api_posts_path, headers: @auth_headers

    assert_response :success
    json_response = JSON.parse(response.body)
    assert json_response['success']
    assert_equal 5, json_response['data'].length
    assert json_response['pagination'].present?
  end

  test "åº”è¯¥æŒ‰åˆ†ç±»ç­›é€‰å¸–å­" do
    category1 = create(:category)
    category2 = create(:category)

    post1 = create(:post, :published, category: category1)
    post2 = create(:post, :published, category: category2)

    get api_posts_path, params: { category_id: category1.id }, headers: @auth_headers

    json_response = JSON.parse(response.body)
    post_ids = json_response['data'].map { |p| p['id'] }
    assert_includes post_ids, post1.id
    assert_not_includes post_ids, post2.id
  end

  test "åº”è¯¥åˆ›å»ºæ–°å¸–å­" do
    post_params = {
      title: "æµ‹è¯•å¸–å­æ ‡é¢˜",
      content: "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¸–å­çš„å†…å®¹",
      category_id: @category.id
    }

    post api_posts_path, params: { post: post_params }, headers: @auth_headers

    assert_response :created
    json_response = JSON.parse(response.body)
    assert json_response['success']
    assert_equal "æµ‹è¯•å¸–å­æ ‡é¢˜", json_response['data']['title']
    assert_equal "pending_review", json_response['data']['status']
  end

  test "åº”è¯¥éªŒè¯å¿…å¡«å­—æ®µ" do
    post_params = {
      title: "",
      content: "",
      category_id: nil
    }

    post api_posts_path, params: { post: post_params }, headers: @auth_headers

    assert_response :unprocessable_entity
    json_response = JSON.parse(response.body)
    assert_not json_response['success']
    assert json_response['errors'].present?
  end

  test "æœªè®¤è¯ç”¨æˆ·ä¸èƒ½å‘å¸–" do
    post_params = {
      title: "æµ‹è¯•å¸–å­",
      content: "æµ‹è¯•å†…å®¹",
      category_id: @category.id
    }

    post api_posts_path, params: { post: post_params }

    assert_response :unauthorized
  end
end
```

### é›†æˆæµ‹è¯•

#### 1. API é›†æˆæµ‹è¯•
```ruby
# test/integration/post_management_test.rb
require "test_helper"

class PostManagementTest < ActionDispatch::IntegrationTest
  def setup
    @user = create(:user, :verified)
    @auth_headers = auth_headers_for(@user)
    @category = create(:category)
  end

  test "å®Œæ•´çš„å¸–å­å‘å¸ƒæµç¨‹" do
    # 1. ç”¨æˆ·ç™»å½•
    post api_auth_login_path, params: {
      auth: { wx_openid: @user.wx_openid, nickname: @user.nickname }
    }
    assert_response :success

    token = JSON.parse(response.body)['data']['token']
    headers = { 'Authorization' => "Bearer #{token}" }

    # 2. è·å–åˆ†ç±»åˆ—è¡¨
    get api_categories_path, headers: headers
    assert_response :success

    # 3. åˆ›å»ºå¸–å­
    post_params = {
      title: "æˆ‘çš„ç¬¬ä¸€ç¯‡å¸–å­",
      content: "è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ç¯‡å¸–å­å†…å®¹ï¼Œå¸Œæœ›å¤§å®¶å–œæ¬¢ã€‚",
      category_id: @category.id
    }

    post api_posts_path, params: { post: post_params }, headers: headers
    assert_response :created

    post_data = JSON.parse(response.body)['data']
    post_id = post_data['id']

    # 4. è·å–å¸–å­è¯¦æƒ…
    get api_post_path(post_id), headers: headers
    assert_response :success

    # 5. æ·»åŠ è¯„è®º
    comment_params = {
      comment: {
        content: "å¾ˆå¥½çš„å¸–å­ï¼Œæ”¯æŒä¸€ä¸‹ï¼"
      }
    }

    post api_post_comments_path(post_id), params: comment_params, headers: headers
    assert_response :success

    # 6. ç‚¹èµå¸–å­
    post like_api_post_path(post_id), headers: headers
    assert_response :success

    # 7. éªŒè¯ç»Ÿè®¡æ•°æ®æ›´æ–°
    get api_post_path(post_id), headers: headers
    updated_post = JSON.parse(response.body)['data']

    assert_equal 1, updated_post['comments_count']
    assert_equal 1, updated_post['likes_count']
  end

  test "å¸–å­å®¡æ ¸æµç¨‹" do
    # 1. åˆ›å»ºå¸–å­
    post = create(:post, :pending_review, user: @user)

    # 2. ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
    admin = create(:user, :admin)
    admin_headers = auth_headers_for(admin)

    post approve_admin_post_path(post), headers: admin_headers
    assert_response :success

    # 3. éªŒè¯å¸–å­çŠ¶æ€æ›´æ–°
    post.reload
    assert_equal 'published', post.status
  end
end
```

### ç«¯åˆ°ç«¯æµ‹è¯•

#### 1. ç”¨æˆ·å‘å¸–æµç¨‹æµ‹è¯•
```javascript
// tests/e2e/post_creation.spec.js
const { test, expect } = require('@playwright/test');

test.describe('è®ºå›å‘å¸–æµç¨‹', () => {
  test.beforeEach(async ({ page }) => {
    // æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•
    await page.goto('/auth/login');
    await page.fill('[data-testid="openid-input"]', 'test_openid_123');
    await page.click('[data-testid="login-button"]');
    await page.waitForURL('/forum');
  });

  test('ç”¨æˆ·åº”è¯¥èƒ½å¤ŸæˆåŠŸå‘å¸–', async ({ page }) => {
    // 1. ç‚¹å‡»å‘å¸–æŒ‰é’®
    await page.click('[data-testid="create-post-button"]');

    // 2. å¡«å†™å¸–å­ä¿¡æ¯
    await page.fill('[data-testid="post-title"]', 'æˆ‘çš„ç¬¬ä¸€ç¯‡æµ‹è¯•å¸–å­');
    await page.fill('[data-testid="post-content"]', 'è¿™æ˜¯æµ‹è¯•å¸–å­çš„å†…å®¹ï¼Œåº”è¯¥èƒ½å¤Ÿæ­£å¸¸å‘å¸ƒã€‚');

    // 3. é€‰æ‹©åˆ†ç±»
    await page.selectOption('[data-testid="post-category"]', { label: 'è¯»ä¹¦å¿ƒå¾—' });

    // 4. æäº¤å¸–å­
    await page.click('[data-testid="submit-post-button"]');

    // 5. éªŒè¯å‘å¸ƒæˆåŠŸ
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible();
    await expect(page.locator('text=å¸–å­å‘å¸ƒæˆåŠŸï¼Œæ­£åœ¨å®¡æ ¸ä¸­')).toBeVisible();

    // 6. éªŒè¯è·³è½¬åˆ°å¸–å­åˆ—è¡¨
    await expect(page).toHaveURL(/\/forum\/posts$/);
  });

  test('åº”è¯¥éªŒè¯å¿…å¡«å­—æ®µ', async ({ page }) => {
    await page.goto('/forum/posts/new');

    // ä¸å¡«å†™ä»»ä½•å†…å®¹ç›´æ¥æäº¤
    await page.click('[data-testid="submit-post-button"]');

    // éªŒè¯é”™è¯¯æç¤º
    await expect(page.locator('[data-testid="title-error"]')).toBeVisible();
    await expect(page.locator('[data-testid="content-error"]')).toBeVisible();
    await expect(page.locator('[data-testid="category-error"]')).toBeVisible();
  });

  test('åº”è¯¥æ”¯æŒå›¾ç‰‡ä¸Šä¼ ', async ({ page }) => {
    await page.goto('/forum/posts/new');

    // å¡«å†™åŸºæœ¬ä¿¡æ¯
    await page.fill('[data-testid="post-title"]', 'å¸¦å›¾ç‰‡çš„å¸–å­');
    await page.fill('[data-testid="post-content"]', 'è¿™ç¯‡å¸–å­åŒ…å«å›¾ç‰‡ã€‚');

    // ä¸Šä¼ å›¾ç‰‡
    const fileInput = page.locator('[data-testid="image-upload"]');
    await fileInput.setInputFiles('tests/fixtures/test-image.jpg');

    // ç­‰å¾…ä¸Šä¼ å®Œæˆ
    await expect(page.locator('[data-testid="upload-success"]')).toBeVisible();

    // æäº¤å¸–å­
    await page.selectOption('[data-testid="post-category"]', { label: 'è¯»ä¹¦å¿ƒå¾—' });
    await page.click('[data-testid="submit-post-button"]');

    // éªŒè¯å‘å¸ƒæˆåŠŸ
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible();
  });
});
```

#### 2. ç§»åŠ¨ç«¯æµ‹è¯•
```javascript
// tests/e2e/mobile/mobile_forum.spec.js
const { test, expect } = require('@playwright/test');

test.describe('ç§»åŠ¨ç«¯è®ºå›åŠŸèƒ½', () => {
  test.use({ viewport: { width: 375, height: 667 } }); // iPhone X å°ºå¯¸

  test('ç§»åŠ¨ç«¯å‘å¸–ä½“éªŒ', async ({ page }) => {
    // æ¨¡æ‹Ÿç§»åŠ¨ç«¯ç¯å¢ƒ
    await page.emulateMedia({ media: 'screen' });

    // ç™»å½•
    await page.goto('/auth/login');
    await page.fill('[data-testid="openid-input"]', 'mobile_test_user');
    await page.click('[data-testid="login-button"]');

    // éªŒè¯ç§»åŠ¨ç«¯é€‚é…
    await expect(page.locator('[data-testid="mobile-nav"]')).toBeVisible();

    // ç‚¹å‡»æµ®åŠ¨å‘å¸–æŒ‰é’®
    await page.click('[data-testid="floating-post-button"]');

    // éªŒè¯ç§»åŠ¨ç«¯å‘å¸–ç•Œé¢
    await expect(page.locator('[data-testid="mobile-post-form"]')).toBeVisible();

    // å¡«å†™å¹¶å‘å¸–
    await page.fill('[data-testid="mobile-post-title"]', 'ç§»åŠ¨ç«¯æµ‹è¯•å¸–å­');
    await page.fill('[data-testid="mobile-post-content"]', 'è¿™æ˜¯ä»ç§»åŠ¨ç«¯å‘å¸ƒçš„å¸–å­ã€‚');
    await page.selectOption('[data-testid="mobile-post-category"]', { label: 'è¯»ä¹¦å¿ƒå¾—' });

    await page.click('[data-testid="mobile-submit-button"]');

    // éªŒè¯å‘å¸ƒæˆåŠŸ
    await expect(page.locator('[data-testid="mobile-success-toast"]')).toBeVisible();
  });
});
```

### æµ‹è¯•æ•°æ®ç®¡ç†

#### 1. Factory Bot å®šä¹‰
```ruby
# test/factories/users.rb
FactoryBot.define do
  factory :user do
    sequence(:wx_openid) { |n| "test_openid_#{n}" }
    sequence(:nickname) { |n| "æµ‹è¯•ç”¨æˆ·#{n}" }
    avatar_url { "https://example.com/avatar.jpg" }
    bio { "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨æˆ·çš„ç®€ä»‹" }
    level { 1 }
    points { 100 }
    verified { false }
    status { 1 }

    trait :verified do
      verified { true }
      status { 1 }
    end

    trait :admin do
      verified { true }
      after(:create) do |user|
        create(:user_role, user: user, role: create(:role, :admin))
      end
    end

    trait :moderator do
      verified { true }
      after(:create) do |user|
        create(:user_role, user: user, role: create(:role, :moderator))
      end
    end
  end
end

# test/factories/posts.rb
FactoryBot.define do
  factory :post do
    sequence(:title) { |n| "æµ‹è¯•å¸–å­æ ‡é¢˜#{n}" }
    content { "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¸–å­çš„å†…å®¹ï¼ŒåŒ…å«è¶³å¤Ÿçš„æ–‡å­—æ¥æ»¡è¶³ç³»ç»Ÿè¦æ±‚ã€‚" }
    association :category
    association :author, factory: :user, :verified
    status { 'draft' }

    trait :published do
      status { 'published' }
      published_at { 1.day.ago }
    end

    trait :pending_review do
      status { 'pending_review' }
    end

    trait :featured do
      is_featured { true }
      published
    end

    trait :pinned do
      is_pinned { true }
      published
    end

    trait :with_comments do
      after(:create) do |post|
        create_list(:comment, 3, post: post)
      end
    end
  end
end
```

#### 2. æµ‹è¯•æ•°æ®æ¸…ç†
```ruby
# test/support/database_cleaner.rb
class DatabaseCleaner
  def self.clean
    # æ¸…ç†æµ‹è¯•æ•°æ®ï¼Œä¿ç•™åŸºç¡€é…ç½®æ•°æ®
    ActiveRecord::Base.connection.execute("
      TRUNCATE TABLE
        posts, comments, likes, follows, collections,
        user_roles, point_transactions, user_badges,
        reports, moderation_logs, attachments
      RESTART IDENTITY CASCADE;
    ")
  end

  def self.clean_with_seed
    clean
    # åŠ è½½åŸºç¡€æµ‹è¯•æ•°æ®
    Rails.application.load_seed
  end
end

# åœ¨æµ‹è¯•å¥—ä»¶ä¸­ä½¿ç”¨
class ActiveSupport::TestCase
  setup do
    DatabaseCleaner.clean_with_seed
  end

  teardown do
    DatabaseCleaner.clean
  end
end
```

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### å¼€å‘ç¯å¢ƒéƒ¨ç½²

#### 1. æœ¬åœ°å¯åŠ¨è„šæœ¬
```bash
#!/bin/bash
# scripts/start_dev.sh

echo "=== å¯åŠ¨ QQClub è®ºå›å¼€å‘ç¯å¢ƒ ==="

# æ£€æŸ¥ç¯å¢ƒ
echo "æ£€æŸ¥ç¯å¢ƒä¾èµ–..."
ruby -v
rails -v
psql --version
redis-server --version

# å¯åŠ¨æ•°æ®åº“
echo "å¯åŠ¨ PostgreSQL..."
brew services start postgresql@15

# å¯åŠ¨ Redis
echo "å¯åŠ¨ Redis..."
brew services start redis

# æ•°æ®åº“è¿ç§»
echo "æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
rails db:migrate

# åŠ è½½åŸºç¡€æ•°æ®
echo "åŠ è½½åŸºç¡€æ•°æ®..."
rails db:seed

# å¯åŠ¨ Rails æœåŠ¡
echo "å¯åŠ¨ Rails å¼€å‘æœåŠ¡å™¨..."
rails server -p 3000 -d

# å¯åŠ¨ Sidekiq
echo "å¯åŠ¨åå°ä»»åŠ¡å¤„ç†..."
bundle exec sidekiq -d

# å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
echo "å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
cd qqclub-miniprogram
npm run dev:weapp &

echo "=== å¼€å‘ç¯å¢ƒå¯åŠ¨å®Œæˆ ==="
echo "Rails æœåŠ¡: http://localhost:3000"
echo "å°ç¨‹åºå¼€å‘è€…å·¥å…·: è¯·æ‰“å¼€ qqclub-miniprogram ç›®å½•"
echo "Sidekiq Web: http://localhost:3000/sidekiq"
```

### æµ‹è¯•ç¯å¢ƒéƒ¨ç½²

#### 1. Docker Compose é…ç½®
```yaml
# docker-compose.test.yml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.prod
    environment:
      - RAILS_ENV=test
      - DATABASE_URL=postgresql://postgres:password@db:5432/qqclub_test
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY_BASE=test_secret_key_base
    depends_on:
      - db
      - redis
    volumes:
      - .:/app
      - bundle_cache:/usr/local/bundle
    command: >
      sh -c "
        bundle exec rails db:test:prepare &&
        bundle exec rails test &&
        bundle exec rails test:system
      "

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=qqclub_test
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_test_data:/var/lib/postgresql/data

  redis:
    image: redis:7.0-alpine
    volumes:
      - redis_test_data:/data

volumes:
  bundle_cache:
  postgres_test_data:
  redis_test_data:
```

#### 2. CI/CD é…ç½®
```yaml
# .github/workflows/forum_test.yml
name: Forum Module Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'qqclub_api/**'
      - 'qqclub-miniprogram/**'
      - 'docs/modules/forum/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'qqclub_api/**'
      - 'qqclub-miniprogram/**'
      - 'docs/modules/forum/**'

jobs:
  backend_tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: qqclub_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v3

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2.0'
        bundler-cache: true
        working-directory: qqclub_api

    - name: Install dependencies
      working-directory: qqclub_api
      run: |
        bundle install
        yarn install

    - name: Setup database
      working-directory: qqclub_api
      env:
        DATABASE_URL: postgresql://postgres:password@localhost:5432/qqclub_test
        REDIS_URL: redis://localhost:6379/0
      run: |
        bundle exec rails db:create
        bundle exec rails db:schema:load

    - name: Run tests
      working-directory: qqclub_api
      env:
        DATABASE_URL: postgresql://postgres:password@localhost:5432/qqclub_test
        REDIS_URL: redis://localhost:6379/0
        RAILS_ENV: test
      run: |
        bundle exec rails test
        bundle exec rails test:system

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./qqclub_api/coverage/.resultset.json

  frontend_tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: qqclub-miniprogram/package-lock.json

    - name: Install dependencies
      working-directory: qqclub-miniprogram
      run: npm ci

    - name: Run tests
      working-directory: qqclub-miniprogram
      run: npm test

    - name: Build for production
      working-directory: qqclub-miniprogram
      run: npm run build
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### 1. æœåŠ¡å™¨é…ç½®
```bash
#!/bin/bash
# scripts/setup_prod.sh

SERVER_IP="your-server-ip"
APP_NAME="qqclub-forum"
DEPLOY_USER="deploy"

echo "=== é…ç½®ç”Ÿäº§æœåŠ¡å™¨ ==="

# åˆ›å»ºéƒ¨ç½²ç”¨æˆ·
ssh root@$SERVER_IP "useradd -m -s /bin/bash $DEPLOY_USER"
ssh root@$SERVER_IP "usermod -aG sudo $DEPLOY_USER"

# å®‰è£…ç³»ç»Ÿä¾èµ–
ssh root@$SERVER_IP << 'EOF'
apt update && apt upgrade -y
apt install -y curl wget git nginx postgresql redis-server

# å®‰è£… Ruby
gpg --keyserver keyserver.ubuntu.com --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
curl -sSL https://get.rvm.io | bash -s stable --ruby=3.2.0

# å®‰è£… Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt-get install -y nodejs

# é…ç½®é˜²ç«å¢™
ufw allow 22
ufw allow 80
ufw allow 443
ufw --force enable
EOF

# é…ç½®æ•°æ®åº“
ssh root@$SERVER_IP << 'EOF'
sudo -u postgres createuser qqclub
sudo -u postgres createdb qqclub_production
sudo -u postgres psql -c "ALTER USER qqclub PASSWORD 'secure_password';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE qqclub_production TO qqclub;"
EOF

echo "=== ç”Ÿäº§æœåŠ¡å™¨é…ç½®å®Œæˆ ==="
```

#### 2. éƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# scripts/deploy.sh

set -e

SERVER_IP="your-server-ip"
APP_NAME="qqclub-forum"
DEPLOY_USER="deploy"
DEPLOY_PATH="/var/www/$APP_NAME"
BRANCH="main"

echo "=== å¼€å§‹éƒ¨ç½² $APP_NAME ==="

# 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
ssh $DEPLOY_USER@$SERVER_IP "cd $DEPLOY_PATH && ./scripts/backup.sh"

# 2. æ‹‰å–æœ€æ–°ä»£ç 
ssh $DEPLOY_USER@$SERVER_IP "cd $DEPLOY_PATH && git fetch origin && git reset --hard origin/$BRANCH"

# 3. å®‰è£…ä¾èµ–
ssh $DEPLOY_USER@$SERVER_IP << EOF
cd $DEPLOY_PATH
source ~/.rvm/scripts/rvm
bundle install --deployment --without development test
yarn install --production
EOF

# 4. æ•°æ®åº“è¿ç§»
ssh $DEPLOY_USER@$SERVER_IP << EOF
cd $DEPLOY_PATH
source ~/.rvm/scripts/rvm
RAILS_ENV=production bundle exec rails db:migrate
EOF

# 5. é¢„ç¼–è¯‘èµ„æº
ssh $DEPLOY_USER@$SERVER_IP << EOF
cd $DEPLOY_PATH
source ~/.rvm/scripts/rvm
RAILS_ENV=production bundle exec rails assets:precompile
EOF

# 6. é‡å¯æœåŠ¡
ssh $DEPLOY_USER@$SERVER_IP << EOF
cd $DEPLOY_PATH
sudo systemctl restart puma
sudo systemctl restart sidekiq
sudo systemctl reload nginx
EOF

# 7. å¥åº·æ£€æŸ¥
sleep 10
HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://$SERVER_IP/health)
if [ $HEALTH_CHECK -eq 200 ]; then
    echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
else
    echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
    ssh $DEPLOY_USER@$SERVER_IP "cd $DEPLOY_PATH && ./scripts/rollback.sh"
    exit 1
fi

echo "=== éƒ¨ç½²å®Œæˆ ==="
```

#### 3. Nginx é…ç½®
```nginx
# /etc/nginx/sites-available/qqclub-forum
upstream app {
    server unix:///var/www/qqclub-forum/shared/sockets/puma.sock;
}

server {
    listen 80;
    server_name forum.qqclub.com;

    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name forum.qqclub.com;

    # SSL é…ç½®
    ssl_certificate /etc/letsencrypt/live/forum.qqclub.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/forum.qqclub.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;

    # å®‰å…¨å¤´
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # æ—¥å¿—
    access_log /var/log/nginx/qqclub-forum.access.log;
    error_log /var/log/nginx/qqclub-forum.error.log;

    # å®¢æˆ·ç«¯ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 10M;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Rails åº”ç”¨
    location / {
        try_files $uri @app;
    }

    location @app {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;
        proxy_redirect off;
        proxy_pass http://app;
    }

    # API è·¯ç”±
    location /api/ {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;
        proxy_redirect off;
        proxy_pass http://app;

        # API ç‰¹å®šé…ç½®
        proxy_read_timeout 300;
        proxy_connect_timeout 75;
    }

    # é™æ€æ–‡ä»¶
    location ~ ^/(assets|packs|uploads)/ {
        root /var/www/qqclub-forum/current/public;
        expires max;
        add_header Cache-Control public;

        # å°è¯• Gzip ç‰ˆæœ¬
        gzip_static on;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

#### 4. Puma é…ç½®
```ruby
# config/puma.rb
#!/usr/bin/env puma

directory '/var/www/qqclub-forum/current'
environment 'production'

# ç›‘å¬ Unix socket
bind 'unix:///var/www/qqclub-forum/shared/sockets/puma.sock'

# è¿›ç¨‹é…ç½®
workers 2
threads 1, 4

# é¢„åŠ è½½åº”ç”¨
preload_app!

# PID æ–‡ä»¶
pidfile '/var/www/qqclub-forum/shared/pids/puma.pid'

# çŠ¶æ€æ–‡ä»¶
state_path '/var/www/qqclub-forum/shared/pids/puma.state'

# æ—¥å¿—
stdout_redirect '/var/www/qqclub-forum/shared/log/puma.stdout.log', '/var/www/qqclub-forum/shared/log/puma.stderr.log', true

# é›¶åœæœºé‡å¯
on_restart do
  puts 'On restart...'
end

# ä¼˜é›…å…³é—­
on_worker_boot do
  require 'active_record'
  ActiveRecord::Base.connection.disconnect! rescue ActiveRecord::ConnectionNotEstablished
  ActiveRecord::Base.establish_connection
end

# å·¥ä½œè¿›ç¨‹å…³é—­
on_worker_shutdown do
  require 'active_record'
  ActiveRecord::Base.connection.disconnect!
end
```

---

## ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤

### ç³»ç»Ÿç›‘æ§

#### 1. åº”ç”¨ç›‘æ§é…ç½®
```ruby
# config/initializers/monitoring.rb
# Prometheus æŒ‡æ ‡é…ç½®
require 'prometheus_exporter/middleware'

# è‡ªå®šä¹‰æŒ‡æ ‡
POST_COUNTER = PrometheusExporter::Metric::Counter.new(
  "forum_posts_total",
  "Total number of posts created"
)

COMMENT_COUNTER = PrometheusExporter::Metric::Counter.new(
  "forum_comments_total",
  "Total number of comments created"
)

USER_ACTIVE_GAUGE = PrometheusExporter::Metric::Gauge.new(
  "forum_active_users",
  "Number of active users"
)

# æŒ‡æ ‡æ”¶é›†å™¨
class ForumMetricsCollector < PrometheusExporter::Server::Collector
  def collect(obj)
    case obj[:type]
    when 'post_created'
      POST_COUNTER.observe(1, { category: obj[:category] })
    when 'comment_created'
      COMMENT_COUNTER.observe(1)
    when 'user_activity'
      USER_ACTIVE_GAUGE.set(obj[:count])
    end
  end
end

# æ³¨å†Œæ”¶é›†å™¨
PrometheusExporter::Instrumental.register(ForumMetricsCollector.new)
```

#### 2. å¥åº·æ£€æŸ¥ç«¯ç‚¹
```ruby
# app/controllers/health_controller.rb
class HealthController < ApplicationController
  skip_before_action :verify_authenticity_token

  def index
    checks = {
      database: check_database,
      redis: check_redis,
      storage: check_storage,
      background_jobs: check_background_jobs
    }

    status = checks.values.all? { |check| check[:status] == "ok" } ? 200 : 503

    render json: {
      status: status == 200 ? "healthy" : "unhealthy",
      checks: checks,
      timestamp: Time.current.iso8601
    }, status: status
  end

  private

  def check_database
    begin
      ActiveRecord::Base.connection.execute("SELECT 1")
      { status: "ok", message: "Database connection successful" }
    rescue => e
      { status: "error", message: e.message }
    end
  end

  def check_redis
    begin
      Redis.current.ping
      { status: "ok", message: "Redis connection successful" }
    rescue => e
      { status: "error", message: e.message }
    end
  end

  def check_storage
    begin
      # æ£€æŸ¥æ–‡ä»¶å­˜å‚¨è¿æ¥
      CloudStorageClient.test_connection
      { status: "ok", message: "Storage connection successful" }
    rescue => e
      { status: "error", message: e.message }
    end
  end

  def check_background_jobs
    begin
      queue_size = Sidekiq::Queue.new.size
      {
        status: queue_size < 1000 ? "ok" : "warning",
        message: "Background jobs queue size: #{queue_size}"
      }
    rescue => e
      { status: "error", message: e.message }
    end
  end
end
```

### æ—¥å¿—ç®¡ç†

#### 1. ç»“æ„åŒ–æ—¥å¿—
```ruby
# config/initializers/lograge.rb
Rails.application.configure do
  config.lograge.enabled = true
  config.lograge.formatter = Lograge::Formatters::Json.new

  config.lograge.custom_payload do |controller|
    {
      user_id: controller.current_user&.id,
      request_id: request.request_id,
      user_agent: request.user_agent,
      remote_ip: request.remote_ip
    }
  end

  config.lograge.custom_options = lambda do |event|
    {
      params: event.payload[:params]&.except("controller", "action", "format", "utf8"),
      duration: event.duration
    }
  end
end

# è®ºå›ä¸“ç”¨æ—¥å¿—è®°å½•å™¨
class ForumLogger
  class << self
    def post_action(action, post, user = nil)
      Rails.logger.info({
        event: "forum_post_action",
        action: action,
        post_id: post.id,
        user_id: user&.id,
        category_id: post.category_id,
        timestamp: Time.current.iso8601
      }.to_json)
    end

    def moderation_action(action, moderator, target, reason = nil)
      Rails.logger.warn({
        event: "forum_moderation_action",
        action: action,
        moderator_id: moderator.id,
        target_type: target.class.name,
        target_id: target.id,
        reason: reason,
        timestamp: Time.current.iso8601
      }.to_json)
    end

    def security_event(event_type, user, details = {})
      Rails.logger.error({
        event: "forum_security_event",
        type: event_type,
        user_id: user&.id,
        ip_address: details[:ip_address],
        user_agent: details[:user_agent],
        details: details,
        timestamp: Time.current.iso8601
      }.to_json)
    end
  end
end
```

### æ€§èƒ½ä¼˜åŒ–

#### 1. æ•°æ®åº“æ€§èƒ½ç›‘æ§
```ruby
# app/models/concerns/query_performance_monitor.rb
module QueryPerformanceMonitor
  extend ActiveSupport::Concern

  included do
    # æ·»åŠ æŸ¥è¯¢æ€§èƒ½ç›‘æ§
    def self.with_query_monitoring
      start_time = Time.current
      result = yield
      duration = Time.current - start_time

      if duration > 1.second  # è¶…è¿‡1ç§’çš„æŸ¥è¯¢
        Rails.logger.warn({
          event: "slow_query",
          model: name,
          duration: duration,
          query: result.to_sql if result.respond_to?(:to_sql)
        }.to_json)
      end

      result
    end
  end

  class_methods do
    def find_with_monitoring(*args)
      with_query_monitoring { super(*args) }
    end

    def where_with_monitoring(*args)
      with_query_monitoring { super(*args) }
    end
  end
end

# åœ¨å…³é”®æ¨¡å‹ä¸­å¯ç”¨ç›‘æ§
class Post < ApplicationRecord
  include QueryPerformanceMonitor

  # é‡å†™æŸ¥è¯¢æ–¹æ³•
  def self.find_by_id(id)
    find_with_monitoring(id)
  end
end
```

#### 2. ç¼“å­˜ç›‘æ§
```ruby
# app/services/cache_monitor.rb
class CacheMonitor
  class << self
    def track_cache_hit(key, hit: true)
      metric = hit ? :cache_hit : :cache_miss

      Rails.logger.debug({
        event: "cache_access",
        metric: metric,
        key: key,
        timestamp: Time.current.iso8601
      }.to_json)

      # è®°å½•åˆ° Prometheus
      case metric
      when :cache_hit
        Rails.cache.increment("stats:cache_hits")
      when :cache_miss
        Rails.cache.increment("stats:cache_misses")
      end
    end

    def track_cache_write(key, ttl: nil)
      Rails.logger.debug({
        event: "cache_write",
        key: key,
        ttl: ttl,
        timestamp: Time.current.iso8601
      }.to_json)
    end
  end
end

# é‡å†™ç¼“å­˜æ–¹æ³•ä»¥åŒ…å«ç›‘æ§
module CacheWithMonitoring
  def read(key, options = nil)
    result = super(key, options)
    CacheMonitor.track_cache_hit(key, hit: result.present?)
    result
  end

  def write(key, value, options = nil)
    CacheMonitor.track_cache_write(key, ttl: options&.dig(:expires_in))
    super(key, value, options)
  end
end

# åœ¨ Rails åˆå§‹åŒ–æ—¶æ›¿æ¢ç¼“å­˜å®¢æˆ·ç«¯
Rails.cache.extend(CacheWithMonitoring)
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜è§£å†³

#### 1. æ•°æ®åº“è¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
rails db:version

# æ£€æŸ¥æ•°æ®åº“è¿æ¥æ± 
rails runner "puts ActiveRecord::Base.connection_pool.stat"

# é‡å¯æ•°æ®åº“è¿æ¥
rails runner "ActiveRecord::Base.connection.reconnect!"
```

#### 2. å†…å­˜ä½¿ç”¨è¿‡é«˜
```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h
ps aux --sort=-%mem | head

# æ£€æŸ¥ Rails è¿›ç¨‹å†…å­˜
ps aux | grep puma

# é‡å¯åº”ç”¨æœåŠ¡
sudo systemctl restart puma
```

#### 3. åå°ä»»åŠ¡ç§¯å‹
```bash
# æ£€æŸ¥ Sidekiq é˜Ÿåˆ—çŠ¶æ€
bundle exec sidekiq-web
# æˆ–ä½¿ç”¨å‘½ä»¤è¡Œ
bundle exec sidekiqq

# æ¸…ç†å¤±è´¥ä»»åŠ¡
bundle exec sidekiqq clear

# é‡å¯ Sidekiq
sudo systemctl restart sidekiq
```

### åº”æ€¥å“åº”æµç¨‹

#### 1. æœåŠ¡å®•æœºå¤„ç†
```bash
#!/bin/bash
# scripts/emergency_restart.sh

echo "=== åº”æ€¥é‡å¯æœåŠ¡ ==="

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status puma sidekiq nginx

# é‡å¯æœåŠ¡
systemctl restart puma
systemctl restart sidekiq
systemctl reload nginx

# æ£€æŸ¥æœåŠ¡é‡å¯çŠ¶æ€
sleep 10
systemctl status puma sidekiq nginx

# å¥åº·æ£€æŸ¥
curl -f http://localhost/health || {
  echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
  exit 1
}

echo "=== åº”æ€¥é‡å¯å®Œæˆ ==="
```

#### 2. æ•°æ®åº“é—®é¢˜å¤„ç†
```bash
#!/bin/bash
# scripts/database_emergency.sh

echo "=== æ•°æ®åº“åº”æ€¥å¤„ç† ==="

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
pg_isready -h localhost -p 5432

# æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°
psql -U qqclub -d qqclub_production -c "SELECT count(*) FROM pg_stat_activity;"

# ç»ˆæ­¢é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
psql -U qqclub -d qqclub_production -c "
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE state = 'active'
AND query_start < now() - interval '5 minutes'
AND pid <> pg_backend_pid();
"

# é‡å»ºç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰
psql -U qqclub -d qqclub_production -c "REINDEX DATABASE qqclub_production;"

echo "=== æ•°æ®åº“åº”æ€¥å¤„ç†å®Œæˆ ==="
```

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### æ€§èƒ½æŒ‡æ ‡ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰å€¼ | ç›‘æ§æ–¹å¼ |
|------|--------|--------|----------|
| API å“åº”æ—¶é—´ | < 200ms (95%) | - | APM å·¥å…· |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | < 100ms (95%) | - | æ…¢æŸ¥è¯¢æ—¥å¿— |
| é¡µé¢åŠ è½½æ—¶é—´ | < 2s (95%) | - | Web Vitals |
| å¹¶å‘ç”¨æˆ·æ•° | 1000+ | - | è´Ÿè½½æµ‹è¯• |
| ç³»ç»Ÿå¯ç”¨æ€§ | > 99.9% | - | ç›‘æ§å‘Šè­¦ |

### è´Ÿè½½æµ‹è¯•

#### 1. API è´Ÿè½½æµ‹è¯•
```javascript
// tests/performance/api_load_test.js
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate } from 'k6/metrics';

const errorRate = new Rate('errors');

export let options = {
  stages: [
    { duration: '2m', target: 100 }, // 2åˆ†é’Ÿå†…å¢åŠ åˆ°100ç”¨æˆ·
    { duration: '5m', target: 100 }, // ä¿æŒ100ç”¨æˆ·5åˆ†é’Ÿ
    { duration: '2m', target: 200 }, // 2åˆ†é’Ÿå†…å¢åŠ åˆ°200ç”¨æˆ·
    { duration: '5m', target: 200 }, // ä¿æŒ200ç”¨æˆ·5åˆ†é’Ÿ
    { duration: '2m', target: 0 },   // 2åˆ†é’Ÿå†…å‡å°‘åˆ°0ç”¨æˆ·
  ],
  thresholds: {
    http_req_duration: ['p(95)<200'], // 95%çš„è¯·æ±‚åœ¨200mså†…å®Œæˆ
    http_req_failed: ['rate<0.01'],   // é”™è¯¯ç‡ä½äº1%
    errors: ['rate<0.1'],             // è‡ªå®šä¹‰é”™è¯¯ç‡ä½äº10%
  },
};

export default function () {
  // è·å–å¸–å­åˆ—è¡¨
  let listResponse = http.get('http://localhost:3000/api/posts', {
    headers: { 'Authorization': 'Bearer test_token' }
  });

  let listOk = check(listResponse, {
    'è·å–å¸–å­åˆ—è¡¨çŠ¶æ€ä¸º200': (r) => r.status === 200,
    'è·å–å¸–å­åˆ—è¡¨å“åº”æ—¶é—´<200ms': (r) => r.timings.duration < 200,
  });

  errorRate.add(!listOk);

  // è·å–å¸–å­è¯¦æƒ…
  let detailResponse = http.get('http://localhost:3000/api/posts/1', {
    headers: { 'Authorization': 'Bearer test_token' }
  });

  let detailOk = check(detailResponse, {
    'è·å–å¸–å­è¯¦æƒ…çŠ¶æ€ä¸º200': (r) => r.status === 200,
    'è·å–å¸–å­è¯¦æƒ…å“åº”æ—¶é—´<200ms': (r) => r.timings.duration < 200,
  });

  errorRate.add(!detailOk);

  sleep(1);
}
```

#### 2. å‰ç«¯æ€§èƒ½æµ‹è¯•
```javascript
// tests/performance/frontend_performance.js
const { chromium } = require('playwright');

async function measurePagePerformance() {
  const browser = await chromium.launch();
  const page = await browser.newPage();

  // ç›‘å¬æ€§èƒ½æŒ‡æ ‡
  const metrics = await page.evaluate(() => {
    return new Promise((resolve) => {
      const observer = new PerformanceObserver((list) => {
        const entries = list.getEntries();
        const navigation = entries.find(entry => entry.entryType === 'navigation');
        if (navigation) {
          resolve({
            domContentLoaded: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
            loadComplete: navigation.loadEventEnd - navigation.loadEventStart,
            firstPaint: performance.getEntriesByName('first-paint')[0]?.startTime,
            firstContentfulPaint: performance.getEntriesByName('first-contentful-paint')[0]?.startTime,
          });
        }
      });
      observer.observe({ entryTypes: ['navigation', 'paint'] });
    });
  });

  await browser.close();
  return metrics;
}

async function runPerformanceTest() {
  console.log('å¼€å§‹å‰ç«¯æ€§èƒ½æµ‹è¯•...');

  const metrics = await measurePagePerformance();

  console.log('æ€§èƒ½æŒ‡æ ‡:');
  console.log(`DOM å†…å®¹åŠ è½½: ${metrics.domContentLoaded}ms`);
  console.log(`é¡µé¢å®Œå…¨åŠ è½½: ${metrics.loadComplete}ms`);
  console.log(`é¦–æ¬¡ç»˜åˆ¶: ${metrics.firstPaint}ms`);
  console.log(`é¦–æ¬¡å†…å®¹ç»˜åˆ¶: ${metrics.firstContentfulPaint}ms`);

  // æ£€æŸ¥æ˜¯å¦ç¬¦åˆæ€§èƒ½ç›®æ ‡
  const targets = {
    domContentLoaded: 1000,
    loadComplete: 2000,
    firstPaint: 800,
    firstContentfulPaint: 1200,
  };

  for (const [metric, target] of Object.entries(targets)) {
    if (metrics[metric] > target) {
      console.warn(`âš ï¸  ${metric} è¶…å‡ºç›®æ ‡å€¼: ${metrics[metric]}ms > ${target}ms`);
    } else {
      console.log(`âœ… ${metric} ç¬¦åˆç›®æ ‡: ${metrics[metric]}ms <= ${target}ms`);
    }
  }
}

runPerformanceTest().catch(console.error);
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

### è®ºå›æ¨¡å—å†…éƒ¨æ–‡æ¡£
- **[è®ºå›æ€»è§ˆ](forum-overview.md)** - æ¨¡å—æ•´ä½“ä»‹ç»
- **[è®ºå›ä¸šåŠ¡è®¾è®¡](forum-business.md)** - ä¸šåŠ¡æµç¨‹å’Œè§„åˆ™è®¾è®¡
- **[è®ºå›æŠ€æœ¯è®¾è®¡](forum-technical.md)** - ç³»ç»Ÿæ¶æ„å’ŒæŠ€æœ¯å®ç°
- **[è®ºå›APIè§„èŒƒ](forum-api.md)** - APIæ¥å£æ–‡æ¡£
- **[è®ºå›æ•°æ®åº“è®¾è®¡](forum-database.md)** - æ•°æ®æ¨¡å‹å’Œè¡¨ç»“æ„
- **[è®ºå›ç”¨æˆ·ä½“éªŒè®¾è®¡](forum-ux.md)** - ç•Œé¢è®¾è®¡å’Œäº¤äº’æµç¨‹

### å¼€å‘å’Œéƒ¨ç½²æ–‡æ¡£
- **[ç³»ç»Ÿæ¶æ„è®¾è®¡](../../technical/ARCHITECTURE.md)** - æ•´ä½“æŠ€æœ¯æ¶æ„
- **[å¼€å‘ç¯å¢ƒæ­å»º](../../development/SETUP_GUIDE.md)** - æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®
- **[éƒ¨ç½²æŒ‡å—](../../deployment/DEPLOYMENT.md)** - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æµç¨‹
- **[è¿ç»´æ‰‹å†Œ](../../operations/OPERATIONS.md)** - ç³»ç»Ÿè¿ç»´å’Œç›‘æ§

---

*æœ¬æ–‡æ¡£æœ€åæ›´æ–°: 2025-10-17*