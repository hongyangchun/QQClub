# QQClub 读书社区 - 系统架构概览

## 📋 文档说明

**定位**: 系统整体架构概览，帮助读者快速理解 QQClub 的技术架构和设计思路
**目标读者**: 产品经理、项目管理者、新加入开发者、技术决策者
**文档深度**: 高层架构设计，不涉及具体实现细节

---

## 🏗️ 整体架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                    微信生态                              │
│  ┌──────────────┐      ┌──────────────┐                │
│  │  微信小程序   │      │   微信支付    │                │
│  │  (前端UI)    │      │   (可选)     │                │
│  └──────┬───────┘      └──────────────┘                │
│         │                                               │
└─────────┼───────────────────────────────────────────────┘
          │ HTTPS/JSON
          │
┌─────────▼───────────────────────────────────────────────┐
│              Rails 8 API 后端                            │
│  ┌──────────────────────────────────────────────────┐  │
│  │  API Controllers (JSON only)                     │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  Business Logic (Service Objects)                │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  Models (Active Record)                          │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  Authentication (JWT + 微信 OpenID)              │  │
│  └──────────────────────────────────────────────────┘  │
│                                                          │
│  Rails 8 核心特性:                                       │
│  • Solid Queue (后台任务)                                │
│  • Solid Cache (缓存)                                    │
│  • Action Mailer (邮件通知)                              │
└──────────────────┬───────────────────────────────────────┘
                   │
┌──────────────────▼───────────────────────────────────────┐
│              数据库 (SQLite/PostgreSQL)                   │
└──────────────────────────────────────────────────────────┘
```

### 前端架构图

```
┌─────────────────────────────────────────────────────────┐
│                    微信小程序前端                           │
│  ┌──────────────────────────────────────────────────┐  │
│  │              应用层 (App.js)                         │  │
│  │  ├─ 生命周期管理                                     │  │
│  │  ├─ 全局状态管理                                     │  │
│  │  ├─ 网络请求封装                                     │  │
│  │  └─ 用户认证管理                                     │  │
│  └──────────────────────────────────────────────────┘  │
│                          │                                   │
│  ┌──────────────────────────────────────────────────┐  │
│  │              页面层 (Pages)                            │  │
│  │  ├─ index/        (首页)                           │  │
│  │  ├─ auth/         (登录认证)                       │  │
│  │  ├─ profile/      (个人中心)                       │  │
│  │  ├─ forum/        (论坛页面)                       │  │
│  │  └─ activities/   (活动页面)                       │  │
│  └──────────────────────────────────────────────────┘  │
│                          │                                   │
│  ┌──────────────────────────────────────────────────┐  │
│  │              服务层 (Services)                         │  │
│  │  ├─ api.js        (API调用封装)                     │  │
│  │  ├─ util.js       (工具函数库)                       │  │
│  │  └─ storage.js    (本地存储管理)                   │  │
│  └──────────────────────────────────────────────────┘  │
│                          │ HTTPS/JSON                       │
│                          ▼                                   │
│  ┌──────────────────────────────────────────────────┐  │
│  │              Rails 8 API 后端                          │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 🔧 技术栈选择

### 后端技术栈

| 技术 | 版本 | 选择理由 |
|------|------|----------|
| **框架** | Ruby on Rails 8.0 | 成熟、高效、约定优于配置 |
| **API 模式** | `--api` 模式 | 纯 API，去除不必要的 View 层 |
| **数据库** | SQLite (开发) / PostgreSQL (生产) | Rails 8 的 SQLite 生产就绪，但建议生产用 PG |
| **认证** | JWT + `jwt` gem | 适合移动端/小程序的无状态认证 |
| **微信集成** | `rest-client` gem | 调用微信 API (code2session 等) |
| **后台任务** | Solid Queue | Rails 8 内置，无需 Redis |
| **缓存** | Solid Cache | Rails 8 内置，无需 Redis |
| **文件存储** | Active Storage + 云存储 | 小程序上传图片、书籍封面等 |
| **部署** | Kamal 2 | Rails 8 内置，零停机部署 |

### 前端技术栈

| 技术 | 选择理由 |
|------|----------|
| **框架** | 微信小程序原生 | 无需额外框架，微信生态最佳实践 |
| **组件化架构** | 模块化UI组件设计 | 可复用、易维护的组件体系 |
| **服务层模式** | API调用和业务逻辑分离 | 清晰的架构分层和职责划分 |
| **统一设计系统** | CSS变量和样式规范 | 一致的视觉体验和品牌形象 |
| **工具函数库** | 通用功能和业务逻辑封装 | 提高开发效率和代码复用 |
| **HTTP 请求** | `wx.request` (封装) | 小程序原生 API，统一的请求处理 |
| **本地存储** | `wx.storage` | 缓存用户 token 和状态信息 |

---

## 👥 权限体系架构

### 权限层级概览

QQClub 采用简化的 3 层权限体系：

```
Admin Level (管理员级别)
├── Root (超级管理员) - 系统开发者
├── Admin (管理员) - 社区管理者
│   ├── 系统管理权限
│   ├── 用户管理权限
│   └── 内容审核权限
│
Event Level (活动级别)
├── Group Leader (小组长) - 活动创建者
├── Daily Leader (领读人) - 每日活动负责人
│   ├── 领读内容管理权限
│   ├── 打卡内容管理权限
│   └── 小红花评选权限
│
User Level (用户级别)
├── Forum User (论坛用户) - 基础权限
├── Participant (活动参与者) - 报名用户
│   ├── 论坛发帖评论权限
│   ├── 活动报名权限
│   └── 个人打卡权限
```

### 权限矩阵概览

| 操作类型 | Root | Admin | Group Leader | Daily Leader | Forum User | Participant |
|----------|------|-------|--------------|--------------|------------|-------------|
| **系统管理** | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| **用户管理** | ✅ | 部分 | ❌ | ❌ | ❌ | ❌ |
| **活动审批** | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| **论坛管理** | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| **活动创建** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **活动管理** | ✅ | ✅ | ✅(自己的) | ❌ | ❌ | ❌ |
| **内容管理** | ✅ | ✅ | ✅(全程) | ✅(3天窗口) | ❌ | ✅(自己的) |

---

## 📦 核心功能模块

### 功能模块概览

| 模块 | 核心功能 | 主要用户 |
|------|----------|----------|
| **用户认证** | 微信登录、JWT认证、用户信息管理 | 所有用户 |
| **论坛系统** | 发帖、评论、置顶、隐藏 | 所有用户 |
| **活动管理** | 创建活动、报名、审批、日程安排 | 所有用用户 |
| **阅读计划** | 阅读进度、领读内容、每日任务 | 参与者、领读人 |
| **打卡系统** | 每日打卡、补卡、内容统计 | 参与者 |
| **小红花** | 发放、评选、排行榜 | 领读人、参与者 |
| **统计结算** | 完成率、押金计算、活动总结 | 小组长、管理员 |

### 数据流架构

```
用户行为
    │
    ▼
前端页面 (微信小程序)
    │
    ▼ HTTP/JSON API
Rails API 后端
    │
    ├─► 权限验证
    ├─► 业务逻辑处理 (Service Objects)
    ├─► 数据验证 (Models)
    └─► 数据持久化 (PostgreSQL)
    │
    ▼
响应数据
    │
    ▼
前端页面更新
```

---

## 🔐 安全架构

### 安全层次

1. **认证层**
   - JWT Token 认证
   - 微信 OAuth2 集成
   - Token 过期机制

2. **权限层**
   - 基于角色的访问控制 (RBAC)
   - 资源级别权限检查
   - 时间窗口权限控制

3. **数据层**
   - 输入参数验证
   - SQL 注入防护
   - 敏感数据加密

4. **传输层**
   - HTTPS 强制加密
   - API 参数签名验证
   - 微信小程序安全域名

---

## 🚀 部署架构

### 部署架构图

```
开发环境
┌─────────────────┐
│ 本地开发环境     │
│ • Rails 8 API   │
│ • SQLite        │
│ • 微信开发者工具 │
└─────────────────┘
         │
         ▼
生产环境
┌─────────────────┐
│ 云服务器         │
│ • Kamal 2 部署  │
│ • PostgreSQL    │
│ • Nginx         │
│ • SSL 证书      │
└─────────────────┘
         │
         ▼
微信生态
┌─────────────────┐
│ 微信小程序       │
│ • 小程序发布     │
│ • 微信支付      │
│ • 模板消息      │
└─────────────────┘
```

### 自动化部署

- **部署工具**: Kamal 2 + QQClub Deploy
- **CI/CD**: 自动化测试和部署流水线
- **监控**: 应用性能监控和错误追踪
- **备份**: 自动化数据库备份和恢复

---

## 📊 性能架构

### 前端性能

- **加载优化**: 分包加载、图片懒加载
- **缓存策略**: 本地缓存、API 响应缓存
- **交互优化**: 防抖节流、骨架屏

### 后端性能

- **数据库优化**: 索引设计、查询优化
- **缓存策略**: Solid Cache、热点数据缓存
- **API 性能**: 分页查询、字段选择性返回

---

## 📖 相关文档

| 文档名称 | 用途 | 深度 |
|----------|------|------|
| [API_REFERENCE.md](./API_REFERENCE.md) | API 接口详细规格 | 开发者级别 |
| [TECHNICAL_DESIGN.md](./TECHNICAL_DESIGN.md) | 技术实现细节 | 架构师级别 |
| [DATABASE_DESIGN.md](./DATABASE_DESIGN.md) | 数据库设计详解 | DBA 级别 |
| [PERMISSIONS_GUIDE.md](./PERMISSIONS_GUIDE.md) | 权限系统使用指南 | 用户级别 |
| [TESTING_GUIDE.md](./TESTING_GUIDE.md) | 测试框架和规范 | 测试者级别 |

---

*本文档最后更新: 2025-10-16*