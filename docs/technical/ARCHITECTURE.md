# QQClub è¯»ä¹¦ç¤¾ç¾¤ - æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## ä¸€ã€æ•´ä½“æ¶æ„

### æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¾®ä¿¡ç”Ÿæ€                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  å¾®ä¿¡å°ç¨‹åº   â”‚      â”‚   å¾®ä¿¡æ”¯ä»˜    â”‚                â”‚
â”‚  â”‚  (å‰ç«¯UI)    â”‚      â”‚   (å¯é€‰)     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ HTTPS/JSON
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Rails 8 API åç«¯                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Controllers (JSON only)                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Business Logic (Service Objects)                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Models (Active Record)                          â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Authentication (JWT + å¾®ä¿¡ OpenID)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  Rails 8 æ ¸å¿ƒç‰¹æ€§:                                       â”‚
â”‚  â€¢ Solid Queue (åå°ä»»åŠ¡)                                â”‚
â”‚  â€¢ Solid Cache (ç¼“å­˜)                                    â”‚
â”‚  â€¢ Action Mailer (é‚®ä»¶é€šçŸ¥)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åº“ (SQLite/PostgreSQL)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æŠ€æœ¯æ ˆé€‰æ‹©

### åç«¯æŠ€æœ¯æ ˆ
| æŠ€æœ¯ | é€‰æ‹© | ç†ç”± |
|------|------|------|
| **æ¡†æ¶** | Ruby on Rails 8.0 | æˆç†Ÿã€é«˜æ•ˆã€çº¦å®šä¼˜äºé…ç½® |
| **API æ¨¡å¼** | `--api` æ¨¡å¼ | çº¯ APIï¼Œå»é™¤ä¸å¿…è¦çš„ View å±‚ |
| **æ•°æ®åº“** | SQLite (å¼€å‘) / PostgreSQL (ç”Ÿäº§) | Rails 8 çš„ SQLite ç”Ÿäº§å°±ç»ªï¼Œä½†å»ºè®®ç”Ÿäº§ç”¨ PG |
| **è®¤è¯** | JWT + `jwt` gem | é€‚åˆç§»åŠ¨ç«¯/å°ç¨‹åºçš„æ— çŠ¶æ€è®¤è¯ |
| **å¾®ä¿¡é›†æˆ** | `rest-client` gem | è°ƒç”¨å¾®ä¿¡ API (code2session ç­‰) |
| **åå°ä»»åŠ¡** | Solid Queue | Rails 8 å†…ç½®ï¼Œæ— éœ€ Redis |
| **ç¼“å­˜** | Solid Cache | Rails 8 å†…ç½®ï¼Œæ— éœ€ Redis |
| **æ–‡ä»¶å­˜å‚¨** | Active Storage + äº‘å­˜å‚¨ (è…¾è®¯äº‘ COS) | å°ç¨‹åºä¸Šä¼ å›¾ç‰‡ã€ä¹¦ç±å°é¢ç­‰ |
| **éƒ¨ç½²** | Kamal 2 | Rails 8 å†…ç½®ï¼Œé›¶åœæœºéƒ¨ç½² |

### å‰ç«¯æŠ€æœ¯æ ˆ
| æŠ€æœ¯ | é€‰æ‹© | ç†ç”± |
|------|------|------|
| **æ¡†æ¶** | å¾®ä¿¡å°ç¨‹åºåŸç”Ÿ | æ— éœ€é¢å¤–æ¡†æ¶ï¼Œå¾®ä¿¡ç”Ÿæ€æœ€ä½³å®è·µ |
| **UI ç»„ä»¶åº“** | Vant Weapp | æˆç†Ÿçš„å°ç¨‹åº UI ç»„ä»¶åº“ |
| **çŠ¶æ€ç®¡ç†** | MobX (å¯é€‰) | å¦‚æœä¸šåŠ¡å¤æ‚å¯å¼•å…¥ |
| **HTTP è¯·æ±‚** | `wx.request` (å°è£…) | å°ç¨‹åºåŸç”Ÿ API |
| **æœ¬åœ°å­˜å‚¨** | `wx.storage` | ç¼“å­˜ç”¨æˆ· token ç­‰ |

---

## ä¸‰ã€æƒé™ä½“ç³»æ¶æ„

### 3.1 æƒé™å±‚çº§æ¦‚è§ˆ

QQClub é‡‡ç”¨ç®€åŒ–çš„ 3 å±‚æƒé™ä½“ç³»ï¼š

```
Admin Level (ç®¡ç†å‘˜çº§åˆ«)
â”œâ”€â”€ Root (è¶…çº§ç®¡ç†å‘˜) - ç³»ç»Ÿå¼€å‘è€…
â”œâ”€â”€ Admin (ç®¡ç†å‘˜) - ç¤¾åŒºç®¡ç†è€…
â”‚   â”œâ”€â”€ ç³»ç»Ÿç®¡ç†æƒé™
â”‚   â”œâ”€â”€ ç”¨æˆ·ç®¡ç†æƒé™
â”‚   â””â”€â”€ å†…å®¹å®¡æ ¸æƒé™
â”‚
Event Level (æ´»åŠ¨çº§åˆ«)
â”œâ”€â”€ Group Leader (å°ç»„é•¿) - æ´»åŠ¨åˆ›å»ºè€…
â”œâ”€â”€ Daily Leader (é¢†è¯»äºº) - æ¯æ—¥æ´»åŠ¨è´Ÿè´£äºº
â”‚   â”œâ”€â”€ é¢†è¯»å†…å®¹ç®¡ç†æƒé™
â”‚   â”œâ”€â”€ æ‰“å¡å†…å®¹ç®¡ç†æƒé™
â”‚   â””â”€â”€ å°çº¢èŠ±è¯„é€‰æƒé™
â”‚
User Level (ç”¨æˆ·çº§åˆ«)
â”œâ”€â”€ Forum User (è®ºå›ç”¨æˆ·) - åŸºç¡€æƒé™
â”œâ”€â”€ Participant (æ´»åŠ¨å‚ä¸è€…) - æŠ¥åç”¨æˆ·
â”‚   â”œâ”€â”€ è®ºå›å‘å¸–è¯„è®ºæƒé™
â”‚   â”œâ”€â”€ æ´»åŠ¨æŠ¥åæƒé™
â”‚   â””â”€â”€ ä¸ªäººæ‰“å¡æƒé™
```

### 3.2 æƒé™å®ç°æœºåˆ¶

#### åŸºäºè§’è‰²çš„æƒé™æ£€æŸ¥
```ruby
# app/models/user.rb
class User < ApplicationRecord
  enum :role, {
    user: 0,           # åŸºç¡€ç”¨æˆ·ï¼ˆè®ºå›ç”¨æˆ· + æ´»åŠ¨å‚ä¸è€…ï¼‰
    admin: 1,          # ç®¡ç†å‘˜
    root: 2            # è¶…çº§ç®¡ç†å‘˜ï¼ˆç³»ç»Ÿå¼€å‘è€…ï¼‰
  }

  # ç®¡ç†å‘˜çº§åˆ«æƒé™
  def any_admin?
    admin? || root?
  end

  def can_approve_events?
    admin? || root?
  end

  def can_manage_users?
    root?
  end

  def can_view_admin_panel?
    admin? || root?
  end

  # æ´»åŠ¨çº§åˆ«æƒé™
  def can_manage_event_content?(event, schedule)
    return true if any_admin?  # ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
    return true if event.leader_id == id  # å°ç»„é•¿æƒé™

    # é¢†è¯»äººæƒé™æ£€æŸ¥ï¼ˆ3å¤©çª—å£ï¼‰
    if schedule&.daily_leader_id == id
      permission_window = 1.day  # å¯é…ç½®
      schedule_date = schedule.date

      return true if Date.current >= (schedule_date - permission_window)
      return true if Date.current <= (schedule_date + permission_window)
    end

    false
  end
end
```

#### æƒé™éªŒè¯ Concern
```ruby
# app/controllers/concerns/admin_authorizable.rb
module AdminAuthorizable
  extend ActiveSupport::Concern

  def authenticate_admin!
    return render json: { error: "éœ€è¦ç®¡ç†å‘˜æƒé™" }, status: :forbidden unless current_user&.any_admin?
  end

  def authenticate_root!
    return render json: { error: "éœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™" }, status: :forbidden unless current_user&.root?
  end

  def authenticate_event_leader!(event)
    unless current_user&.can_manage_event_content?(event, @schedule)
      render json: { error: "æƒé™ä¸è¶³" }, status: :forbidden
    end
  end
end
```

### 3.3 æƒé™çŸ©é˜µ

| æ“ä½œ | Root | Admin | Group Leader | Daily Leader | Forum User | Participant |
|------|------|-------|--------------|--------------|------------|-------------|
| ç³»ç»Ÿç®¡ç† | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ |
| ç”¨æˆ·ç®¡ç† | âœ… | éƒ¨åˆ† | âŒ | âŒ | âŒ | âŒ |
| æ´»åŠ¨å®¡æ‰¹ | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| è®ºå›ç®¡ç† | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| æ´»åŠ¨åˆ›å»º | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| æ´»åŠ¨ç®¡ç† | âœ… | âœ… | âœ…(è‡ªå·±çš„) | âŒ | âŒ | âŒ |
| é¢†è¯»å†…å®¹ | âœ… | âœ… | âœ…(å…¨ç¨‹) | âœ…(3å¤©çª—å£) | âŒ | âŒ |
| æ‰“å¡ç®¡ç† | âœ… | âœ… | âœ…(å…¨ç¨‹) | âœ…(3å¤©çª—å£) | âŒ | âœ…(è‡ªå·±çš„) |
| å°çº¢èŠ±è¯„é€‰ | âœ… | âœ… | âœ…(å…¨ç¨‹) | âœ…(3å¤©çª—å£) | âŒ | âŒ |
| è®ºå›å‘å¸– | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| æ´»åŠ¨æŠ¥å | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |

---

## å››ã€æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è®¾è®¡

### æ¨¡å— 1ï¼šç”¨æˆ·è®¤è¯ï¼ˆå¾®ä¿¡ç™»å½•ï¼‰

#### æµç¨‹å›¾
```
[å°ç¨‹åº]                [Rails API]              [å¾®ä¿¡æœåŠ¡å™¨]
    â”‚                        â”‚                        â”‚
    â”‚  wx.login()            â”‚                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                        â”‚
    â”‚  â† code                â”‚                        â”‚
    â”‚                        â”‚                        â”‚
    â”‚  POST /api/auth/login  â”‚                        â”‚
    â”‚  { code }              â”‚                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                        â”‚
    â”‚                        â”‚                        â”‚
    â”‚                        â”‚  GET code2session      â”‚
    â”‚                        â”‚  code + appid + secret â”‚
    â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                        â”‚  â† openid + session_keyâ”‚
    â”‚                        â”‚                        â”‚
    â”‚                        â”‚  æŸ¥æ‰¾/åˆ›å»º User        â”‚
    â”‚                        â”‚  ç”Ÿæˆ JWT token        â”‚
    â”‚                        â”‚                        â”‚
    â”‚  â† JWT token           â”‚                        â”‚
    â”‚  { token, user_info }  â”‚                        â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
    â”‚                        â”‚                        â”‚
    â”‚  åç»­è¯·æ±‚å¸¦ token       â”‚                        â”‚
    â”‚  Authorization: Bearer â”‚                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                        â”‚
```

#### æ•°æ®æ¨¡å‹
```ruby
# app/models/user.rb
class User < ApplicationRecord
  # å¾®ä¿¡ç›¸å…³
  validates :wx_openid, presence: true, uniqueness: true
  validates :wx_unionid, uniqueness: true, allow_nil: true

  # åŸºç¡€ä¿¡æ¯
  validates :nickname, presence: true

  # å…³è”å…³ç³»
  has_many :created_events, class_name: 'ReadingEvent', foreign_key: 'leader_id'
  has_many :enrollments
  has_many :reading_events, through: :enrollments
  has_many :check_ins
  has_many :flowers_received, class_name: 'Flower', foreign_key: 'recipient_id'

  # ç”Ÿæˆ JWT token
  def generate_jwt_token
    JWT.encode(
      { user_id: id, exp: 30.days.from_now.to_i },
      Rails.application.credentials.jwt_secret_key
    )
  end
end
```

#### API ç«¯ç‚¹
```
POST   /api/auth/login          å¾®ä¿¡ç™»å½•
GET    /api/auth/me             è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
PUT    /api/auth/profile        æ›´æ–°ç”¨æˆ·èµ„æ–™
```

---

### æ¨¡å— 2ï¼šå…±è¯»æ´»åŠ¨ç®¡ç†

#### æ•°æ®æ¨¡å‹
```ruby
# app/models/reading_event.rb
class ReadingEvent < ApplicationRecord
  belongs_to :leader, class_name: 'User'
  has_many :enrollments, dependent: :destroy
  has_many :participants, through: :enrollments, source: :user
  has_many :reading_schedules, dependent: :destroy

  validates :title, presence: true
  validates :book_name, presence: true
  validates :start_date, :end_date, presence: true
  validates :max_participants, numericality: { greater_than: 0 }
  validates :enrollment_fee, numericality: { greater_than_or_equal_to: 0 }

  enum status: { draft: 0, enrolling: 1, in_progress: 2, completed: 3 }

  # è®¡ç®—ç›¸å…³
  def service_fee
    enrollment_fee * 0.2
  end

  def deposit
    enrollment_fee * 0.8
  end

  def days_count
    (end_date - start_date).to_i + 1
  end
end

# app/models/enrollment.rb
class Enrollment < ApplicationRecord
  belongs_to :user
  belongs_to :reading_event

  validates :user_id, uniqueness: { scope: :reading_event_id }

  enum payment_status: { unpaid: 0, paid: 1, refunded: 2 }
  enum role: { participant: 0, leader: 1 }

  # è®¡ç®—æ‰“å¡å®Œæˆç‡
  def completion_rate
    total_days = reading_event.reading_schedules.count
    return 0 if total_days.zero?

    completed_days = check_ins.where.not(status: 'missed').count
    (completed_days.to_f / total_days * 100).round(2)
  end

  # è®¡ç®—åº”é€€æŠ¼é‡‘
  def refund_amount
    reading_event.deposit * (completion_rate / 100.0)
  end
end
```

#### API ç«¯ç‚¹
```
# æ´»åŠ¨ç®¡ç†
GET    /api/events              è·å–æ´»åŠ¨åˆ—è¡¨
GET    /api/events/:id          è·å–æ´»åŠ¨è¯¦æƒ…
POST   /api/events              åˆ›å»ºæ´»åŠ¨ï¼ˆå°ç»„é•¿ï¼‰
PUT    /api/events/:id          æ›´æ–°æ´»åŠ¨
DELETE /api/events/:id          åˆ é™¤æ´»åŠ¨

# æŠ¥åç®¡ç†
POST   /api/events/:id/enroll   æŠ¥åå‚åŠ æ´»åŠ¨
GET    /api/events/:id/participants  è·å–å‚ä¸è€…åˆ—è¡¨
```

---

### æ¨¡å— 3ï¼šé˜…è¯»è®¡åˆ’ä¸é¢†è¯»

#### æ•°æ®æ¨¡å‹
```ruby
# app/models/reading_schedule.rb
class ReadingSchedule < ApplicationRecord
  belongs_to :reading_event
  belongs_to :daily_leader, class_name: 'User', optional: true
  has_one :daily_leading
  has_many :check_ins, dependent: :destroy

  validates :day_number, presence: true
  validates :reading_progress, presence: true

  scope :today, -> { where(date: Date.today) }
  scope :past, -> { where('date < ?', Date.today) }
  scope :future, -> { where('date > ?', Date.today) }
end

# app/models/daily_leading.rb
class DailyLeading < ApplicationRecord
  belongs_to :reading_schedule
  belongs_to :leader, class_name: 'User'

  validates :reading_suggestion, presence: true
  validates :questions, presence: true

  # questions å­˜å‚¨ä¸º JSON array
  # ä¾‹å¦‚: ["é—®é¢˜1", "é—®é¢˜2", "é—®é¢˜3"]
end
```

#### API ç«¯ç‚¹
```
# é˜…è¯»è®¡åˆ’
GET    /api/events/:id/schedules        è·å–æ´»åŠ¨çš„é˜…è¯»è®¡åˆ’
POST   /api/events/:id/schedules        åˆ›å»ºé˜…è¯»è®¡åˆ’ï¼ˆå°ç»„é•¿ï¼‰
PUT    /api/schedules/:id               æ›´æ–°è®¡åˆ’

# é¢†è¯»
POST   /api/schedules/:id/leading       å‘å¸ƒé¢†è¯»å†…å®¹
GET    /api/schedules/:id/leading       è·å–é¢†è¯»å†…å®¹
POST   /api/schedules/:id/claim_leader  è®¤é¢†é¢†è¯»äºº
```

---

### æ¨¡å— 4ï¼šæ‰“å¡ç³»ç»Ÿ

#### æ•°æ®æ¨¡å‹
```ruby
# app/models/check_in.rb
class CheckIn < ApplicationRecord
  belongs_to :user
  belongs_to :reading_schedule
  belongs_to :enrollment
  has_one :flower, dependent: :destroy

  validates :content, presence: true, length: { minimum: 100 }
  validates :user_id, uniqueness: { scope: :reading_schedule_id }

  enum status: { normal: 0, makeup: 1, missed: 2 }

  # æ˜¯å¦å¯ä»¥è¡¥å¡
  def can_makeup?
    reading_schedule.reading_event.status == 'in_progress' &&
    reading_schedule.date < Date.today
  end

  # æ˜¯å¦è·å¾—å°çº¢èŠ±
  def has_flower?
    flower.present?
  end
end
```

#### API ç«¯ç‚¹
```
# æ‰“å¡
POST   /api/schedules/:id/check_in      æäº¤æ‰“å¡
GET    /api/schedules/:id/check_ins     è·å–å½“æ—¥æ‰€æœ‰æ‰“å¡
GET    /api/check_ins/:id               è·å–æ‰“å¡è¯¦æƒ…
PUT    /api/check_ins/:id               æ›´æ–°æ‰“å¡ï¼ˆè¡¥å¡ï¼‰

# æˆ‘çš„æ‰“å¡è®°å½•
GET    /api/events/:id/my_check_ins     æˆ‘åœ¨æŸæ´»åŠ¨çš„æ‰“å¡è®°å½•
```

---

### æ¨¡å— 5ï¼šå°çº¢èŠ±ç³»ç»Ÿ

#### æ•°æ®æ¨¡å‹
```ruby
# app/models/flower.rb
class Flower < ApplicationRecord
  belongs_to :check_in
  belongs_to :giver, class_name: 'User'  # é¢†è¯»äºº
  belongs_to :recipient, class_name: 'User'  # æ‰“å¡äºº
  belongs_to :reading_schedule

  validates :giver_id, :recipient_id, :check_in_id, presence: true
  validates :check_in_id, uniqueness: true  # ä¸€ä¸ªæ‰“å¡åªèƒ½è·å¾—ä¸€æœµå°çº¢èŠ±

  # é¢†è¯»äººå½“å¤©æœ€å¤šå‘3æœµ
  validate :daily_flower_limit

  private

  def daily_flower_limit
    daily_count = Flower.where(
      giver: giver,
      reading_schedule: reading_schedule
    ).count

    if daily_count >= 3 && !persisted?
      errors.add(:base, 'æ¯æ—¥æœ€å¤šå‘æ”¾3æœµå°çº¢èŠ±')
    end
  end
end
```

#### API ç«¯ç‚¹
```
# å°çº¢èŠ±
POST   /api/check_ins/:id/flower        ç»™æŸæ‰“å¡æˆäºˆå°çº¢èŠ±ï¼ˆé¢†è¯»äººï¼‰
DELETE /api/flowers/:id                 æ’¤é”€å°çº¢èŠ±
GET    /api/events/:id/flower_ranking   æ´»åŠ¨å°çº¢èŠ±æ’è¡Œæ¦œ
```

---

### æ¨¡å— 6ï¼šæ´»åŠ¨ç»Ÿè®¡ä¸ç»“ç®—

#### Service Object ç¤ºä¾‹
```ruby
# app/services/event_summary_service.rb
class EventSummaryService
  def initialize(reading_event)
    @event = reading_event
  end

  def generate_summary
    {
      event_id: @event.id,
      total_participants: @event.enrollments.count,
      completion_stats: completion_statistics,
      flower_ranking: flower_ranking,
      refund_calculations: calculate_refunds,
      top_winners: top_three_winners
    }
  end

  private

  def completion_statistics
    @event.enrollments.map do |enrollment|
      {
        user_id: enrollment.user_id,
        nickname: enrollment.user.nickname,
        completion_rate: enrollment.completion_rate,
        total_check_ins: enrollment.check_ins.count,
        flowers_count: enrollment.user.flowers_received
                                 .joins(check_in: :reading_schedule)
                                 .where(reading_schedules: { reading_event_id: @event.id })
                                 .count
      }
    end
  end

  def flower_ranking
    # è¿”å›å°çº¢èŠ±æ’å
    # ...
  end

  def calculate_refunds
    @event.enrollments.map do |enrollment|
      {
        user_id: enrollment.user_id,
        refund_amount: enrollment.refund_amount
      }
    end
  end

  def top_three_winners
    # è¿”å›å‰3åå°çº¢èŠ±è·å¾—è€…
    # ...
  end
end
```

#### API ç«¯ç‚¹
```
GET    /api/events/:id/summary          è·å–æ´»åŠ¨ç»Ÿè®¡
POST   /api/events/:id/finalize         æ´»åŠ¨ç»“ç®—ï¼ˆå°ç»„é•¿ï¼‰
```

---

## å››ã€å¾®ä¿¡å°ç¨‹åºå‰ç«¯è®¾è®¡

### é¡µé¢ç»“æ„
```
pages/
â”œâ”€â”€ index/              # é¦–é¡µï¼ˆæ´»åŠ¨åˆ—è¡¨ï¼‰
â”‚   â”œâ”€â”€ index.wxml
â”‚   â”œâ”€â”€ index.wxss
â”‚   â””â”€â”€ index.js
â”œâ”€â”€ event-detail/       # æ´»åŠ¨è¯¦æƒ…
â”œâ”€â”€ check-in/           # æ‰“å¡é¡µé¢
â”œâ”€â”€ leading/            # é¢†è¯»å‘å¸ƒé¡µé¢
â”œâ”€â”€ check-in-list/      # æ‰“å¡åˆ—è¡¨ï¼ˆçœ‹ä»–äººæ‰“å¡ï¼‰
â”œâ”€â”€ ranking/            # å°çº¢èŠ±æ’è¡Œæ¦œ
â”œâ”€â”€ my-events/          # æˆ‘çš„æ´»åŠ¨
â”œâ”€â”€ create-event/       # åˆ›å»ºæ´»åŠ¨ï¼ˆå°ç»„é•¿ï¼‰
â””â”€â”€ profile/            # ä¸ªäººä¸­å¿ƒ
```

### å…³é”®ç»„ä»¶
```javascript
// utils/request.js - å°è£… API è¯·æ±‚
const BASE_URL = 'https://your-api.com/api'

function request(url, method = 'GET', data = {}) {
  const token = wx.getStorageSync('jwt_token')

  return new Promise((resolve, reject) => {
    wx.request({
      url: BASE_URL + url,
      method,
      data,
      header: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      success: (res) => {
        if (res.statusCode === 200) {
          resolve(res.data)
        } else {
          reject(res)
        }
      },
      fail: reject
    })
  })
}

module.exports = { request }
```

### å¾®ä¿¡ç™»å½•å®ç°
```javascript
// pages/index/index.js
const { request } = require('../../utils/request')

Page({
  onLoad() {
    this.checkLogin()
  },

  async checkLogin() {
    const token = wx.getStorageSync('jwt_token')
    if (!token) {
      await this.doLogin()
    }
  },

  async doLogin() {
    try {
      // 1. è·å–å¾®ä¿¡ code
      const { code } = await wx.login()

      // 2. å‘é€åˆ°åç«¯æ¢å– JWT token
      const res = await request('/auth/login', 'POST', { code })

      // 3. ä¿å­˜ token
      wx.setStorageSync('jwt_token', res.token)
      wx.setStorageSync('user_info', res.user)

      console.log('ç™»å½•æˆåŠŸ')
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥', error)
    }
  }
})
```

---

## äº”ã€æ•°æ®åº“ Schema è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„
```ruby
# db/schema.rb (é¢„è§ˆ)

create_table "users", force: :cascade do |t|
  t.string "wx_openid", null: false
  t.string "wx_unionid"
  t.string "nickname", null: false
  t.string "avatar_url"
  t.string "phone"
  t.timestamps
  t.index ["wx_openid"], unique: true
  t.index ["wx_unionid"], unique: true
end

create_table "reading_events", force: :cascade do |t|
  t.bigint "leader_id", null: false  # å°ç»„é•¿
  t.string "title", null: false
  t.string "book_name", null: false
  t.string "book_cover_url"
  t.text "description"
  t.date "start_date", null: false
  t.date "end_date", null: false
  t.integer "max_participants", default: 30
  t.decimal "enrollment_fee", precision: 8, scale: 2, default: 100.0
  t.integer "status", default: 0  # draft/enrolling/in_progress/completed
  t.timestamps
  t.index ["leader_id"]
  t.index ["status"]
end

create_table "enrollments", force: :cascade do |t|
  t.bigint "user_id", null: false
  t.bigint "reading_event_id", null: false
  t.integer "payment_status", default: 0  # unpaid/paid/refunded
  t.integer "role", default: 0  # participant/leader
  t.integer "leading_count", default: 0
  t.decimal "paid_amount", precision: 8, scale: 2
  t.decimal "refund_amount", precision: 8, scale: 2
  t.timestamps
  t.index ["user_id", "reading_event_id"], unique: true
end

create_table "reading_schedules", force: :cascade do |t|
  t.bigint "reading_event_id", null: false
  t.integer "day_number", null: false
  t.date "date", null: false
  t.string "reading_progress", null: false  # ä¾‹å¦‚ï¼š"ç¬¬1-3ç« " æˆ– "ç¬¬10-30é¡µ"
  t.bigint "daily_leader_id"  # é¢†è¯»äººï¼ˆå¯ä¸ºç©ºï¼‰
  t.timestamps
  t.index ["reading_event_id", "day_number"], unique: true
  t.index ["date"]
end

create_table "daily_leadings", force: :cascade do |t|
  t.bigint "reading_schedule_id", null: false
  t.bigint "leader_id", null: false
  t.text "reading_suggestion"
  t.json "questions"  # å­˜å‚¨ 2-3 ä¸ªé—®é¢˜çš„æ•°ç»„
  t.timestamps
  t.index ["reading_schedule_id"], unique: true
end

create_table "check_ins", force: :cascade do |t|
  t.bigint "user_id", null: false
  t.bigint "reading_schedule_id", null: false
  t.bigint "enrollment_id", null: false
  t.text "content", null: false
  t.integer "word_count", default: 0
  t.integer "status", default: 0  # normal/makeup/missed
  t.datetime "submitted_at"
  t.timestamps
  t.index ["user_id", "reading_schedule_id"], unique: true
  t.index ["enrollment_id"]
end

create_table "flowers", force: :cascade do |t|
  t.bigint "check_in_id", null: false
  t.bigint "giver_id", null: false  # é¢†è¯»äºº
  t.bigint "recipient_id", null: false  # æ‰“å¡äºº
  t.bigint "reading_schedule_id", null: false
  t.text "comment"  # é¢†è¯»äººè¯„è¯­ï¼ˆå¯é€‰ï¼‰
  t.timestamps
  t.index ["check_in_id"], unique: true
  t.index ["recipient_id"]
  t.index ["reading_schedule_id", "giver_id"]
end
```

---

## å…­ã€å®‰å…¨æ€§è€ƒè™‘

### 1. API è®¤è¯
- æ‰€æœ‰ API è¯·æ±‚å¿…é¡»æºå¸¦æœ‰æ•ˆçš„ JWT token
- Token è¿‡æœŸæ—¶é—´ï¼š30 å¤©
- åˆ·æ–°æœºåˆ¶ï¼šè¿‡æœŸå‰ 3 å¤©è‡ªåŠ¨åˆ·æ–°

### 2. æƒé™æ§åˆ¶
```ruby
# app/controllers/concerns/authorization.rb
module Authorization
  extend ActiveSupport::Concern

  def authorize_event_leader!(event)
    unless current_user == event.leader
      render json: { error: 'Unauthorized' }, status: :forbidden
    end
  end

  def authorize_daily_leader!(schedule)
    unless current_user == schedule.daily_leader
      render json: { error: 'Unauthorized' }, status: :forbidden
    end
  end
end
```

### 3. æ•°æ®éªŒè¯
- æ‰“å¡å†…å®¹æœ€å°‘ 100 å­—
- æ¯æ—¥å°çº¢èŠ±æœ€å¤š 3 æœµ
- é¢†è¯»æ¬¡æ•°é™åˆ¶

### 4. å¾®ä¿¡ AppSecret ä¿æŠ¤
```yaml
# config/credentials.yml.enc (åŠ å¯†å­˜å‚¨)
wechat:
  app_id: wxxxxxxxxxxx
  app_secret: xxxxxxxxxxxxxxxx

jwt_secret_key: xxxxxxxxxxxxxx
```

---

## ä¸ƒã€éƒ¨ç½²æ¶æ„

### å¼€å‘ç¯å¢ƒ
```
æœ¬åœ°å¼€å‘:
- Rails è¿è¡Œåœ¨ localhost:3000
- å°ç¨‹åºå¼€å‘è€…å·¥å…·è¿æ¥æœ¬åœ° API
- SQLite æ•°æ®åº“
```

### ç”Ÿäº§ç¯å¢ƒ
```
äº‘æœåŠ¡å™¨ (æ¨èè…¾è®¯äº‘):
- Rails åº”ç”¨ (Kamal éƒ¨ç½²)
- PostgreSQL æ•°æ®åº“
- Nginx (ç”± Kamal è‡ªåŠ¨é…ç½®)
- SSL è¯ä¹¦ (Let's Encrypt)

åŸŸå:
- API: api.qqclub.com
- å°ç¨‹åºå¿…é¡»ä½¿ç”¨ HTTPS
```

---

## å…«ã€å¼€å‘è·¯çº¿å›¾ï¼ˆ10 å‘¨è®¡åˆ’ï¼‰

### Week 1-2: Rails API åŸºç¡€
- [ ] åˆ›å»º Rails API é¡¹ç›®
- [ ] è®¾ç½®å¾®ä¿¡ç™»å½•å’Œ JWT è®¤è¯
- [ ] å®ç° User æ¨¡å‹å’Œ API
- [ ] æµ‹è¯•è®¤è¯æµç¨‹ï¼ˆPostmanï¼‰

### Week 3-4: æ ¸å¿ƒä¸šåŠ¡æ¨¡å‹
- [ ] ReadingEvent + Enrollment æ¨¡å‹å’Œ API
- [ ] ReadingSchedule + DailyLeading æ¨¡å‹å’Œ API
- [ ] CheckIn æ¨¡å‹å’Œ API
- [ ] Flower æ¨¡å‹å’Œ API

### Week 5-6: ä¸šåŠ¡é€»è¾‘ä¸ç»Ÿè®¡
- [ ] Service Objectsï¼ˆåˆ›å»ºæ´»åŠ¨ã€æ‰“å¡éªŒè¯ã€ç»“ç®—ç­‰ï¼‰
- [ ] ç»Ÿè®¡åŠŸèƒ½ï¼ˆå®Œæˆç‡ã€æ’è¡Œæ¦œï¼‰
- [ ] åå°ä»»åŠ¡ï¼ˆSolid Queueï¼‰

### Week 7-8: å¾®ä¿¡å°ç¨‹åºå‰ç«¯
- [ ] å°ç¨‹åºé¡¹ç›®åˆå§‹åŒ–
- [ ] å¾®ä¿¡ç™»å½•é›†æˆ
- [ ] æ ¸å¿ƒé¡µé¢å¼€å‘ï¼ˆæ´»åŠ¨åˆ—è¡¨ã€è¯¦æƒ…ã€æ‰“å¡ï¼‰
- [ ] é¢†è¯»å’Œå°çº¢èŠ±åŠŸèƒ½

### Week 9: æ”¯ä»˜ä¸é€šçŸ¥
- [ ] å¾®ä¿¡æ”¯ä»˜é›†æˆ
- [ ] æ¨¡æ¿æ¶ˆæ¯é€šçŸ¥
- [ ] åˆ†äº«å¡ç‰‡

### Week 10: æµ‹è¯•ä¸éƒ¨ç½²
- [ ] å®Œæ•´æµç¨‹æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] Kamal éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- [ ] å°ç¨‹åºæå®¡ä¸Šçº¿

---

## ä¹ã€å…³é”®å†³ç­–ç‚¹æ€»ç»“

| å†³ç­–ç‚¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| **æ¶æ„** | å‰åç«¯åˆ†ç¦» | çµæ´»ã€ç°ä»£ã€ç”¨æˆ·ä½“éªŒå¥½ |
| **åç«¯** | Rails 8 API æ¨¡å¼ | æˆç†Ÿã€é«˜æ•ˆã€å¿«é€Ÿå¼€å‘ |
| **å‰ç«¯** | å¾®ä¿¡å°ç¨‹åºåŸç”Ÿ | å¾®ä¿¡ç”Ÿæ€æœ€ä½³å®è·µ |
| **è®¤è¯** | JWT + å¾®ä¿¡ OpenID | é€‚åˆç§»åŠ¨ç«¯æ— çŠ¶æ€è®¤è¯ |
| **æ•°æ®åº“** | PostgreSQL (ç”Ÿäº§) | ç¨³å®šã€åŠŸèƒ½å¼ºå¤§ |
| **éƒ¨ç½²** | Kamal 2 | Rails 8 æ¨èï¼Œç®€å•é«˜æ•ˆ |

---

## åã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

ç°åœ¨æˆ‘ä»¬éœ€è¦å†³å®šï¼š

1. **ä½ æƒ³ä»å“ªé‡Œå¼€å§‹ï¼Ÿ**
   - Option A: å…ˆæ„å»º Rails API åç«¯ï¼ˆæ¨èï¼‰
   - Option B: å…ˆå¿«é€Ÿæ­å»º Rails å…¨æ ˆåŸå‹ï¼Œå†æ”¹é€ æˆ API

2. **ä½ çš„å°ç¨‹åºå¼€å‘ç»éªŒå¦‚ä½•ï¼Ÿ**
   - å¦‚æœé›¶åŸºç¡€ï¼Œæˆ‘å»ºè®®å…ˆä¸“æ³¨ Railsï¼Œåç»­æˆ‘å†æ‰‹æŠŠæ‰‹æ•™ä½ å°ç¨‹åº
   - å¦‚æœæœ‰åŸºç¡€ï¼Œæˆ‘ä»¬å¯ä»¥å¹¶è¡Œå¼€å‘

3. **æ—¶é—´æŠ•å…¥ï¼Ÿ**
   - å…¨èŒå­¦ä¹ ï¼Ÿè¿˜æ˜¯ä¸šä½™æ—¶é—´ï¼Ÿ
   - è¿™ä¼šå½±å“æˆ‘ä»¬çš„èŠ‚å¥è§„åˆ’

**å‘Šè¯‰æˆ‘ä½ çš„æƒ³æ³•ï¼Œæˆ‘ä»¬å¼€å§‹åŠ¨æ‰‹ï¼** ğŸš€
